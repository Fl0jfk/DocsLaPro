{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 133, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/api/reservation-rooms/reservations/create/route.ts"],"sourcesContent":["import { NextResponse, NextRequest } from \"next/server\";\r\nimport { S3Client, GetObjectCommand, PutObjectCommand } from \"@aws-sdk/client-s3\";\r\nimport { getSignedUrl } from \"@aws-sdk/s3-request-presigner\";\r\nimport { getAuth, clerkClient } from \"@clerk/nextjs/server\";\r\n\r\nconst s3 = new S3Client({\r\n  region: process.env.REGION,\r\n  credentials: {\r\n    accessKeyId: process.env.ACCESS_KEY_ID!,\r\n    secretAccessKey: process.env.SECRET_ACCESS_KEY!,\r\n  },\r\n});\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const { userId } = getAuth(req);\r\n    if (!userId)\r\n      return NextResponse.json({ error: \"Non authentifié\" }, { status: 401 });\r\n    const clerk = await clerkClient();\r\n    const user = await clerk.users.getUser(userId);\r\n    const { roomId, startsAt, endsAt, purpose, firstName, lastName } = await req.json();\r\n    if (!roomId || !startsAt || !endsAt)\r\n      return NextResponse.json({ error: \"Paramètres manquants\" }, { status: 400 });\r\n    const start = new Date(startsAt);\r\n    const end = new Date(endsAt);\r\n    if (start >= end)\r\n      return NextResponse.json({ error: \"Plage horaire invalide\" }, { status: 400 });\r\n    const getCmd = new GetObjectCommand({\r\n      Bucket: process.env.BUCKET_NAME!,\r\n      Key: \"reservation-rooms/reservations.json\",\r\n    });\r\n    const getUrl = await getSignedUrl(s3, getCmd, { expiresIn: 60 });\r\n    const res = await fetch(getUrl);\r\n    let existing: any[] = [];\r\n    if (res.ok) {\r\n      const text = await res.text();\r\n      existing = text ? JSON.parse(text) : [];\r\n    }\r\n    const conflict = existing.find(\r\n      (r) =>\r\n        r.roomId === roomId &&\r\n        r.status !== \"CANCELLED\" &&\r\n        new Date(r.startsAt) < end &&\r\n        new Date(r.endsAt) > start\r\n    );\r\n    if (conflict)\r\n      return NextResponse.json({ error: \"Ce créneau est déjà réservé\" }, { status: 409 });\r\n    const newReservation = {\r\n      id: Date.now().toString(),\r\n      roomId,\r\n      userId,\r\n      firstName: firstName || user.firstName || \"\",\r\n      lastName: lastName || user.lastName || \"\",\r\n      startsAt,\r\n      endsAt,\r\n      purpose: purpose || \"\",\r\n      createdAt: new Date().toISOString(),\r\n      status: \"CONFIRMED\",\r\n    };\r\n    existing.push(newReservation);\r\n    const putCmd = new PutObjectCommand({\r\n      Bucket: process.env.BUCKET_NAME!,\r\n      Key: \"reservation-rooms/reservations.json\",\r\n      ContentType: \"application/json\",\r\n    });\r\n    const putUrl = await getSignedUrl(s3, putCmd, { expiresIn: 60 });\r\n    const putRes = await fetch(putUrl, {\r\n      method: \"PUT\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify(existing, null, 2),\r\n    });\r\n    if (!putRes.ok) throw new Error(\"Impossible de sauvegarder la réservation sur S3\");\r\n    return NextResponse.json({ reservation: newReservation }, { status: 201 });\r\n  } catch (err: any) {\r\n    console.error(\"Erreur POST réservation :\", err);\r\n    return NextResponse.json(\r\n      { error: err.message || \"Erreur serveur\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AAAA;AACA;AAAA;;;;;AAEA,MAAM,KAAK,IAAI,6JAAQ,CAAC;IACtB,QAAQ,QAAQ,GAAG,CAAC,MAAM;IAC1B,aAAa;QACX,aAAa,QAAQ,GAAG,CAAC,aAAa;QACtC,iBAAiB,QAAQ,GAAG,CAAC,iBAAiB;IAChD;AACF;AAEO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,EAAE,MAAM,EAAE,GAAG,IAAA,wLAAO,EAAC;QAC3B,IAAI,CAAC,QACH,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAkB,GAAG;YAAE,QAAQ;QAAI;QACvE,MAAM,QAAQ,MAAM,IAAA,0LAAW;QAC/B,MAAM,OAAO,MAAM,MAAM,KAAK,CAAC,OAAO,CAAC;QACvC,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,EAAE,GAAG,MAAM,IAAI,IAAI;QACjF,IAAI,CAAC,UAAU,CAAC,YAAY,CAAC,QAC3B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAuB,GAAG;YAAE,QAAQ;QAAI;QAC5E,MAAM,QAAQ,IAAI,KAAK;QACvB,MAAM,MAAM,IAAI,KAAK;QACrB,IAAI,SAAS,KACX,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAyB,GAAG;YAAE,QAAQ;QAAI;QAC9E,MAAM,SAAS,IAAI,qKAAgB,CAAC;YAClC,QAAQ,QAAQ,GAAG,CAAC,WAAW;YAC/B,KAAK;QACP;QACA,MAAM,SAAS,MAAM,IAAA,0MAAY,EAAC,IAAI,QAAQ;YAAE,WAAW;QAAG;QAC9D,MAAM,MAAM,MAAM,MAAM;QACxB,IAAI,WAAkB,EAAE;QACxB,IAAI,IAAI,EAAE,EAAE;YACV,MAAM,OAAO,MAAM,IAAI,IAAI;YAC3B,WAAW,OAAO,KAAK,KAAK,CAAC,QAAQ,EAAE;QACzC;QACA,MAAM,WAAW,SAAS,IAAI,CAC5B,CAAC,IACC,EAAE,MAAM,KAAK,UACb,EAAE,MAAM,KAAK,eACb,IAAI,KAAK,EAAE,QAAQ,IAAI,OACvB,IAAI,KAAK,EAAE,MAAM,IAAI;QAEzB,IAAI,UACF,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA8B,GAAG;YAAE,QAAQ;QAAI;QACnF,MAAM,iBAAiB;YACrB,IAAI,KAAK,GAAG,GAAG,QAAQ;YACvB;YACA;YACA,WAAW,aAAa,KAAK,SAAS,IAAI;YAC1C,UAAU,YAAY,KAAK,QAAQ,IAAI;YACvC;YACA;YACA,SAAS,WAAW;YACpB,WAAW,IAAI,OAAO,WAAW;YACjC,QAAQ;QACV;QACA,SAAS,IAAI,CAAC;QACd,MAAM,SAAS,IAAI,qKAAgB,CAAC;YAClC,QAAQ,QAAQ,GAAG,CAAC,WAAW;YAC/B,KAAK;YACL,aAAa;QACf;QACA,MAAM,SAAS,MAAM,IAAA,0MAAY,EAAC,IAAI,QAAQ;YAAE,WAAW;QAAG;QAC9D,MAAM,SAAS,MAAM,MAAM,QAAQ;YACjC,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;YAC9C,MAAM,KAAK,SAAS,CAAC,UAAU,MAAM;QACvC;QACA,IAAI,CAAC,OAAO,EAAE,EAAE,MAAM,IAAI,MAAM;QAChC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,aAAa;QAAe,GAAG;YAAE,QAAQ;QAAI;IAC1E,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,IAAI,OAAO,IAAI;QAAiB,GACzC;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}