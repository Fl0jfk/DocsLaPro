{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/travels/page.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useUser } from \"@clerk/nextjs\";\r\nimport { ModalEtape2, ModalEtape3, ModalEtape4, ModalEtape5, ModalEtape6 } from \"./modals\"; // modales séparées\r\nimport { Voyage, Etape3Form } from \"./types\"; // tes types\r\n\r\nexport default function VoyageManager() {\r\n  const { user, isLoaded } = useUser();\r\n  const [voyages, setVoyages] = useState<Voyage[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [files, setFiles] = useState<File[]>([]);\r\n  const [modalVoyage, setModalVoyage] = useState<Voyage | null>(null);\r\n  const [modalForm, setModalForm] = useState<Etape3Form>({ besoin_restauration: false, besoin_transport: false});\r\n  const userEmail = user?.emailAddresses?.[0]?.emailAddress || \"\";\r\n  const userRole = String(user?.publicMetadata?.role as\r\n    | \"direction_ecole\"\r\n    | \"direction_college\"\r\n    | \"direction_lycee\"\r\n    | \"prof\"\r\n    | \"compta\") || \"prof\";\r\n\r\n  useEffect(() => {\r\n    const fetchVoyages = async () => {\r\n      try {\r\n        const res = await fetch(\"/api/travels/view-all\");\r\n        const data = await res.json();\r\n        setVoyages(Array.isArray(data) ? data : []);\r\n      } catch (err) {\r\n        console.error(\"Erreur récupération voyages :\", err);\r\n      }\r\n    };\r\n    if (isLoaded) fetchVoyages();\r\n  }, [isLoaded]);\r\n\r\n  const canValidate = (v: Voyage) => {\r\n    if (userRole.startsWith(\"direction\") && v.direction_cible === userRole) {\r\n      return [\"etape_2_en_attente\", \"etape_4_en_attente\", \"etape_6_finale\"].includes(v.etat);\r\n    }\r\n    if (userRole === \"compta\") return v.etat === \"etape_5_en_attente\";\r\n    return false;\r\n  };\r\n\r\n  const isProfCreateur = (v: Voyage) => v.email === userEmail;\r\n\r\n  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n    const form = e.currentTarget as HTMLFormElement;\r\n    const formData = new FormData(form);\r\n    const pieces_jointes: any[] = [];\r\n\r\n    for (const file of files) {\r\n      const res = await fetch(`/api/travels/upload-url?filename=${encodeURIComponent(file.name)}`);\r\n      const { url, key } = await res.json();\r\n      await fetch(url, { method: \"PUT\", body: file });\r\n      pieces_jointes.push({ filename: file.name, s3Key: key, type: file.type });\r\n    }\r\n\r\n    const dir = formData.get(\"direction_cible\");\r\n    let direction_cible: \"direction_ecole\" | \"direction_college\" | \"direction_lycee\" | undefined;\r\n    if (dir === \"direction_ecole\" || dir === \"direction_college\" || dir === \"direction_lycee\") {\r\n      direction_cible = dir;\r\n    }\r\n\r\n    const payload: Partial<Voyage> = {\r\n      prenom: user?.firstName || \"\",\r\n      nom: user?.lastName || \"\",\r\n      email: userEmail,\r\n      direction_cible,\r\n      type_activite: (formData.get(\"type_activite\") as \"voyage\" | \"sortie\" | \"autre\") || \"autre\",\r\n      destination: (formData.get(\"destination\") as string) || \"\",\r\n      objectifs: (formData.get(\"objectifs\") as string) || \"\",\r\n      date_depart: (formData.get(\"date_depart\") as string) || \"\",\r\n      date_retour: (formData.get(\"date_retour\") as string) || \"\",\r\n      effectif_eleves: Number(formData.get(\"effectif_eleves\")),\r\n      effectif_accompagnateurs: Number(formData.get(\"effectif_accompagnateurs\")),\r\n      pieces_jointes,\r\n      etat: \"etape_1\",\r\n      date_creation: new Date().toISOString(),\r\n    };\r\n\r\n    try {\r\n      await fetch(\"/api/travels/create\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      form.reset();\r\n      setFiles([]);\r\n      const res = await fetch(\"/api/travels/view-all\");\r\n      const data = await res.json();\r\n      setVoyages(Array.isArray(data) ? data : []);\r\n    } catch (err) {\r\n      console.error(\"Erreur création voyage :\", err);\r\n    }\r\n    setLoading(false);\r\n  };\r\n\r\n  const handleEtape3Submit = async (v: Voyage) => {\r\n    if (!modalVoyage) return;\r\n    try {\r\n      await fetch(\"/api/travels/etape3\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ id: v.id, etape3: modalForm }),\r\n      });\r\n      setModalVoyage(null);\r\n      const res = await fetch(\"/api/travels/view-all\");\r\n      const data = await res.json();\r\n      setVoyages(Array.isArray(data) ? data : []);\r\n    } catch (err) {\r\n      console.error(\"Erreur étape 3 :\", err);\r\n    }\r\n  };\r\n\r\n  const handleValidation = async (v: Voyage, valide: boolean) => {\r\n    try {\r\n      await fetch(\"/api/travels/validate\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ id: v.id, valide }),\r\n      });\r\n      const res = await fetch(\"/api/travels/view-all\");\r\n      const data = await res.json();\r\n      setVoyages(Array.isArray(data) ? data : []);\r\n    } catch (err) {\r\n      console.error(\"Erreur validation :\", err);\r\n    }\r\n  };\r\n\r\n  if (!isLoaded) return <div>Chargement…</div>;\r\n  if (!user) return <div>Vous devez être connecté(e).</div>;\r\n\r\n  return (\r\n    <div className=\"max-w-5xl mx-auto p-4 flex flex-col gap-6\">\r\n      {/* Formulaire étape 1 */}\r\n      <form onSubmit={handleSubmit} className=\"flex flex-col gap-2 p-4 border rounded\">\r\n        <h2 className=\"text-lg font-semibold\">Créer un nouveau voyage</h2>\r\n        <select name=\"direction_cible\" required>\r\n          <option value=\"\">Choisir la direction</option>\r\n          <option value=\"direction_ecole\">École</option>\r\n          <option value=\"direction_college\">Collège</option>\r\n          <option value=\"direction_lycee\">Lycée</option>\r\n        </select>\r\n        <select name=\"type_activite\" required>\r\n          <option value=\"\">Type d'activité</option>\r\n          <option value=\"voyage\">Voyage</option>\r\n          <option value=\"sortie\">Sortie</option>\r\n          <option value=\"autre\">Autre</option>\r\n        </select>\r\n        <input name=\"destination\" placeholder=\"Destination\" required />\r\n        <input name=\"objectifs\" placeholder=\"Objectifs pédagogiques\" required />\r\n        <input type=\"date\" name=\"date_depart\" required />\r\n        <input type=\"date\" name=\"date_retour\" required />\r\n        <input type=\"number\" name=\"effectif_eleves\" placeholder=\"Nombre d'élèves\" required />\r\n        <input type=\"number\" name=\"effectif_accompagnateurs\" placeholder=\"Nombre d'accompagnateurs\" required />\r\n        <input type=\"file\" multiple onChange={e => setFiles(Array.from(e.target.files || []))} />\r\n        <button type=\"submit\" disabled={loading}>\r\n          {loading ? \"Envoi...\" : \"Créer le voyage\"}\r\n        </button>\r\n      </form>\r\n\r\n      {/* Liste des voyages */}\r\n      <h2 className=\"text-lg font-semibold\">Voyages existants</h2>\r\n      <div className=\"flex flex-col gap-4\">\r\n        {voyages.map(v => (\r\n          <div key={v.id} className=\"p-4 border rounded shadow-sm\">\r\n            <div className=\"flex justify-between items-center mb-2\">\r\n              <div>\r\n                <b>{v.destination}</b> ({v.type_activite})<br />\r\n                <small>{v.date_depart} → {v.date_retour}</small>\r\n              </div>\r\n              <span className=\"text-sm italic\">{v.etat}</span>\r\n            </div>\r\n            <div>Par {v.prenom} {v.nom} — {v.direction_cible}</div>\r\n\r\n            {/* Prof étape 3 */}\r\n            {isProfCreateur(v) && v.etat === \"etape_3\" && (\r\n              <button\r\n                className=\"mt-2 px-2 py-1 bg-green-500 text-white rounded\"\r\n                onClick={() => {\r\n                  setModalVoyage(v);\r\n                  setModalForm(v.etape3 || { besoin_restauration: false, besoin_transport: false });\r\n                }}\r\n              >\r\n                Compléter l'étape 3\r\n              </button>\r\n            )}\r\n\r\n            {/* Validation étapes */}\r\n            {canValidate(v) && (\r\n              <div className=\"flex gap-2 mt-2\">\r\n                <button\r\n                  className=\"px-2 py-1 bg-blue-500 text-white rounded\"\r\n                  onClick={() => handleValidation(v, true)}\r\n                >\r\n                  Valider\r\n                </button>\r\n                <button\r\n                  className=\"px-2 py-1 bg-red-500 text-white rounded\"\r\n                  onClick={() => handleValidation(v, false)}\r\n                >\r\n                  Refuser\r\n                </button>\r\n              </div>\r\n            )}\r\n\r\n            {/* Pièces jointes */}\r\n            {v.pieces_jointes?.length ? (\r\n              <div className=\"mt-2\">\r\n                <b>Pièces jointes :</b>\r\n                <ul className=\"list-disc pl-5\">\r\n                  {v.pieces_jointes.map(p => (\r\n                    <li key={p.s3Key}>\r\n                      <a href={`/api/travels/download?key=${encodeURIComponent(p.s3Key)}`} target=\"_blank\" rel=\"noreferrer\">{p.filename}</a>\r\n                    </li>\r\n                  ))}\r\n                </ul>\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n        ))}\r\n        {!voyages.length && <div>Aucun voyage pour l'instant.</div>}\r\n      </div>\r\n\r\n      {/* Modal étape 3 */}\r\n      {modalVoyage && (\r\n        <ModalEtape3\r\n          voyage={modalVoyage}\r\n          modalForm={modalForm}\r\n          setModalForm={setModalForm}\r\n          onClose={() => setModalVoyage(null)}\r\n          onSubmit={() => handleEtape3Submit(modalVoyage)}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}