{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/prof-room/page.tsx"],"sourcesContent":["\"use client\";\r\nimport { useEffect, useState } from \"react\";\r\nimport { useUser } from \"@clerk/nextjs\";\r\n\r\nconst FRENCH_HOLIDAYS_2025 = [\"2025-01-01\",\"2025-04-21\",\"2025-05-01\",\"2025-05-08\",\"2025-05-29\",\"2025-06-09\",\"2025-07-14\",\"2025-08-15\",\"2025-11-01\",\"2025-11-11\",\"2025-12-25\"];\r\n\r\nfunction isWeekend(date: Date) {\r\n  const d = date.getDay();\r\n  return d === 0 || d === 6;\r\n}\r\n\r\nconst HOURS = Array.from({ length: 11 }, (_, i) => 8 + i);\r\n\r\nexport default function ProfRoomPage() {\r\n  const { user, isLoaded } = useUser();\r\n  const [rooms, setRooms] = useState<any[]>([]);\r\n  const [reservations, setReservations] = useState<any[]>([]);\r\n  const [selectedRoom, setSelectedRoom] = useState(\"\");\r\n  const [selectedDate, setSelectedDate] = useState(\"\");\r\n  const [selectedHour, setSelectedHour] = useState<number | null>(null);\r\n  const lastName = (user?.lastName ?? \"\").toUpperCase();\r\n  const ADMIN_LASTNAMES = [\"HACQUEVILLE-MATHI\", \"FORTINEAU\", \"MARTIN\"];\r\n  const firstName = user?.firstName ?? \"\";\r\n  useEffect(() => {\r\n    async function load() {\r\n      try {\r\n        const roomsRes = await fetch(\"/api/reservation-rooms/rooms\");\r\n        if (roomsRes.ok) {\r\n          const roomsData = await roomsRes.json();\r\n          setRooms(roomsData.rooms || []);\r\n        }\r\n        const resRes = await fetch(\"/api/reservation-rooms/reservations\");\r\n        if (resRes.ok) {\r\n          const resData = await resRes.json();\r\n          setReservations(resData.reservations || resData || []);\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Erreur au chargement des donn√©es :\", error);\r\n      }\r\n    }\r\n    load();\r\n  }, []);\r\n  if (!isLoaded) return <p className=\"p-8 text-center\">Chargement du profil...</p>;\r\n  if (!user) return <p className=\"p-8 text-center\">Veuillez vous connecter</p>;\r\n  function getReservation(hour: number) {\r\n    return reservations.find(\r\n      (r) =>\r\n        r.roomId === selectedRoom &&\r\n        r.startsAt.startsWith(selectedDate) &&\r\n        r.status !== \"CANCELLED\" &&\r\n        new Date(r.startsAt).getHours() === hour\r\n    );\r\n  }\r\n  async function handleConfirm() {\r\n    if (selectedHour === null || !selectedRoom || !selectedDate) return;\r\n    const start = new Date(`${selectedDate}T${selectedHour.toString().padStart(2, \"0\")}:00`);\r\n    if (isWeekend(start) || FRENCH_HOLIDAYS_2025.includes(selectedDate)) {\r\n      alert(\"‚õîÔ∏è Impossible de r√©server un week-end ou jour f√©ri√©.\");\r\n      return;\r\n    }\r\n    const end = new Date(start.getTime() + 60 * 60 * 1000);\r\n    const res = await fetch(\"/api/reservation-rooms/reservations/create\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({\r\n        roomId: selectedRoom,\r\n        startsAt: start.toISOString(),\r\n        endsAt: end.toISOString(),\r\n        firstName: firstName,\r\n        lastName: lastName,\r\n        email: user?.primaryEmailAddress?.emailAddress\r\n      }),\r\n    });\r\n    if (res.ok) {\r\n      alert(\"‚úÖ R√©servation confirm√©e !\");\r\n      const newRes = await res.json();\r\n      setReservations([...reservations, newRes.reservation]);\r\n      setSelectedHour(null);\r\n    } else {\r\n      const err = await res.json();\r\n      alert(\"Erreur : \" + (err.error || \"inconnue\"));\r\n    }\r\n  }\r\n  async function handleDeleteReservation(reservation: any) {\r\n    const reason = prompt(\r\n      `Motif de l'annulation pour ${reservation.firstName} ${reservation.lastName} :`, \r\n      \"Indisponibilit√© exceptionnelle de la salle\"\r\n    );\r\n    if (reason === null) return; \r\n    if (!confirm(\"Confirmer la suppression et l'envoi du mail d'alerte ?\")) return;\r\n    const res = await fetch(\"/api/reservation-rooms/reservations/delete\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({ \r\n        startsAt: reservation.startsAt,\r\n        reason: reason,\r\n        userEmail: reservation.email\r\n      }),\r\n    });\r\n    if (res.ok) {\r\n      alert(\"üóëÔ∏è R√©servation annul√©e et mail envoy√©.\");\r\n      setReservations(reservations.filter((r) => r.startsAt !== reservation.startsAt));\r\n    } else {\r\n      const err = await res.json();\r\n      alert(\"Erreur : \" + (err.error || \"inconnue\"));\r\n    }\r\n  }\r\n  async function downloadJSON() {\r\n    const res = await fetch(\"/api/reservation-rooms/reservations\");\r\n    const data = await res.json();\r\n    const blob = new Blob([JSON.stringify(data, null, 2)], {type: \"application/json\",});\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement(\"a\");\r\n    a.href = url;\r\n    a.download = \"reservations.json\";\r\n    a.click();\r\n    URL.revokeObjectURL(url);\r\n  }\r\n  return (\r\n    <div className=\"p-8 max-w-xl mx-auto\">\r\n      <h1 className=\"text-2xl font-bold mb-6 text-gray-800\">R√©server une salle</h1>\r\n      {ADMIN_LASTNAMES.includes(lastName) && (\r\n        <button onClick={downloadJSON} className=\"mb-6 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 w-full font-medium transition shadow\">\r\n          ‚¨áÔ∏è T√©l√©charger la base de donn√©es (JSON)\r\n        </button>\r\n      )}\r\n\r\n      <div className=\"space-y-4 bg-gray-50 p-4 rounded-lg border mb-6\">\r\n        <div>\r\n          <label className=\"block mb-1 font-semibold text-gray-700\">Salle</label>\r\n          <select value={selectedRoom} onChange={(e) => setSelectedRoom(e.target.value)} className=\"border rounded w-full p-2 text-black bg-white\">\r\n            <option value=\"\">-- Choisir une salle --</option>\r\n            {rooms.map((r) => (\r\n              <option key={r.id} value={r.id}>{r.name}</option>\r\n            ))}\r\n          </select>\r\n        </div>\r\n\r\n        <div>\r\n          <label className=\"block mb-1 font-semibold text-gray-700\">Date</label>\r\n          <input \r\n            type=\"date\" \r\n            value={selectedDate} \r\n            min={new Date().toISOString().split(\"T\")[0]} \r\n            onChange={(e) => setSelectedDate(e.target.value)} \r\n            className=\"border rounded w-full p-2 text-black bg-white\"\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      {selectedRoom && selectedDate && (\r\n        <div className=\"animate-in fade-in duration-300\">\r\n          <h2 className=\"font-bold mb-3 text-gray-700\">Cr√©neaux disponibles</h2>\r\n          <div className=\"grid grid-cols-2 gap-3 mb-6\">\r\n            {HOURS.map((hour) => {\r\n              const res = getReservation(hour);\r\n              const isBooked = !!res;\r\n              const isSelected = selectedHour === hour;\r\n              \r\n              return (\r\n                <div key={hour} className=\"flex flex-col border rounded-lg p-2 bg-white shadow-sm border-gray-200\">\r\n                  <button \r\n                    disabled={isBooked} \r\n                    onClick={() => setSelectedHour(hour)} \r\n                    className={`p-2 rounded text-sm font-bold text-white transition-all ${ isBooked ? \"bg-gray-300 cursor-not-allowed\" : isSelected ? \"bg-green-600 scale-105\" : \"bg-blue-600 hover:bg-blue-700\"}`}\r\n                  >\r\n                    {hour}:30 - {hour + 1}:30\r\n                  </button>\r\n                  \r\n                  {isBooked && (\r\n                    <div className=\"mt-2 text-center\">\r\n                      <p className=\"text-[10px] text-gray-500 font-medium truncate italic\">Occup√© : {res.firstName} {res.lastName}</p>\r\n                      {ADMIN_LASTNAMES.includes(lastName) && (\r\n                        <button \r\n                          onClick={() => handleDeleteReservation(res)} \r\n                          className=\"mt-1 w-full text-[9px] uppercase tracking-wider bg-red-50 text-red-600 border border-red-200 py-1 rounded-md hover:bg-red-600 hover:text-white transition\"\r\n                        >\r\n                          Annuler & Pr√©venir\r\n                        </button>\r\n                      )}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n\r\n          {selectedHour !== null && (\r\n            <button onClick={handleConfirm} className=\"w-full px-4 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition shadow-lg transform active:scale-95\">\r\n              Confirmer la r√©servation pour {selectedHour}:30\r\n            </button>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}