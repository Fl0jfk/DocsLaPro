{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 84, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/utils/voyageStore.ts"],"sourcesContent":["// app/utils/voyageStore.ts\r\nimport {\r\n  S3Client,\r\n  GetObjectCommand,\r\n  PutObjectCommand,\r\n  ListObjectsV2Command,\r\n} from \"@aws-sdk/client-s3\";\r\nimport { getSignedUrl } from \"@aws-sdk/s3-request-presigner\";\r\nimport { currentUser } from \"@clerk/nextjs/server\";\r\nimport { v4 as uuidv4 } from \"uuid\";\r\n\r\nexport const s3 = new S3Client({\r\n  region: \"eu-west-3\",\r\n  credentials: {\r\n    accessKeyId: process.env.ACCESS_KEY_ID!,\r\n    secretAccessKey: process.env.SECRET_ACCESS_KEY!,\r\n  },\r\n});\r\n\r\nexport const BUCKET = process.env.BUCKET_NAME!;\r\n\r\nexport type VoyagePieceJointe = {\r\n  filename: string;\r\n  url: string;\r\n  type: string;\r\n};\r\n\r\nexport type VoyageEntry = {\r\n  id: string;\r\n  prenom: string;\r\n  nom: string;\r\n  email: string;\r\n  direction_cible: string;\r\n  date_depart: string;\r\n  date_retour: string;\r\n  lieu: string;\r\n  activite: string;\r\n  classes: string;\r\n  effectif_eleves: number;\r\n  effectif_accompagnateurs: number;\r\n  commentaire?: string;\r\n  programme?: VoyagePieceJointe | null;\r\n  pieces_jointes?: VoyagePieceJointe[];\r\n  etat: string;\r\n  date_declaration: string;\r\n};\r\n\r\nexport async function saveVoyage(userId: string, voyage: VoyageEntry) {\r\n  const key = `travels/${userId}/${voyage.id}/voyage.json`;\r\n  await s3.send(\r\n    new PutObjectCommand({\r\n      Bucket: BUCKET,\r\n      Key: key,\r\n      Body: JSON.stringify(voyage, null, 2),\r\n      ContentType: \"application/json\",\r\n    })\r\n  );\r\n  return key;\r\n}\r\n\r\nexport async function listVoyages(userId: string) {\r\n  const res = await s3.send(\r\n    new ListObjectsV2Command({\r\n      Bucket: BUCKET,\r\n      Prefix: `travels/${userId}/`,\r\n    })\r\n  );\r\n  return (res.Contents || []).filter((obj) => obj.Key?.endsWith(\"voyage.json\"));\r\n}\r\n\r\nexport async function getVoyage(userId: string, voyageId: string) {\r\n  const key = `travels/${userId}/${voyageId}/voyage.json`;\r\n  const obj = await s3.send(new GetObjectCommand({ Bucket: BUCKET, Key: key }));\r\n  const body = await obj.Body?.transformToString();\r\n  return JSON.parse(body!);\r\n}\r\n\r\nexport async function getPresignedUploadUrl(\r\n  voyageId: string,\r\n  filename: string,\r\n  type: string\r\n): Promise<{ uploadUrl: string; fileUrl: string; key: string }> {\r\n  const user = await currentUser();\r\n  if (!user) throw new Error(\"Utilisateur non authentifié\");\r\n\r\n  const key = `travels/${user.id}/${voyageId}/${filename}`;\r\n  const command = new PutObjectCommand({\r\n    Bucket: BUCKET,\r\n    Key: key,\r\n    ContentType: type,\r\n  });\r\n  const uploadUrl = await getSignedUrl(s3, command, { expiresIn: 3600 });\r\n  const fileUrl = `https://${BUCKET}.s3.eu-west-3.amazonaws.com/${key}`;\r\n  return { uploadUrl, fileUrl, key };\r\n}\r\n"],"names":[],"mappings":"AAAA,2BAA2B;;;;;;;;;;;;;;;AAC3B;AAMA;AAAA;AACA;;;;AAGO,MAAM,KAAK,IAAI,6JAAQ,CAAC;IAC7B,QAAQ;IACR,aAAa;QACX,aAAa,QAAQ,GAAG,CAAC,aAAa;QACtC,iBAAiB,QAAQ,GAAG,CAAC,iBAAiB;IAChD;AACF;AAEO,MAAM,SAAS,QAAQ,GAAG,CAAC,WAAW;AA4BtC,eAAe,WAAW,MAAc,EAAE,MAAmB;IAClE,MAAM,MAAM,CAAC,QAAQ,EAAE,OAAO,CAAC,EAAE,OAAO,EAAE,CAAC,YAAY,CAAC;IACxD,MAAM,GAAG,IAAI,CACX,IAAI,qKAAgB,CAAC;QACnB,QAAQ;QACR,KAAK;QACL,MAAM,KAAK,SAAS,CAAC,QAAQ,MAAM;QACnC,aAAa;IACf;IAEF,OAAO;AACT;AAEO,eAAe,YAAY,MAAc;IAC9C,MAAM,MAAM,MAAM,GAAG,IAAI,CACvB,IAAI,yKAAoB,CAAC;QACvB,QAAQ;QACR,QAAQ,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;IAC9B;IAEF,OAAO,CAAC,IAAI,QAAQ,IAAI,EAAE,EAAE,MAAM,CAAC,CAAC,MAAQ,IAAI,GAAG,EAAE,SAAS;AAChE;AAEO,eAAe,UAAU,MAAc,EAAE,QAAgB;IAC9D,MAAM,MAAM,CAAC,QAAQ,EAAE,OAAO,CAAC,EAAE,SAAS,YAAY,CAAC;IACvD,MAAM,MAAM,MAAM,GAAG,IAAI,CAAC,IAAI,qKAAgB,CAAC;QAAE,QAAQ;QAAQ,KAAK;IAAI;IAC1E,MAAM,OAAO,MAAM,IAAI,IAAI,EAAE;IAC7B,OAAO,KAAK,KAAK,CAAC;AACpB;AAEO,eAAe,sBACpB,QAAgB,EAChB,QAAgB,EAChB,IAAY;IAEZ,MAAM,OAAO,MAAM,IAAA,yMAAW;IAC9B,IAAI,CAAC,MAAM,MAAM,IAAI,MAAM;IAE3B,MAAM,MAAM,CAAC,QAAQ,EAAE,KAAK,EAAE,CAAC,CAAC,EAAE,SAAS,CAAC,EAAE,UAAU;IACxD,MAAM,UAAU,IAAI,qKAAgB,CAAC;QACnC,QAAQ;QACR,KAAK;QACL,aAAa;IACf;IACA,MAAM,YAAY,MAAM,IAAA,wMAAY,EAAC,IAAI,SAAS;QAAE,WAAW;IAAK;IACpE,MAAM,UAAU,CAAC,QAAQ,EAAE,OAAO,4BAA4B,EAAE,KAAK;IACrE,OAAO;QAAE;QAAW;QAAS;IAAI;AACnC","debugId":null}},
    {"offset": {"line": 163, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/travels/%5Bid%5D/edit/page.tsx"],"sourcesContent":["// app/travels/[id]/edit/page.tsx\r\nimport { s3, BUCKET, VoyageEntry } from \"@/app/utils/voyageStore\";\r\nimport { GetObjectCommand } from \"@aws-sdk/client-s3\";\r\nimport { currentUser } from \"@clerk/nextjs/server\";\r\n\r\ninterface PageProps {\r\n  params: { id: string };\r\n}\r\n\r\nfunction normalizeRoles(role: unknown): string[] {\r\n  if (Array.isArray(role)) return role as string[];\r\n  if (typeof role === \"string\") return [role];\r\n  return [];\r\n}\r\n\r\nexport default async function EditVoyagePage({ params }: PageProps) {\r\n  const voyageId = params.id;\r\n\r\n  // Récupérer l'utilisateur\r\n  const user = await currentUser();\r\n  if (!user) return <div>Vous devez être connecté(e).</div>;\r\n\r\n  const roles = normalizeRoles(user.publicMetadata?.role);\r\n\r\n  try {\r\n    // On liste tous les voyages pour trouver celui qui correspond à l'ID\r\n    const key = `travels/${user.id}/${voyageId}/voyage.json`;\r\n    const obj = await s3.send(new GetObjectCommand({ Bucket: BUCKET, Key: key }));\r\n    const body = await obj.Body?.transformToString();\r\n    if (!body) return <div>Voyage introuvable.</div>;\r\n\r\n    const voyage: VoyageEntry = JSON.parse(body);\r\n\r\n    // Vérifier si l'utilisateur a le droit d'éditer\r\n    const canEdit =\r\n      voyage.email === user.primaryEmailAddress?.emailAddress ||\r\n      roles.includes(\"compta\") ||\r\n      roles.includes(voyage.direction_cible);\r\n\r\n    if (!canEdit) return <div>Vous n'avez pas la permission de modifier ce voyage.</div>;\r\n\r\n    return (\r\n      <div className=\"pt-[15vh] max-w-2xl mx-auto px-4\">\r\n        <h1 className=\"text-2xl font-bold mb-6\">Modifier le voyage : {voyage.lieu}</h1>\r\n        <form\r\n          action={`/api/travels/update?voyageId=${voyageId}`}\r\n          method=\"POST\"\r\n          className=\"flex flex-col gap-4\"\r\n        >\r\n          <label>\r\n            Lieu / destination :\r\n            <input name=\"lieu\" defaultValue={voyage.lieu} required />\r\n          </label>\r\n\r\n          <label>\r\n            Activité / motif :\r\n            <input name=\"activite\" defaultValue={voyage.activite} required />\r\n          </label>\r\n\r\n          <label>\r\n            Date de départ :\r\n            <input type=\"date\" name=\"date_depart\" defaultValue={voyage.date_depart} required />\r\n          </label>\r\n\r\n          <label>\r\n            Date de retour :\r\n            <input type=\"date\" name=\"date_retour\" defaultValue={voyage.date_retour} required />\r\n          </label>\r\n\r\n          <label>\r\n            Classes concernées :\r\n            <input name=\"classes\" defaultValue={voyage.classes} required />\r\n          </label>\r\n\r\n          <label>\r\n            Nombre d’élèves :\r\n            <input\r\n              type=\"number\"\r\n              name=\"effectif_eleves\"\r\n              defaultValue={voyage.effectif_eleves}\r\n              min={1}\r\n              required\r\n            />\r\n          </label>\r\n\r\n          <label>\r\n            Nombre d’accompagnateurs :\r\n            <input\r\n              type=\"number\"\r\n              name=\"effectif_accompagnateurs\"\r\n              defaultValue={voyage.effectif_accompagnateurs}\r\n              min={1}\r\n              required\r\n            />\r\n          </label>\r\n\r\n          <label>\r\n            Commentaire :\r\n            <textarea name=\"commentaire\" defaultValue={voyage.commentaire || \"\"} />\r\n          </label>\r\n\r\n          <button\r\n            type=\"submit\"\r\n            className=\"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 mt-4\"\r\n          >\r\n            Enregistrer les modifications\r\n          </button>\r\n        </form>\r\n\r\n        <div className=\"mt-6\">\r\n          <h2 className=\"text-lg font-semibold mb-2\">Pièces jointes</h2>\r\n          <ul className=\"list-disc pl-4\">\r\n            {voyage.pieces_jointes?.map((f) => (\r\n              <li key={f.url}>\r\n                <a href={f.url} target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-blue-600 underline\">\r\n                  {f.filename}\r\n                </a>\r\n              </li>\r\n            ))}\r\n          </ul>\r\n        </div>\r\n      </div>\r\n    );\r\n  } catch (err) {\r\n    console.error(\"Erreur lors du fetch du voyage :\", err);\r\n    return <div>Erreur lors de la récupération du voyage.</div>;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}