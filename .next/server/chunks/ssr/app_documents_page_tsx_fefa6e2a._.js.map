{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/documents/page.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect } from \"react\";\r\n\r\ntype DocumentNode = {\r\n  type: \"folder\" | \"file\";\r\n  name: string;\r\n  path: string;\r\n  ext?: string;\r\n};\r\n\r\nexport default function DocumentsPage() {\r\n  const [currentPrefix, setCurrentPrefix] = useState(\"\");\r\n  const [items, setItems] = useState<DocumentNode[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [history, setHistory] = useState<string[]>([]);\r\n  const cacheKey = (prefix: string) => `documents_cache_${prefix}`;\r\n  const cacheTTL = 15 * 60 * 1000;\r\n  const [downloading, setDownloading] = useState<string | null>(null);\r\n  console.log(downloading);\r\n  useEffect(() => {\r\n    setLoading(true);\r\n    const cachedRaw = localStorage.getItem(cacheKey(currentPrefix));\r\n    if (cachedRaw) {\r\n      const cached = JSON.parse(cachedRaw);\r\n      const now = Date.now();\r\n      if (now - cached.timestamp < cacheTTL) {\r\n        setItems(cached.data);\r\n        setLoading(false);\r\n        return;\r\n      }\r\n    }\r\n    fetch(`/api/documents/list?prefix=${encodeURIComponent(currentPrefix)}`)\r\n      .then(res => res.json())\r\n      .then(data => {\r\n        if (data.error) {\r\n          setItems([]);\r\n        } else {\r\n          setItems(data);\r\n          localStorage.setItem(cacheKey(currentPrefix), JSON.stringify({\r\n            data,\r\n            timestamp: Date.now(),\r\n          }));\r\n        }\r\n        setLoading(false);\r\n      })\r\n      .catch(err => {\r\n        setLoading(false);\r\n      });\r\n  }, [currentPrefix, cacheTTL]);\r\n  const enterFolder = (path: string) => { setHistory(prev => [...prev, currentPrefix]); setCurrentPrefix(path);};\r\n  const goBack = () => {\r\n    const prev = history.pop();\r\n    if (prev !== undefined) {\r\n      setHistory([...history]);\r\n      setCurrentPrefix(prev);\r\n    }\r\n  };\r\n  const getFileIcon = (ext?: string) => {\r\n    if (!ext) return \"üìÑ\";\r\n    switch (ext.toLowerCase()) {\r\n      case \"pdf\": return \"üìÑ\";\r\n      case \"doc\": case \"docx\": return \"üìù\";\r\n      case \"xls\": case \"xlsx\": return \"üìä\";\r\n      default: return \"üìÑ\";\r\n    }\r\n  };\r\n  const handleDownload = async (path: string) => {\r\n  setDownloading(path);\r\n  try {\r\n    const res = await fetch(`/api/documents/get-url?key=${encodeURIComponent(path)}`);\r\n    const data = await res.json();\r\n    if (data.url) {\r\n      const a = document.createElement(\"a\");\r\n      a.href = data.url;\r\n      a.download = path.split(\"/\").pop()!;\r\n      document.body.appendChild(a);\r\n      a.click();\r\n      document.body.removeChild(a);\r\n    } else {\r\n      alert(\"Erreur lors de la g√©n√©ration du lien s√©curis√©.\");\r\n    }\r\n  } catch (e) {\r\n    alert(\"Erreur t√©l√©chargement : \" + String(e));\r\n  }\r\n  setDownloading(null);\r\n};\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center h-screen w-full\">\r\n        <div className=\"flex flex-col items-center\">\r\n          <div className=\"h-12 w-12 animate-spin rounded-full border-4 border-blue-500 border-t-transparent\"></div>\r\n          <p className=\"mt-4 text-lg font-medium text-gray-600\">Chargement en cours‚Ä¶</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n  return (\r\n    <main className=\"flex flex-col gap-4 p-4 w-full mx-auto max-w-[1000px] sm:pt-[10vh]\">\r\n      {history.length > 0 && (\r\n        <button onClick={goBack} className=\"flex items-center space-x-2 text-sm text-blue-500 hover:text-blue-700 transition-colors duration-200\">‚Üê Retour</button>\r\n      )}\r\n      {items.length > 0 ? (\r\n        <div className=\"grid grid-cols-6 sm:grid-cols-3 md:grid-cols-4 gap-6\">\r\n      {items.map((item, idx) => (\r\n        <div key={idx} onClick={() => item.type === \"folder\" ? enterFolder(item.path) : handleDownload(item.path)} className=\"cursor-pointer flex flex-col items-center max-h-[150px] max-w-[100px]\">\r\n          <div className=\"text-5xl mb-2\">{item.type === \"folder\" ? \"üìÅ\" : getFileIcon(item.ext)}</div>\r\n          <div className=\"text-center text-sm font-medium break-words overflow-hidden\">{item.name}.{item.ext}</div>\r\n        </div>\r\n      ))}\r\n    </div>\r\n    ) : (\r\n      <p className=\"text-gray-500 text-center\">Aucun document disponible pour ce dossier.</p>\r\n    )}\r\n  </main>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}