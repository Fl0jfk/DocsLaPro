{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 151, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/utils/voyageStore.ts"],"sourcesContent":["import { S3Client, GetObjectCommand, PutObjectCommand } from \"@aws-sdk/client-s3\";\r\n\r\nexport const s3 = new S3Client({\r\n  region: \"eu-west-3\",\r\n  credentials: {\r\n    accessKeyId: process.env.ACCESS_KEY_ID!,\r\n    secretAccessKey: process.env.SECRET_ACCESS_KEY!,\r\n  },\r\n});\r\nexport const BUCKET = process.env.BUCKET_NAME!;\r\n\r\nconst KEY = \"voyages_en_attente.json\";\r\n\r\nexport type VoyagePieceJointe = {\r\n  filename: string;\r\n  buffer: string;  \r\n  type: string;\r\n};\r\n\r\nexport type DevisTransporteur = {\r\n  filename: string;\r\n  buffer: string;\r\n  type: string;\r\n  date: string;\r\n  transporteur?: string;\r\n  message?: string;\r\n};\r\n\r\n  export type VoyageEntry = {\r\n  id: string;\r\n  prenom: string;\r\n  nom: string;\r\n  email: string;\r\n  direction_cible: string;\r\n  date_depart: string;\r\n  date_retour: string;\r\n  lieu: string;\r\n  activite: string;\r\n  classes: string;\r\n  effectif_eleves: number;\r\n  effectif_accompagnateurs: number;\r\n  commentaire?: string;\r\n  devis?: DevisTransporteur[];\r\n  pieces_jointes?: VoyagePieceJointe[];\r\n  etat: \"en_attente\" | \"etape_2_en_attente\" | \"etape_3_en_attente\" | \"validation_finale_en_attente\" | \"validee_definitive\" | \"validee\" | \"refusee\";\r\n  date_declaration: string;\r\n  programme?: {\r\n    filename: string;\r\n    buffer: string;\r\n    type: string;\r\n    } | null;\r\n  etape_2?: {\r\n    panier_repas: boolean;\r\n    details_panier_repas?: string;\r\n    nb_repas?: number;\r\n    nb_vegetariens?: number;\r\n    lieu_repas?: string;\r\n    devis_transporteur: boolean;\r\n    details_devis_transporteur?: string;\r\n    commentaire?: string;\r\n    date?: string;\r\n  };\r\n  etape_3?: {\r\n    circulaire_depart?: VoyagePieceJointe[];        \r\n    date_reunion_info?: string;          \r\n    date_envoi_circulaire_parents?: string;\r\n    participation_famille?: number;\r\n    cout_total_voyage?: number;\r\n    liste_eleves?: VoyagePieceJointe[];\r\n    liste_accompagnateurs?: VoyagePieceJointe[];\r\n    autres_pieces?: VoyagePieceJointe[];\r\n    commentaire?: string;\r\n    date?: string;\r\n  };\r\n};\r\n\r\nexport async function readVoyages(): Promise<VoyageEntry[]> {\r\n  try {\r\n    const obj = await s3.send(\r\n      new GetObjectCommand({\r\n        Bucket: BUCKET,\r\n        Key: KEY,\r\n      })\r\n    );\r\n    const body = await obj.Body?.transformToString();\r\n    if (!body || body.trim() === \"\") {\r\n      console.warn(\"‚ö†Ô∏è Fichier voyages_en_attente.json vide, renvoi d‚Äôun tableau vide.\");\r\n      return [];\r\n    }\r\n    try {\r\n      return JSON.parse(body);\r\n    } catch (err) {\r\n      console.error(\"‚ö†Ô∏è Erreur de parsing JSON sur le contenu S3 :\", err);\r\n      console.error(\"Contenu du fichier :\", body.slice(0, 200)); // aper√ßu\r\n      return [];\r\n    }\r\n  } catch (e: any) {\r\n    if (e.$metadata?.httpStatusCode === 404) {\r\n      console.warn(\"‚ö†Ô∏è Fichier voyages_en_attente.json introuvable, cr√©ation d‚Äôun nouveau.\");\r\n      return [];\r\n    }\r\n    throw e;\r\n  }\r\n}\r\n\r\nexport async function writeVoyages(entries: VoyageEntry[]) {\r\n  await s3.send(\r\n    new PutObjectCommand({ Bucket: BUCKET, Key: KEY, Body: JSON.stringify(entries ?? [], null, 2), ContentType: \"application/json\"})\r\n  );\r\n}\r\n\r\nexport async function addVoyage(entry: VoyageEntry) {\r\n  const entries = await readVoyages();\r\n  entries.push(entry);\r\n  await writeVoyages(entries);\r\n}\r\n\r\nexport async function removeVoyage(id: string) {\r\n  const entries = await readVoyages();\r\n  const out = entries.filter(e => e.id !== id);\r\n  await writeVoyages(out);\r\n}"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;AAEO,MAAM,KAAK,IAAI,6JAAQ,CAAC;IAC7B,QAAQ;IACR,aAAa;QACX,aAAa,QAAQ,GAAG,CAAC,aAAa;QACtC,iBAAiB,QAAQ,GAAG,CAAC,iBAAiB;IAChD;AACF;AACO,MAAM,SAAS,QAAQ,GAAG,CAAC,WAAW;AAE7C,MAAM,MAAM;AAiEL,eAAe;IACpB,IAAI;QACF,MAAM,MAAM,MAAM,GAAG,IAAI,CACvB,IAAI,qKAAgB,CAAC;YACnB,QAAQ;YACR,KAAK;QACP;QAEF,MAAM,OAAO,MAAM,IAAI,IAAI,EAAE;QAC7B,IAAI,CAAC,QAAQ,KAAK,IAAI,OAAO,IAAI;YAC/B,QAAQ,IAAI,CAAC;YACb,OAAO,EAAE;QACX;QACA,IAAI;YACF,OAAO,KAAK,KAAK,CAAC;QACpB,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,iDAAiD;YAC/D,QAAQ,KAAK,CAAC,wBAAwB,KAAK,KAAK,CAAC,GAAG,OAAO,SAAS;YACpE,OAAO,EAAE;QACX;IACF,EAAE,OAAO,GAAQ;QACf,IAAI,EAAE,SAAS,EAAE,mBAAmB,KAAK;YACvC,QAAQ,IAAI,CAAC;YACb,OAAO,EAAE;QACX;QACA,MAAM;IACR;AACF;AAEO,eAAe,aAAa,OAAsB;IACvD,MAAM,GAAG,IAAI,CACX,IAAI,qKAAgB,CAAC;QAAE,QAAQ;QAAQ,KAAK;QAAK,MAAM,KAAK,SAAS,CAAC,WAAW,EAAE,EAAE,MAAM;QAAI,aAAa;IAAkB;AAElI;AAEO,eAAe,UAAU,KAAkB;IAChD,MAAM,UAAU,MAAM;IACtB,QAAQ,IAAI,CAAC;IACb,MAAM,aAAa;AACrB;AAEO,eAAe,aAAa,EAAU;IAC3C,MAAM,UAAU,MAAM;IACtB,MAAM,MAAM,QAAQ,MAAM,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;IACzC,MAAM,aAAa;AACrB","debugId":null}},
    {"offset": {"line": 224, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/api/travels/create/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { v4 as uuidv4 } from \"uuid\";\r\nimport nodemailer from \"nodemailer\";\r\nimport { addVoyage, VoyageEntry } from \"@/app/utils/voyageStore\";\r\n\r\nconst RECIPIENTS: Record<string, string[]> = {\r\n  direction_ecole: [\"florian@h-me.fr\"],\r\n  direction_college: [\"florian@h-me.fr\"],\r\n  direction_lycee: [\"florian.hacqueville-mathi@ac-normandie.fr\"],\r\n};\r\n\r\nconst MAX_FILES = 5;\r\nconst ALLOWED_MIME = new Set([\r\n  \"application/pdf\",\r\n  \"image/png\",\r\n  \"image/jpeg\",\r\n  \"image/jpg\",\r\n  \"image/webp\",\r\n  \"application/octet-stream\" \r\n]);\r\n\r\nexport async function POST(req: NextRequest) {\r\n    console.log(\"üì© D√©but API /api/travels/create\");\r\n  try {\r\n    const form = await req.formData();\r\n    console.log(\"‚úÖ FormData re√ßu\");\r\n    const direction_cible = form.get(\"direction_cible\") as keyof typeof RECIPIENTS;\r\n\r\n    // === VALIDATION DES FICHIERS ===\r\n    const files = form.getAll(\"pj\").filter(f => f instanceof File) as File[];\r\n    if (files.length > MAX_FILES) {\r\n        console.warn(\"‚ö†Ô∏è Trop de fichiers :\", files.length);\r\n      return NextResponse.json({ error: `Pas plus de ${MAX_FILES} fichiers.` }, { status: 400 });\r\n    }\r\n\r\n    const pieces_jointes = [];\r\n    for (const file of files) {\r\n      if (!ALLOWED_MIME.has(file.type)) {\r\n        console.warn(\"‚ö†Ô∏è Type de fichier non autoris√© :\", file.name, file.type);\r\n        return NextResponse.json({ error: `Type de fichier non autoris√©: ${file.name}` }, { status: 400 });\r\n      }\r\n      const buf = await file.arrayBuffer();\r\n      pieces_jointes.push({\r\n        filename: file.name,\r\n        buffer: Buffer.from(buf).toString(\"base64\"),\r\n        type: file.type,\r\n      });\r\n    }\r\n\r\n    // === PROGRAMME (fichier unique) ===\r\n    const programmeFile = form.get(\"programme\");\r\n    let programme = null;\r\n    if (programmeFile instanceof File) {\r\n      const progBuf = await programmeFile.arrayBuffer();\r\n      programme = {\r\n        filename: programmeFile.name,\r\n        buffer: Buffer.from(progBuf).toString(\"base64\"),\r\n        type: programmeFile.type,\r\n      };\r\n    }\r\n\r\n    // === STRUCTURE DU VOYAGE ===\r\n    const voyage: VoyageEntry = {\r\n      id: uuidv4(),\r\n      prenom: form.get(\"prenom\") as string,\r\n      nom: form.get(\"nom\") as string,\r\n      email: form.get(\"email\") as string,\r\n      direction_cible: direction_cible,\r\n      date_depart: form.get(\"date_depart\") as string,\r\n      date_retour: form.get(\"date_retour\") as string,\r\n      lieu: form.get(\"lieu\") as string,\r\n      activite: form.get(\"activite\") as string,\r\n      classes: form.get(\"classes\") as string,\r\n      effectif_eleves: Number(form.get(\"effectif_eleves\") || 0),\r\n      effectif_accompagnateurs: Number(form.get(\"effectif_accompagnateurs\") || 0),\r\n      commentaire: form.get(\"commentaire\") as string,\r\n      pieces_jointes,\r\n      programme,\r\n      etat: \"en_attente\",\r\n      date_declaration: new Date().toISOString(),\r\n    };\r\n\r\n    await addVoyage(voyage);\r\n\r\n    // === PR√âPARATION DU MAIL ===\r\n    const lienValidation = `${process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\"}/travels/validate?id=${voyage.id}`;\r\n    const mailTo = RECIPIENTS[direction_cible] || [];\r\n    const mailSubject = `[Voyage scolaire] Nouvelle demande (${voyage.lieu})`;\r\n    const mailText = `\r\n      Nouvelle demande de sortie ou voyage scolaire :\r\n          \r\n      √âtablissement : ${direction_cible}\r\n      Demandeur : ${voyage.prenom} ${voyage.nom} (${voyage.email})\r\n      Dates : du ${voyage.date_depart} au ${voyage.date_retour}\r\n      Lieu / activit√© : ${voyage.lieu} | ${voyage.activite}\r\n      Classes concern√©es : ${voyage.classes}\r\n      √âl√®ves : ${voyage.effectif_eleves} | Accompagnateurs : ${voyage.effectif_accompagnateurs}\r\n      ${voyage.commentaire ? `Commentaire : ${voyage.commentaire}\\n` : \"\"}\r\n      Lien de validation : ${lienValidation}\r\n      `;\r\n    console.log(\"üìß Tentative d‚Äôenvoi de mail...\");\r\n    const transporter = nodemailer.createTransport({\r\n      host: \"smtp.gmail.com\",\r\n      port: 465,\r\n      secure: true,\r\n      auth: {\r\n        user: process.env.SMTP_USER,\r\n        pass: process.env.SMTP_PASS,\r\n      },\r\n    });\r\n\r\n    // === ENVOI DU MAIL ===\r\n    const attachments = [\r\n      ...(programme\r\n        ? [\r\n            {\r\n              filename: programme.filename,\r\n              content: Buffer.from(programme.buffer, \"base64\"),\r\n              contentType: programme.type,\r\n            },\r\n          ]\r\n        : []),\r\n      ...pieces_jointes.map(f => ({\r\n        filename: f.filename,\r\n        content: Buffer.from(f.buffer, \"base64\"),\r\n        contentType: f.type,\r\n      })),\r\n    ];\r\n    await transporter.sendMail({\r\n      from: process.env.SMTP_USER,\r\n      to: mailTo,\r\n      subject: mailSubject,\r\n      text: mailText,\r\n      attachments,\r\n    });\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: \"Demande enregistr√©e et mail envoy√© √† la direction.\",\r\n    });\r\n  } catch (err) {\r\n    console.error(\"Erreur /api/travels/create:\", err);\r\n    return NextResponse.json(\r\n      {\r\n        error: \"Erreur serveur\",\r\n        details: err instanceof Error ? err.message : String(err),\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}