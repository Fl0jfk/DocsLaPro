{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/utils/jsonStore.ts"],"sourcesContent":["// app/utils/jsonStore.ts\r\nimport { S3Client, GetObjectCommand, PutObjectCommand } from \"@aws-sdk/client-s3\";\r\n\r\nexport const s3 = new S3Client({\r\n  region: process.env.AWS_REGION || \"eu-west-3\",\r\n  credentials: {\r\n    accessKeyId: process.env.AWS_ACCESS_KEY_ID!,         // ‚ö†Ô∏è √† mettre en env (jamais en git)\r\n    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!, // ‚ö†Ô∏è √† mettre en env (jamais en git)\r\n  },\r\n});\r\n\r\nexport const BUCKET = process.env.AWS_S3_BUCKET_NAME!;\r\nconst KEY = \"absences_en_attente.json\";\r\n\r\nexport type AbsenceEntry = {\r\n  id: string;\r\n  type: \"prof\" | \"salarie\";\r\n  cible: \"direction_ecole\" | \"direction_college\" | \"direction_lycee\";\r\n  nom: string;\r\n  email: string;\r\n  date_debut: string;\r\n  date_fin: string;\r\n  motif: string;\r\n  commentaire?: string;\r\n  justificatifs?: { filename: string; buffer: string; type: string }[];\r\n  etat: \"en_attente\" | \"validee\" | \"refusee\";\r\n  date_declaration: string;\r\n  directrice?: \"directrice_ecole\" | \"directrice_college\" | \"directrice_lycee\";\r\n};\r\n\r\nexport async function readStore(): Promise<AbsenceEntry[]> {\r\n  try {\r\n    const obj = await s3.send(new GetObjectCommand({ Bucket: BUCKET, Key: KEY }));\r\n    const body = await obj.Body?.transformToString();\r\n    return body ? JSON.parse(body) : [];\r\n  } catch (e: any) {\r\n    // Si l'objet n'existe pas encore\r\n    if (e?.$metadata?.httpStatusCode === 404) return [];\r\n    throw e;\r\n  }\r\n}\r\n\r\nexport async function writeStore(entries: AbsenceEntry[]) {\r\n  await s3.send(\r\n    new PutObjectCommand({\r\n      Bucket: BUCKET,\r\n      Key: KEY,\r\n      Body: JSON.stringify(entries, null, 2),\r\n      ContentType: \"application/json\",\r\n    })\r\n  );\r\n}\r\n\r\nexport async function addEntry(entry: AbsenceEntry) {\r\n  const entries = await readStore();\r\n  entries.push(entry);\r\n  await writeStore(entries);\r\n}\r\n\r\nexport async function removeEntry(id: string) {\r\n  const entries = await readStore();\r\n  const out = entries.filter(e => e.id !== id);\r\n  await writeStore(out);\r\n}\r\n"],"names":[],"mappings":"AAAA,yBAAyB;;;;;;;;;AACzB;;AAEO,MAAM,KAAK,IAAI,iJAAA,CAAA,WAAQ,CAAC;IAC7B,QAAQ,QAAQ,GAAG,CAAC,UAAU,IAAI;IAClC,aAAa;QACX,aAAa,QAAQ,GAAG,CAAC,iBAAiB;QAC1C,iBAAiB,QAAQ,GAAG,CAAC,qBAAqB;IACpD;AACF;AAEO,MAAM,SAAS,QAAQ,GAAG,CAAC,kBAAkB;AACpD,MAAM,MAAM;AAkBL,eAAe;IACpB,IAAI;QACF,MAAM,MAAM,MAAM,GAAG,IAAI,CAAC,IAAI,iJAAA,CAAA,mBAAgB,CAAC;YAAE,QAAQ;YAAQ,KAAK;QAAI;QAC1E,MAAM,OAAO,MAAM,IAAI,IAAI,EAAE;QAC7B,OAAO,OAAO,KAAK,KAAK,CAAC,QAAQ,EAAE;IACrC,EAAE,OAAO,GAAQ;QACf,iCAAiC;QACjC,IAAI,GAAG,WAAW,mBAAmB,KAAK,OAAO,EAAE;QACnD,MAAM;IACR;AACF;AAEO,eAAe,WAAW,OAAuB;IACtD,MAAM,GAAG,IAAI,CACX,IAAI,iJAAA,CAAA,mBAAgB,CAAC;QACnB,QAAQ;QACR,KAAK;QACL,MAAM,KAAK,SAAS,CAAC,SAAS,MAAM;QACpC,aAAa;IACf;AAEJ;AAEO,eAAe,SAAS,KAAmB;IAChD,MAAM,UAAU,MAAM;IACtB,QAAQ,IAAI,CAAC;IACb,MAAM,WAAW;AACnB;AAEO,eAAe,YAAY,EAAU;IAC1C,MAAM,UAAU,MAAM;IACtB,MAAM,MAAM,QAAQ,MAAM,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;IACzC,MAAM,WAAW;AACnB","debugId":null}},
    {"offset": {"line": 138, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/api/absence/want/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { v4 as uuidv4 } from \"uuid\";\r\nimport { addEntry, AbsenceEntry } from \"@/app/utils/jsonStore\";\r\n\r\nconst MAX_FILES = 5;\r\nconst ALLOWED_MIME = new Set([\r\n  \"application/pdf\",\r\n  \"image/png\",\r\n  \"image/jpeg\",\r\n  \"image/jpg\",\r\n  \"image/webp\",\r\n]);\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const data = await req.formData();\r\n\r\n    const type = data.get(\"type\") as \"prof\" | \"salarie\";\r\n    const cible = data.get(\"cible\") as \"direction_ecole\" | \"direction_college\" | \"direction_lycee\";\r\n    const nom = (data.get(\"nom\") as string) || \"\";\r\n    const email = (data.get(\"email\") as string) || \"\";\r\n    const date_debut = data.get(\"date_debut\") as string;\r\n    const date_fin = data.get(\"date_fin\") as string;\r\n    const motif = data.get(\"motif\") as string;\r\n    const commentaire = (data.get(\"commentaire\") as string) || undefined;\r\n\r\n    if (!type || !cible || !nom || !email || !date_debut || !date_fin || !motif) {\r\n      return NextResponse.json({ error: \"Champs requis manquants.\" }, { status: 400 });\r\n    }\r\n\r\n    const files = data.getAll(\"attachments\").filter(f => f instanceof File) as File[];\r\n    if (files.length > MAX_FILES) {\r\n      return NextResponse.json({ error: `Pas plus de ${MAX_FILES} fichiers.` }, { status: 400 });\r\n    }\r\n\r\n    const attachments: { filename: string; buffer: string; type: string }[] = [];\r\n    for (const file of files) {\r\n      if (!ALLOWED_MIME.has(file.type)) {\r\n        return NextResponse.json({ error: `Type de fichier non autoris√©: ${file.name}` }, { status: 400 });\r\n      }\r\n      const arrayBuffer = await file.arrayBuffer();\r\n      attachments.push({\r\n        filename: file.name,\r\n        buffer: Buffer.from(arrayBuffer).toString(\"base64\"),\r\n        type: file.type,\r\n      });\r\n    }\r\n\r\n    const absence: AbsenceEntry = {\r\n      id: uuidv4(),\r\n      type,\r\n      cible,\r\n      nom,\r\n      email,\r\n      date_debut,\r\n      date_fin,\r\n      motif,\r\n      commentaire,\r\n      justificatifs: attachments,\r\n      etat: \"en_attente\",\r\n      date_declaration: new Date().toISOString(),\r\n    };\r\n\r\n    await addEntry(absence);\r\n\r\n    const appUrl = process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\";\r\n    const lien = `${appUrl}/validationAbsences?id=${absence.id}`;\r\n\r\n    console.log(\"üìå Nouvelle demande d'absence:\", absence);\r\n    console.log(\"üîó Lien pour traitement:\", lien);\r\n    console.log(\"üì© Envoi du mail via /api/email...\");\r\n\r\n    await fetch(`${appUrl}/api/email`, {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({\r\n        target: cible,\r\n        subject: `[Absence] Nouvelle demande (${motif})`,\r\n        text: `Nouvelle demande d'absence de ${nom} (${email}) du ${date_debut} au ${date_fin}.\\nMotif: ${motif}\\nCliquez pour traiter: ${lien}`,\r\n        replyTo: email,\r\n        attachments,\r\n      }),\r\n    });\r\n\r\n    console.log(\"‚úÖ Mail envoy√© via /api/email\");\r\n    return NextResponse.json({ success: true, message: \"Demande enregistr√©e et transmise √† la direction.\" });\r\n  } catch (err) {\r\n    console.error(\"‚ùå Erreur /api/absence/want:\", err);\r\n    return NextResponse.json({ error: \"Erreur serveur\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}