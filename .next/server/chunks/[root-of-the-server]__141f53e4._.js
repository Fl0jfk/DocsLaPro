module.exports = [
"[project]/.next-internal/server/app/api/travels/create/route/actions.js [app-rsc] (server actions loader, ecmascript)", ((__turbopack_context__, module, exports) => {

}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/action-async-storage.external.js [external] (next/dist/server/app-render/action-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/action-async-storage.external.js", () => require("next/dist/server/app-render/action-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/crypto [external] (crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}),
"[externals]/events [external] (events, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/util [external] (util, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}),
"[externals]/fs [external] (fs, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/net [external] (net, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}),
"[externals]/dns [external] (dns, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("dns", () => require("dns"));

module.exports = mod;
}),
"[externals]/os [external] (os, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}),
"[externals]/path [external] (path, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}),
"[externals]/tls [external] (tls, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}),
"[externals]/child_process [external] (child_process, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("child_process", () => require("child_process"));

module.exports = mod;
}),
"[externals]/@aws-sdk/client-s3 [external] (@aws-sdk/client-s3, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("@aws-sdk/client-s3", () => require("@aws-sdk/client-s3"));

module.exports = mod;
}),
"[project]/app/utils/voyageStore.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "BUCKET",
    ()=>BUCKET,
    "addVoyage",
    ()=>addVoyage,
    "readVoyages",
    ()=>readVoyages,
    "removeVoyage",
    ()=>removeVoyage,
    "s3",
    ()=>s3,
    "writeVoyages",
    ()=>writeVoyages
]);
var __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/@aws-sdk/client-s3 [external] (@aws-sdk/client-s3, cjs)");
;
const s3 = new __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__["S3Client"]({
    region: "eu-west-3",
    credentials: {
        accessKeyId: process.env.ACCESS_KEY_ID,
        secretAccessKey: process.env.SECRET_ACCESS_KEY
    }
});
const BUCKET = process.env.BUCKET_NAME;
const KEY = "voyages_en_attente.json";
async function readVoyages() {
    try {
        const obj = await s3.send(new __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__["GetObjectCommand"]({
            Bucket: BUCKET,
            Key: KEY
        }));
        const body = await obj.Body?.transformToString();
        if (!body || body.trim() === "") {
            console.warn("⚠️ Fichier voyages_en_attente.json vide, renvoi d’un tableau vide.");
            return [];
        }
        try {
            return JSON.parse(body);
        } catch (err) {
            console.error("⚠️ Erreur de parsing JSON sur le contenu S3 :", err);
            console.error("Contenu du fichier :", body.slice(0, 200)); // aperçu
            return [];
        }
    } catch (e) {
        if (e.$metadata?.httpStatusCode === 404) {
            console.warn("⚠️ Fichier voyages_en_attente.json introuvable, création d’un nouveau.");
            return [];
        }
        throw e;
    }
}
async function writeVoyages(entries) {
    await s3.send(new __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__["PutObjectCommand"]({
        Bucket: BUCKET,
        Key: KEY,
        Body: JSON.stringify(entries ?? [], null, 2),
        ContentType: "application/json"
    }));
}
async function addVoyage(entry) {
    const entries = await readVoyages();
    entries.push(entry);
    await writeVoyages(entries);
}
async function removeVoyage(id) {
    const entries = await readVoyages();
    const out = entries.filter((e)=>e.id !== id);
    await writeVoyages(out);
}
}),
"[project]/app/api/travels/create/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$uuid$2f$dist$2f$esm$2d$node$2f$v4$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__default__as__v4$3e$__ = __turbopack_context__.i("[project]/node_modules/uuid/dist/esm-node/v4.js [app-route] (ecmascript) <export default as v4>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$nodemailer$2f$lib$2f$nodemailer$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/nodemailer/lib/nodemailer.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$utils$2f$voyageStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/app/utils/voyageStore.ts [app-route] (ecmascript)");
;
;
;
;
const RECIPIENTS = {
    direction_ecole: [
        "florian@h-me.fr"
    ],
    direction_college: [
        "florian@h-me.fr"
    ],
    direction_lycee: [
        "florian.hacqueville-mathi@ac-normandie.fr"
    ]
};
const MAX_FILES = 5;
const ALLOWED_MIME = new Set([
    "application/pdf",
    "image/png",
    "image/jpeg",
    "image/jpg",
    "image/webp",
    "application/octet-stream"
]);
async function POST(req) {
    console.log("📩 Début API /api/travels/create");
    try {
        const form = await req.formData();
        console.log("✅ FormData reçu");
        const direction_cible = form.get("direction_cible");
        // === VALIDATION DES FICHIERS ===
        const files = form.getAll("pj").filter((f)=>f instanceof File);
        if (files.length > MAX_FILES) {
            console.warn("⚠️ Trop de fichiers :", files.length);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: `Pas plus de ${MAX_FILES} fichiers.`
            }, {
                status: 400
            });
        }
        const pieces_jointes = [];
        for (const file of files){
            if (!ALLOWED_MIME.has(file.type)) {
                console.warn("⚠️ Type de fichier non autorisé :", file.name, file.type);
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: `Type de fichier non autorisé: ${file.name}`
                }, {
                    status: 400
                });
            }
            const buf = await file.arrayBuffer();
            pieces_jointes.push({
                filename: file.name,
                buffer: Buffer.from(buf).toString("base64"),
                type: file.type
            });
        }
        // === PROGRAMME (fichier unique) ===
        const programmeFile = form.get("programme");
        let programme = null;
        if (programmeFile instanceof File) {
            const progBuf = await programmeFile.arrayBuffer();
            programme = {
                filename: programmeFile.name,
                buffer: Buffer.from(progBuf).toString("base64"),
                type: programmeFile.type
            };
        }
        // === STRUCTURE DU VOYAGE ===
        const voyage = {
            id: (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$uuid$2f$dist$2f$esm$2d$node$2f$v4$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__default__as__v4$3e$__["v4"])(),
            prenom: form.get("prenom"),
            nom: form.get("nom"),
            email: form.get("email"),
            direction_cible: direction_cible,
            date_depart: form.get("date_depart"),
            date_retour: form.get("date_retour"),
            lieu: form.get("lieu"),
            activite: form.get("activite"),
            classes: form.get("classes"),
            effectif_eleves: Number(form.get("effectif_eleves") || 0),
            effectif_accompagnateurs: Number(form.get("effectif_accompagnateurs") || 0),
            commentaire: form.get("commentaire"),
            pieces_jointes,
            programme,
            etat: "en_attente",
            date_declaration: new Date().toISOString()
        };
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$utils$2f$voyageStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["addVoyage"])(voyage);
        // === PRÉPARATION DU MAIL ===
        const lienValidation = `${("TURBOPACK compile-time value", "https://docslapro.com") || "http://localhost:3000"}/travels/validate?id=${voyage.id}`;
        const mailTo = RECIPIENTS[direction_cible] || [];
        const mailSubject = `[Voyage scolaire] Nouvelle demande (${voyage.lieu})`;
        const mailText = `
      Nouvelle demande de sortie ou voyage scolaire :
          
      Établissement : ${direction_cible}
      Demandeur : ${voyage.prenom} ${voyage.nom} (${voyage.email})
      Dates : du ${voyage.date_depart} au ${voyage.date_retour}
      Lieu / activité : ${voyage.lieu} | ${voyage.activite}
      Classes concernées : ${voyage.classes}
      Élèves : ${voyage.effectif_eleves} | Accompagnateurs : ${voyage.effectif_accompagnateurs}
      ${voyage.commentaire ? `Commentaire : ${voyage.commentaire}\n` : ""}
      Lien de validation : ${lienValidation}
      `;
        console.log("📧 Tentative d’envoi de mail...");
        const transporter = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$nodemailer$2f$lib$2f$nodemailer$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].createTransport({
            host: "smtp.gmail.com",
            port: 465,
            secure: true,
            auth: {
                user: process.env.SMTP_USER,
                pass: process.env.SMTP_PASS
            }
        });
        // === ENVOI DU MAIL ===
        const attachments = [
            ...programme ? [
                {
                    filename: programme.filename,
                    content: Buffer.from(programme.buffer, "base64"),
                    contentType: programme.type
                }
            ] : [],
            ...pieces_jointes.map((f)=>({
                    filename: f.filename,
                    content: Buffer.from(f.buffer, "base64"),
                    contentType: f.type
                }))
        ];
        await transporter.sendMail({
            from: process.env.SMTP_USER,
            to: mailTo,
            subject: mailSubject,
            text: mailText,
            attachments
        });
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: true,
            message: "Demande enregistrée et mail envoyé à la direction."
        });
    } catch (err) {
        console.error("Erreur /api/travels/create:", err);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Erreur serveur",
            details: err instanceof Error ? err.message : String(err)
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__141f53e4._.js.map