{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 163, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/utils/googleTokenStore.ts"],"sourcesContent":["// lib/googleTokensStore.ts\r\nimport { S3Client, GetObjectCommand } from '@aws-sdk/client-s3'\r\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner'\r\n\r\nconst s3 = new S3Client({\r\n  region: process.env.REGION,\r\n  credentials: {\r\n    accessKeyId: process.env.ACCESS_KEY_ID!,\r\n    secretAccessKey: process.env.SECRET_ACCESS_KEY!,\r\n  },\r\n})\r\n\r\nconst BUCKET = process.env.BUCKET_NAME!\r\nconst FILE_KEY = 'tokensGoogle.json'\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nexport async function readTokens(): Promise<Record<string, any>> {\r\n  try {\r\n    const command = new GetObjectCommand({ Bucket: BUCKET, Key: FILE_KEY })\r\n    const url = await getSignedUrl(s3, command, { expiresIn: 60 })\r\n    const res = await fetch(url)\r\n    if (!res.ok) return {}\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    return (await res.json()) as Record<string, any>\r\n  } catch (err) {\r\n    console.error('Erreur lecture JSON S3 :', err)\r\n    return {}\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,2BAA2B;;;;;AAC3B;AACA;AAAA;;;AAEA,MAAM,KAAK,IAAI,6JAAQ,CAAC;IACtB,QAAQ,QAAQ,GAAG,CAAC,MAAM;IAC1B,aAAa;QACX,aAAa,QAAQ,GAAG,CAAC,aAAa;QACtC,iBAAiB,QAAQ,GAAG,CAAC,iBAAiB;IAChD;AACF;AAEA,MAAM,SAAS,QAAQ,GAAG,CAAC,WAAW;AACtC,MAAM,WAAW;AAGV,eAAe;IACpB,IAAI;QACF,MAAM,UAAU,IAAI,qKAAgB,CAAC;YAAE,QAAQ;YAAQ,KAAK;QAAS;QACrE,MAAM,MAAM,MAAM,IAAA,0MAAY,EAAC,IAAI,SAAS;YAAE,WAAW;QAAG;QAC5D,MAAM,MAAM,MAAM,MAAM;QACxB,IAAI,CAAC,IAAI,EAAE,EAAE,OAAO,CAAC;QACrB,8DAA8D;QAC9D,OAAQ,MAAM,IAAI,IAAI;IACxB,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,CAAC;IACV;AACF","debugId":null}},
    {"offset": {"line": 204, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/api/google/events/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { google } from 'googleapis'\r\nimport { readTokens } from '@/app/utils/googleTokenStore'\r\n\r\nasync function getGoogleCalendarClient() {\r\n  const tokens = await readTokens()\r\n  const email = process.env.GOOGLE_ACCOUNT_EMAIL!\r\n  const stored = tokens[email]\r\n  if (!stored || !stored.refreshToken) { throw new Error(`Aucun refreshToken trouvé pour ${email}`)}\r\n\r\n  const oauth2Client = new google.auth.OAuth2(\r\n    process.env.GOOGLE_CLIENT_ID,\r\n    process.env.GOOGLE_CLIENT_SECRET,\r\n    process.env.GOOGLE_REDIRECT_URI,\r\n  )\r\n\r\n  oauth2Client.setCredentials({\r\n    refresh_token: stored.refreshToken,\r\n  })\r\n\r\n  const calendar = google.calendar({ version: 'v3', auth: oauth2Client })\r\n  return calendar\r\n}\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nfunction mapGoogleEventToUiEvent(googleEvent: any) {\r\n  const start = googleEvent.start?.dateTime ?? googleEvent.start?.date\r\n  const end = googleEvent.end?.dateTime ?? googleEvent.end?.date\r\n\r\n  const creatorName =\r\n    googleEvent.creator?.displayName ??\r\n    googleEvent.creator?.email ??\r\n    'Créé via GoogleAgenda'\r\n\r\n  const colorId = googleEvent.colorId ?? null\r\n\r\n  return {\r\n    id: googleEvent.id,\r\n    title: googleEvent.summary ?? '(Sans titre)',\r\n    description: googleEvent.description ?? '',\r\n    location: googleEvent.location ?? '',\r\n    startDate: start,\r\n    endDate: end,\r\n    isAllDay: !googleEvent.start?.dateTime,\r\n    colorId,\r\n    google: {\r\n      colorId,\r\n      htmlLink: googleEvent.htmlLink ?? null,\r\n      creatorName,\r\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n      attendees: (googleEvent.attendees ?? []).map((a: any) => ({\r\n        email: a.email,\r\n        displayName: a.displayName ?? null,\r\n        responseStatus: a.responseStatus ?? null,\r\n      })),\r\n    },\r\n  }\r\n}\r\n\r\nexport async function GET(req: NextRequest) {\r\n  try {\r\n    const calendar = await getGoogleCalendarClient()\r\n    const { searchParams } = new URL(req.url)\r\n\r\n    const timeMin = searchParams.get('timeMin') ?? new Date().toISOString()\r\n    const timeMax =\r\n      searchParams.get('timeMax') ??\r\n      new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()\r\n\r\n    const calendarId = process.env.GOOGLE_CALENDAR_ID ?? 'primary'\r\n\r\n    const res = await calendar.events.list({\r\n      calendarId,\r\n      timeMin,\r\n      timeMax,\r\n      singleEvents: true,\r\n      orderBy: 'startTime',\r\n    })\r\n\r\n    const items = res.data.items ?? []\r\n    const uiEvents = items.map(mapGoogleEventToUiEvent)\r\n\r\n    return NextResponse.json(uiEvents)\r\n  } catch (e) {\r\n    console.error('Erreur GET /api/google/events', e)\r\n    return NextResponse.json(\r\n      { error: 'Failed to list events' },\r\n      { status: 500 },\r\n    )\r\n  }\r\n}\r\n\r\n// ---------- POST : crée un event à partir de CreateEventPayload ----------\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const body = await req.json()\r\n    const calendar = await getGoogleCalendarClient()\r\n    const calendarId = process.env.GOOGLE_CALENDAR_ID ?? 'primary'\r\n\r\n    const {\r\n      title,\r\n      description,\r\n      location,\r\n      startDate,\r\n      endDate,\r\n      isAllDay,\r\n      colorId,\r\n    } = body as {\r\n      title: string\r\n      description: string\r\n      location: string\r\n      startDate: string\r\n      endDate: string\r\n      isAllDay: boolean\r\n      colorId?: string | null\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const event: any = {\r\n      summary: title,\r\n      description,\r\n      location,\r\n      start: {},\r\n      end: {},\r\n    }\r\n\r\n    if (isAllDay) {\r\n      event.start.date = startDate.slice(0, 10)\r\n      event.end.date = endDate.slice(0, 10)\r\n    } else {\r\n      event.start.dateTime = startDate\r\n      event.end.dateTime = endDate\r\n    }\r\n\r\n    if (colorId != null) {\r\n      event.colorId = colorId\r\n    }\r\n    const resInsert = await calendar.events.insert({\r\n      calendarId,\r\n      requestBody: event,\r\n    })\r\n    const created = mapGoogleEventToUiEvent(resInsert.data)\r\n    return NextResponse.json(created)\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  } catch (e: any) {\r\n    console.error(\r\n      'Erreur POST /api/google/events',\r\n      JSON.stringify(e, null, 2),\r\n    )\r\n    return NextResponse.json(\r\n      {\r\n        error: 'Failed to create event',\r\n        details: e?.message ?? null,\r\n      },\r\n      { status: 500 },\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}