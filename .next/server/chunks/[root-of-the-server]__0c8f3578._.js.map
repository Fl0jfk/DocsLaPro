{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 163, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/api/google/gmailPoll/route.ts"],"sourcesContent":["// app/api/gmail-poll/route.ts\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport { google } from \"googleapis\";\r\nimport { S3Client, GetObjectCommand } from \"@aws-sdk/client-s3\";\r\nimport { getSignedUrl } from \"@aws-sdk/s3-request-presigner\";\r\n\r\nconst s3 = new S3Client({\r\n  region: process.env.REGION,\r\n  credentials: {\r\n    accessKeyId: process.env.ACCESS_KEY_ID!,\r\n    secretAccessKey: process.env.SECRET_ACCESS_KEY!,\r\n  },\r\n});\r\nconst BUCKET = process.env.BUCKET_NAME!;\r\nconst FILE_KEY = \"tokensGoogle.json\";\r\nconst GRAPH_BASE = \"https://graph.microsoft.com/v1.0\";\r\n\r\n// mapping catÃ©gorie -> plan/bucket Planner (IDs Ã  mettre en env ou en dur)\r\nconst PLANS_BY_CATEGORY: Record<string, { planId: string; bucketId: string }> =\r\n  {\r\n    COMPTA: {\r\n      planId: process.env.PLANNER_PLAN_COMPTA_ID || \"PLAN_COMPTA_ID\",\r\n      bucketId: process.env.PLANNER_BUCKET_COMPTA_ID || \"BUCKET_COMPTA_ID\",\r\n    },\r\n    ADMIN: {\r\n      planId: process.env.PLANNER_PLAN_ADMIN_ID || \"PLAN_ADMIN_ID\",\r\n      bucketId: process.env.PLANNER_BUCKET_ADMIN_ID || \"BUCKET_ADMIN_ID\",\r\n    },\r\n    CPE: {\r\n      planId: process.env.PLANNER_PLAN_CPE_ID || \"PLAN_CPE_ID\",\r\n      bucketId: process.env.PLANNER_BUCKET_CPE_ID || \"BUCKET_CPE_ID\",\r\n    },\r\n    VIE_SCOLAIRE: {\r\n      planId:\r\n        process.env.PLANNER_PLAN_VIE_SCOLAIRE_ID || \"PLAN_VIE_SCOLAIRE_ID\",\r\n      bucketId:\r\n        process.env.PLANNER_BUCKET_VIE_SCOLAIRE_ID ||\r\n        \"BUCKET_VIE_SCOLAIRE_ID\",\r\n    },\r\n    DIRECTION: {\r\n      planId: process.env.PLANNER_PLAN_DIRECTION_ID || \"PLAN_DIRECTION_ID\",\r\n      bucketId:\r\n        process.env.PLANNER_BUCKET_DIRECTION_ID || \"BUCKET_DIRECTION_ID\",\r\n    },\r\n  };\r\n\r\nasync function readTokens() {\r\n  try {\r\n    const command = new GetObjectCommand({ Bucket: BUCKET, Key: FILE_KEY });\r\n    const url = await getSignedUrl(s3, command, { expiresIn: 60 });\r\n    const res = await fetch(url);\r\n    if (!res.ok) return {};\r\n    return await res.json();\r\n  } catch (err) {\r\n    console.error(\"Erreur lecture JSON S3 :\", err);\r\n    return {};\r\n  }\r\n}\r\n\r\nasync function callAIForRouting(from: string, subject: string, text: string) {\r\n  const extractionPrompt = `\r\nTu es l'assistant d'un Ã©tablissement scolaire.\r\n\r\nÃ€ partir de l'email suivant, retourne un JSON STRICTEMENT de la forme :\r\n{\r\n  \"category\": \"COMPTA | ADMIN | CPE | VIE_SCOLAIRE | DIRECTION\",\r\n  \"summary\": \"rÃ©sumÃ© trÃ¨s court en une phrase\"\r\n}\r\n\r\nEmail :\r\nDe: ${from}\r\nSujet: ${subject}\r\nContenu: ${text}\r\n`;\r\n\r\n  const extractionResponse = await fetch(\r\n    \"https://api.mistral.ai/v1/chat/completions\",\r\n    {\r\n      method: \"POST\",\r\n      headers: {\r\n        Authorization: `Bearer ${process.env.MISTRAL_API_KEY}`,\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({\r\n        model: \"mistral-medium\",\r\n        messages: [{ role: \"user\", content: extractionPrompt }],\r\n        temperature: 0,\r\n        response_format: { type: \"json_object\" },\r\n      }),\r\n    },\r\n  );\r\n\r\n  if (!extractionResponse.ok) {\r\n    throw new Error(`Mistral error: ${extractionResponse.status}`);\r\n  }\r\n\r\n  const data = await extractionResponse.json();\r\n  const content = data.choices[0].message.content as string;\r\n  const parsed = JSON.parse(content);\r\n\r\n  return {\r\n    category: parsed.category as string,\r\n    summary: parsed.summary as string,\r\n  };\r\n}\r\n\r\n// crÃ©ation de tÃ¢che Planner Ã  partir dâ€™un mail\r\nasync function createPlannerTaskFromEmail(params: {\r\n  accessToken: string;\r\n  planId: string;\r\n  bucketId: string;\r\n  subject: string;\r\n  from: string;\r\n  summary: string;\r\n  text: string;\r\n}) {\r\n  const { accessToken, planId, bucketId, subject, from, summary, text } =\r\n    params;\r\n\r\n  const title = `${subject}`.slice(0, 250);\r\n  const description = (\r\n    `Mail de: ${from}\\n\\nRÃ©sumÃ© IA:\\n${summary}\\n\\nContenu:\\n${text}`\r\n  ).slice(0, 8000);\r\n\r\n  const taskRes = await fetch(`${GRAPH_BASE}/planner/tasks`, {\r\n    method: \"POST\",\r\n    headers: {\r\n      Authorization: `Bearer ${accessToken}`,\r\n      \"Content-Type\": \"application/json\",\r\n    },\r\n    body: JSON.stringify({\r\n      planId,\r\n      bucketId,\r\n      title,\r\n    }),\r\n  });\r\n\r\n  if (!taskRes.ok) {\r\n    const errText = await taskRes.text();\r\n    console.error(\"Erreur crÃ©ation tÃ¢che Planner\", errText);\r\n    throw new Error(\"Erreur crÃ©ation tÃ¢che Planner\");\r\n  }\r\n\r\n  const task = await taskRes.json();\r\n  const taskId = task.id as string;\r\n  const etag = task[\"@odata.etag\"] as string | undefined;\r\n\r\n  if (etag) {\r\n    const detailsRes = await fetch(\r\n      `${GRAPH_BASE}/planner/tasks/${taskId}/details`,\r\n      {\r\n        method: \"PATCH\",\r\n        headers: {\r\n          Authorization: `Bearer ${accessToken}`,\r\n          \"Content-Type\": \"application/json\",\r\n          \"If-Match\": etag,\r\n        },\r\n        body: JSON.stringify({\r\n          description,\r\n        }),\r\n      },\r\n    );\r\n\r\n    if (!detailsRes.ok) {\r\n      const errText = await detailsRes.text();\r\n      console.error(\"Erreur mise Ã  jour dÃ©tails Planner\", errText);\r\n    }\r\n  }\r\n\r\n  return { taskId };\r\n}\r\n\r\n// ðŸ” maintenant en POST et on attend graphAccessToken dans le body\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const body = await req.json();\r\n    const graphAccessToken = body.graphAccessToken as string | undefined;\r\n\r\n    if (!graphAccessToken) {\r\n      return NextResponse.json(\r\n        { ok: false, error: \"graphAccessToken manquant\" },\r\n        { status: 400 },\r\n      );\r\n    }\r\n\r\n    const tokens = await readTokens();\r\n    const email = process.env.GOOGLE_ACCOUNT_EMAIL!;\r\n    const userTokens = (tokens as any)[email];\r\n\r\n    if (!userTokens?.refreshToken) {\r\n      return NextResponse.json(\r\n        { ok: false, error: \"Aucun refreshToken trouvÃ© pour cet email\" },\r\n        { status: 400 },\r\n      );\r\n    }\r\n\r\n    const oAuth2Client = new google.auth.OAuth2(\r\n      process.env.GOOGLE_CLIENT_ID,\r\n      process.env.GOOGLE_CLIENT_SECRET,\r\n      process.env.GOOGLE_REDIRECT_URI,\r\n    );\r\n\r\n    oAuth2Client.setCredentials({\r\n      refresh_token: userTokens.refreshToken,\r\n    });\r\n\r\n    const gmail = google.gmail({ version: \"v1\", auth: oAuth2Client });\r\n\r\n    const listRes = await gmail.users.messages.list({\r\n      userId: \"me\",\r\n      q: \"is:unread\",\r\n      maxResults: 10,\r\n    });\r\n\r\n    const messages = listRes.data.messages || [];\r\n    const results: any[] = [];\r\n\r\n    for (const msg of messages) {\r\n      if (!msg.id) continue;\r\n\r\n      const full = await gmail.users.messages.get({\r\n        userId: \"me\",\r\n        id: msg.id,\r\n        format: \"FULL\",\r\n      });\r\n\r\n      const payload = full.data.payload;\r\n      const headers = payload?.headers || [];\r\n      const from = headers.find((h) => h.name === \"From\")?.value || \"\";\r\n      const subject = headers.find((h) => h.name === \"Subject\")?.value || \"\";\r\n\r\n      let text = \"\";\r\n      if (payload?.parts) {\r\n        const part = payload.parts.find((p) => p.mimeType === \"text/plain\");\r\n        if (part?.body?.data) {\r\n          text = Buffer.from(part.body.data, \"base64\").toString(\"utf8\");\r\n        }\r\n      } else if (payload?.body?.data) {\r\n        text = Buffer.from(payload.body.data, \"base64\").toString(\"utf8\");\r\n      }\r\n\r\n      const { category, summary } = await callAIForRouting(from, subject, text);\r\n\r\n      const mapping = PLANS_BY_CATEGORY[category] ?? PLANS_BY_CATEGORY.ADMIN;\r\n\r\n      try {\r\n        await createPlannerTaskFromEmail({\r\n          accessToken: graphAccessToken,\r\n          planId: mapping.planId,\r\n          bucketId: mapping.bucketId,\r\n          subject,\r\n          from,\r\n          summary,\r\n          text,\r\n        });\r\n      } catch (e) {\r\n        console.error(\r\n          `Erreur Planner pour le mail ${msg.id} (${subject})`,\r\n          e,\r\n        );\r\n      }\r\n\r\n      await gmail.users.messages.modify({\r\n        userId: \"me\",\r\n        id: msg.id,\r\n        requestBody: {\r\n          removeLabelIds: [\"UNREAD\"],\r\n        },\r\n      });\r\n\r\n      results.push({ id: msg.id, from, subject, category, summary });\r\n    }\r\n\r\n    return NextResponse.json({ ok: true, count: results.length, emails: results });\r\n  } catch (error: any) {\r\n    console.error(error);\r\n    return NextResponse.json(\r\n      { ok: false, error: error.message || \"Error while polling Gmail\" },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}