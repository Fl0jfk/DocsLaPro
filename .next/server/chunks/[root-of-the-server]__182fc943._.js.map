{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 133, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/utils/voyageStore.ts"],"sourcesContent":["// app/utils/voyageStore.ts\r\nimport {\r\n  S3Client,\r\n  GetObjectCommand,\r\n  PutObjectCommand,\r\n  ListObjectsV2Command,\r\n} from \"@aws-sdk/client-s3\";\r\nimport { getSignedUrl } from \"@aws-sdk/s3-request-presigner\";\r\nimport { currentUser } from \"@clerk/nextjs/server\";\r\nimport { v4 as uuidv4 } from \"uuid\";\r\n\r\nexport const s3 = new S3Client({\r\n  region: \"eu-west-3\",\r\n  credentials: {\r\n    accessKeyId: process.env.ACCESS_KEY_ID!,\r\n    secretAccessKey: process.env.SECRET_ACCESS_KEY!,\r\n  },\r\n});\r\n\r\nexport const BUCKET = process.env.BUCKET_NAME!;\r\n\r\nexport type VoyagePieceJointe = {\r\n  filename: string;\r\n  url: string;\r\n  type: string;\r\n};\r\n\r\nexport type VoyageStatus =\r\n  | \"draft\"\r\n  | \"direction_validation\"\r\n  | \"requests_stage\"\r\n  | \"compta_validation\"\r\n  | \"final_validation\"\r\n  | \"validated\"\r\n  | \"rejected\";\r\n\r\nexport type VoyageEntry = {\r\n  id: string;\r\n  prenom: string;\r\n  nom: string;\r\n  email: string;\r\n  direction_cible: string;\r\n  date_depart: string;\r\n  date_retour: string;\r\n  lieu: string;\r\n  activite: string;\r\n  classes: string;\r\n  effectif_eleves: number;\r\n  effectif_accompagnateurs: number;\r\n  commentaire?: string;\r\n  pieces_jointes?: VoyagePieceJointe[] | null;\r\n  date_declaration: string;\r\n  status: VoyageStatus;\r\n};\r\n\r\nexport async function saveVoyage(userId: string, voyage: VoyageEntry) {\r\n  const key = `travels/${userId}/${voyage.id}/voyage.json`;\r\n  await s3.send(\r\n    new PutObjectCommand({\r\n      Bucket: BUCKET,\r\n      Key: key,\r\n      Body: JSON.stringify(voyage, null, 2),\r\n      ContentType: \"application/json\",\r\n    })\r\n  );\r\n  return key;\r\n}\r\n\r\nexport async function listVoyages(userId: string) {\r\n  const res = await s3.send(\r\n    new ListObjectsV2Command({\r\n      Bucket: BUCKET,\r\n      Prefix: `travels/${userId}/`,\r\n    })\r\n  );\r\n  return (res.Contents || []).filter((obj) => obj.Key?.endsWith(\"voyage.json\"));\r\n}\r\n\r\nexport async function getVoyage(userId: string, voyageId: string) {\r\n  const key = `travels/${userId}/${voyageId}/voyage.json`;\r\n  const obj = await s3.send(new GetObjectCommand({ Bucket: BUCKET, Key: key }));\r\n  const body = await obj.Body?.transformToString();\r\n  return JSON.parse(body!);\r\n}\r\n\r\nexport async function getPresignedUploadUrl(\r\n  voyageId: string,\r\n  filename: string,\r\n  type: string\r\n): Promise<{ uploadUrl: string; fileUrl: string; key: string }> {\r\n  const user = await currentUser();\r\n  if (!user) throw new Error(\"Utilisateur non authentifi√©\");\r\n\r\n  const key = `travels/${user.id}/${voyageId}/${filename}`;\r\n  const command = new PutObjectCommand({\r\n    Bucket: BUCKET,\r\n    Key: key,\r\n    ContentType: type,\r\n  });\r\n  const uploadUrl = await getSignedUrl(s3, command, { expiresIn: 3600 });\r\n  const fileUrl = `https://${BUCKET}.s3.eu-west-3.amazonaws.com/${key}`;\r\n  return { uploadUrl, fileUrl, key };\r\n}\r\n"],"names":[],"mappings":"AAAA,2BAA2B;;;;;;;;;;;;;;;AAC3B;AAMA;AAAA;AACA;;;;AAGO,MAAM,KAAK,IAAI,6JAAQ,CAAC;IAC7B,QAAQ;IACR,aAAa;QACX,aAAa,QAAQ,GAAG,CAAC,aAAa;QACtC,iBAAiB,QAAQ,GAAG,CAAC,iBAAiB;IAChD;AACF;AAEO,MAAM,SAAS,QAAQ,GAAG,CAAC,WAAW;AAoCtC,eAAe,WAAW,MAAc,EAAE,MAAmB;IAClE,MAAM,MAAM,CAAC,QAAQ,EAAE,OAAO,CAAC,EAAE,OAAO,EAAE,CAAC,YAAY,CAAC;IACxD,MAAM,GAAG,IAAI,CACX,IAAI,qKAAgB,CAAC;QACnB,QAAQ;QACR,KAAK;QACL,MAAM,KAAK,SAAS,CAAC,QAAQ,MAAM;QACnC,aAAa;IACf;IAEF,OAAO;AACT;AAEO,eAAe,YAAY,MAAc;IAC9C,MAAM,MAAM,MAAM,GAAG,IAAI,CACvB,IAAI,yKAAoB,CAAC;QACvB,QAAQ;QACR,QAAQ,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;IAC9B;IAEF,OAAO,CAAC,IAAI,QAAQ,IAAI,EAAE,EAAE,MAAM,CAAC,CAAC,MAAQ,IAAI,GAAG,EAAE,SAAS;AAChE;AAEO,eAAe,UAAU,MAAc,EAAE,QAAgB;IAC9D,MAAM,MAAM,CAAC,QAAQ,EAAE,OAAO,CAAC,EAAE,SAAS,YAAY,CAAC;IACvD,MAAM,MAAM,MAAM,GAAG,IAAI,CAAC,IAAI,qKAAgB,CAAC;QAAE,QAAQ;QAAQ,KAAK;IAAI;IAC1E,MAAM,OAAO,MAAM,IAAI,IAAI,EAAE;IAC7B,OAAO,KAAK,KAAK,CAAC;AACpB;AAEO,eAAe,sBACpB,QAAgB,EAChB,QAAgB,EAChB,IAAY;IAEZ,MAAM,OAAO,MAAM,IAAA,2MAAW;IAC9B,IAAI,CAAC,MAAM,MAAM,IAAI,MAAM;IAE3B,MAAM,MAAM,CAAC,QAAQ,EAAE,KAAK,EAAE,CAAC,CAAC,EAAE,SAAS,CAAC,EAAE,UAAU;IACxD,MAAM,UAAU,IAAI,qKAAgB,CAAC;QACnC,QAAQ;QACR,KAAK;QACL,aAAa;IACf;IACA,MAAM,YAAY,MAAM,IAAA,0MAAY,EAAC,IAAI,SAAS;QAAE,WAAW;IAAK;IACpE,MAAM,UAAU,CAAC,QAAQ,EAAE,OAAO,4BAA4B,EAAE,KAAK;IACrE,OAAO;QAAE;QAAW;QAAS;IAAI;AACnC","debugId":null}},
    {"offset": {"line": 212, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/api/travels/updateStatus/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { s3, BUCKET } from \"@/app/utils/voyageStore\";\r\nimport { GetObjectCommand, PutObjectCommand } from \"@aws-sdk/client-s3\";\r\nimport { currentUser } from \"@clerk/nextjs/server\";\r\n\r\ntype VoyageStatus =\r\n  | \"draft\"\r\n  | \"direction_validation\"\r\n  | \"requests_stage\"\r\n  | \"compta_validation\"\r\n  | \"final_validation\"\r\n  | \"validated\"\r\n  | \"rejected\";\r\n\r\ntype Voyage = {\r\n  id: string;\r\n  lieu: string;\r\n  activite: string;\r\n  date_depart: string;\r\n  date_retour: string;\r\n  classes: string;\r\n  effectif_eleves: number;\r\n  effectif_accompagnateurs: number;\r\n  commentaire?: string;\r\n  pieces_jointes?: { filename: string; url: string }[];\r\n  status: VoyageStatus;\r\n};\r\n\r\nconst allowedTransitions: Record<VoyageStatus, VoyageStatus[]> = {\r\n  draft: [\"direction_validation\"],\r\n  direction_validation: [\"requests_stage\", \"rejected\"],\r\n  requests_stage: [\"compta_validation\"],\r\n  compta_validation: [\"final_validation\"],\r\n  final_validation: [\"validated\"],\r\n  validated: [],\r\n  rejected: [],\r\n};\r\n\r\nconst rolePermissions: Record<string, VoyageStatus[]> = {\r\n  professeur: [\"draft\", \"requests_stage\"],\r\n  direction_ecole: [\"draft\",\"direction_validation\", \"final_validation\"],\r\n  direction_college: [\"direction_validation\", \"final_validation\"],\r\n  direction_lycee: [\"direction_validation\", \"final_validation\"],\r\n  compta: [\"compta_validation\"],\r\n};\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const user = await currentUser();\r\n    if (!user) {\r\n      return NextResponse.json({ error: \"Non authentifi√©\" }, { status: 401 });\r\n    }\r\n    const { voyageId, newStatus } = (await req.json()) as {\r\n      voyageId: string;\r\n      newStatus: VoyageStatus;\r\n    };\r\n    const role = user.publicMetadata?.role as string | undefined;\r\n    if (!role) {\r\n      return NextResponse.json({ error: \"R√¥le utilisateur manquant\" }, { status: 400 });\r\n    }\r\n    const key = `travels/${user.id}/${voyageId}/voyage.json`;\r\n    const obj = await s3.send(new GetObjectCommand({ Bucket: BUCKET, Key: key }));\r\n    const oldBody = await obj.Body?.transformToString();\r\n    if (!oldBody) {\r\n      return NextResponse.json({ error: \"Voyage introuvable\" }, { status: 404 });\r\n    }\r\n\r\n    const voyage: Voyage = JSON.parse(oldBody);\r\n    console.log(voyage)\r\n    if (!rolePermissions[role]?.includes(voyage.status)) {\r\n      console.log(\"updateStatus call:\", { role, voyageStatus: voyage.status, allowed: rolePermissions[role] });\r\n\r\n      return NextResponse.json(\r\n        { error: \"Acc√®s refus√© √† cette √©tape\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // üîÑ V√©rif : transition valide ?\r\n    if (!allowedTransitions[voyage.status]?.includes(newStatus)) {\r\n      return NextResponse.json(\r\n        { error: \"Transition non autoris√©e\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // ‚úÖ Mise √† jour du statut\r\n    voyage.status = newStatus;\r\n\r\n    await s3.send(\r\n      new PutObjectCommand({\r\n        Bucket: BUCKET,\r\n        Key: key,\r\n        Body: JSON.stringify(voyage, null, 2),\r\n        ContentType: \"application/json\",\r\n      })\r\n    );\r\n\r\n    return NextResponse.json({ success: true, newStatus });\r\n  } catch (err) {\r\n    console.error(\"Erreur updateStatus:\", err);\r\n    return NextResponse.json({ error: \"Erreur interne\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAyBA,MAAM,qBAA2D;IAC/D,OAAO;QAAC;KAAuB;IAC/B,sBAAsB;QAAC;QAAkB;KAAW;IACpD,gBAAgB;QAAC;KAAoB;IACrC,mBAAmB;QAAC;KAAmB;IACvC,kBAAkB;QAAC;KAAY;IAC/B,WAAW,EAAE;IACb,UAAU,EAAE;AACd;AAEA,MAAM,kBAAkD;IACtD,YAAY;QAAC;QAAS;KAAiB;IACvC,iBAAiB;QAAC;QAAQ;QAAwB;KAAmB;IACrE,mBAAmB;QAAC;QAAwB;KAAmB;IAC/D,iBAAiB;QAAC;QAAwB;KAAmB;IAC7D,QAAQ;QAAC;KAAoB;AAC/B;AAEO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,IAAA,2MAAW;QAC9B,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QACA,MAAM,EAAE,QAAQ,EAAE,SAAS,EAAE,GAAI,MAAM,IAAI,IAAI;QAI/C,MAAM,OAAO,KAAK,cAAc,EAAE;QAClC,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA4B,GAAG;gBAAE,QAAQ;YAAI;QACjF;QACA,MAAM,MAAM,CAAC,QAAQ,EAAE,KAAK,EAAE,CAAC,CAAC,EAAE,SAAS,YAAY,CAAC;QACxD,MAAM,MAAM,MAAM,mIAAE,CAAC,IAAI,CAAC,IAAI,qKAAgB,CAAC;YAAE,QAAQ,uIAAM;YAAE,KAAK;QAAI;QAC1E,MAAM,UAAU,MAAM,IAAI,IAAI,EAAE;QAChC,IAAI,CAAC,SAAS;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqB,GAAG;gBAAE,QAAQ;YAAI;QAC1E;QAEA,MAAM,SAAiB,KAAK,KAAK,CAAC;QAClC,QAAQ,GAAG,CAAC;QACZ,IAAI,CAAC,eAAe,CAAC,KAAK,EAAE,SAAS,OAAO,MAAM,GAAG;YACnD,QAAQ,GAAG,CAAC,sBAAsB;gBAAE;gBAAM,cAAc,OAAO,MAAM;gBAAE,SAAS,eAAe,CAAC,KAAK;YAAC;YAEtG,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA6B,GACtC;gBAAE,QAAQ;YAAI;QAElB;QAEA,iCAAiC;QACjC,IAAI,CAAC,kBAAkB,CAAC,OAAO,MAAM,CAAC,EAAE,SAAS,YAAY;YAC3D,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA2B,GACpC;gBAAE,QAAQ;YAAI;QAElB;QAEA,0BAA0B;QAC1B,OAAO,MAAM,GAAG;QAEhB,MAAM,mIAAE,CAAC,IAAI,CACX,IAAI,qKAAgB,CAAC;YACnB,QAAQ,uIAAM;YACd,KAAK;YACL,MAAM,KAAK,SAAS,CAAC,QAAQ,MAAM;YACnC,aAAa;QACf;QAGF,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM;QAAU;IACtD,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAiB,GAAG;YAAE,QAAQ;QAAI;IACtE;AACF","debugId":null}}]
}