module.exports = [
"[project]/.next-internal/server/app/api/google/gmailPoll/route/actions.js [app-rsc] (server actions loader, ecmascript)", ((__turbopack_context__, module, exports) => {

}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/action-async-storage.external.js [external] (next/dist/server/app-render/action-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/action-async-storage.external.js", () => require("next/dist/server/app-render/action-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/child_process [external] (child_process, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("child_process", () => require("child_process"));

module.exports = mod;
}),
"[externals]/fs [external] (fs, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/os [external] (os, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}),
"[externals]/events [external] (events, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}),
"[externals]/process [external] (process, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("process", () => require("process"));

module.exports = mod;
}),
"[externals]/util [external] (util, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}),
"[externals]/path [external] (path, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}),
"[externals]/crypto [external] (crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}),
"[externals]/querystring [external] (querystring, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("querystring", () => require("querystring"));

module.exports = mod;
}),
"[externals]/buffer [external] (buffer, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}),
"[externals]/http2 [external] (http2, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http2", () => require("http2"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/@aws-sdk/client-s3 [external] (@aws-sdk/client-s3, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("@aws-sdk/client-s3", () => require("@aws-sdk/client-s3"));

module.exports = mod;
}),
"[externals]/node:stream [external] (node:stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:stream", () => require("node:stream"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[project]/app/api/google/gmailPoll/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

// app/api/gmail-poll/route.ts
__turbopack_context__.s([
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$googleapis$2f$build$2f$src$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/googleapis/build/src/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/@aws-sdk/client-s3 [external] (@aws-sdk/client-s3, cjs)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$aws$2d$sdk$2f$s3$2d$request$2d$presigner$2f$dist$2d$es$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@aws-sdk/s3-request-presigner/dist-es/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$aws$2d$sdk$2f$s3$2d$request$2d$presigner$2f$dist$2d$es$2f$getSignedUrl$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@aws-sdk/s3-request-presigner/dist-es/getSignedUrl.js [app-route] (ecmascript)");
;
;
;
;
const s3 = new __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__["S3Client"]({
    region: process.env.REGION,
    credentials: {
        accessKeyId: process.env.ACCESS_KEY_ID,
        secretAccessKey: process.env.SECRET_ACCESS_KEY
    }
});
const BUCKET = process.env.BUCKET_NAME;
const FILE_KEY = "tokensGoogle.json";
const GRAPH_BASE = "https://graph.microsoft.com/v1.0";
// mapping catégorie -> plan/bucket Planner (IDs à mettre en env ou en dur)
const PLANS_BY_CATEGORY = {
    COMPTA: {
        planId: process.env.PLANNER_PLAN_COMPTA_ID || "PLAN_COMPTA_ID",
        bucketId: process.env.PLANNER_BUCKET_COMPTA_ID || "BUCKET_COMPTA_ID"
    },
    ADMIN: {
        planId: process.env.PLANNER_PLAN_ADMIN_ID || "PLAN_ADMIN_ID",
        bucketId: process.env.PLANNER_BUCKET_ADMIN_ID || "BUCKET_ADMIN_ID"
    },
    CPE: {
        planId: process.env.PLANNER_PLAN_CPE_ID || "PLAN_CPE_ID",
        bucketId: process.env.PLANNER_BUCKET_CPE_ID || "BUCKET_CPE_ID"
    },
    VIE_SCOLAIRE: {
        planId: process.env.PLANNER_PLAN_VIE_SCOLAIRE_ID || "PLAN_VIE_SCOLAIRE_ID",
        bucketId: process.env.PLANNER_BUCKET_VIE_SCOLAIRE_ID || "BUCKET_VIE_SCOLAIRE_ID"
    },
    DIRECTION: {
        planId: process.env.PLANNER_PLAN_DIRECTION_ID || "PLAN_DIRECTION_ID",
        bucketId: process.env.PLANNER_BUCKET_DIRECTION_ID || "BUCKET_DIRECTION_ID"
    }
};
async function readTokens() {
    try {
        const command = new __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__["GetObjectCommand"]({
            Bucket: BUCKET,
            Key: FILE_KEY
        });
        const url = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$aws$2d$sdk$2f$s3$2d$request$2d$presigner$2f$dist$2d$es$2f$getSignedUrl$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getSignedUrl"])(s3, command, {
            expiresIn: 60
        });
        const res = await fetch(url);
        if (!res.ok) return {};
        return await res.json();
    } catch (err) {
        console.error("Erreur lecture JSON S3 :", err);
        return {};
    }
}
async function callAIForRouting(from, subject, text) {
    const extractionPrompt = `
Tu es l'assistant d'un établissement scolaire.

À partir de l'email suivant, retourne un JSON STRICTEMENT de la forme :
{
  "category": "COMPTA | ADMIN | CPE | VIE_SCOLAIRE | DIRECTION",
  "summary": "résumé très court en une phrase"
}

Email :
De: ${from}
Sujet: ${subject}
Contenu: ${text}
`;
    const extractionResponse = await fetch("https://api.mistral.ai/v1/chat/completions", {
        method: "POST",
        headers: {
            Authorization: `Bearer ${process.env.MISTRAL_API_KEY}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            model: "mistral-medium",
            messages: [
                {
                    role: "user",
                    content: extractionPrompt
                }
            ],
            temperature: 0,
            response_format: {
                type: "json_object"
            }
        })
    });
    if (!extractionResponse.ok) {
        throw new Error(`Mistral error: ${extractionResponse.status}`);
    }
    const data = await extractionResponse.json();
    const content = data.choices[0].message.content;
    const parsed = JSON.parse(content);
    return {
        category: parsed.category,
        summary: parsed.summary
    };
}
// création de tâche Planner à partir d’un mail
async function createPlannerTaskFromEmail(params) {
    const { accessToken, planId, bucketId, subject, from, summary, text } = params;
    const title = `${subject}`.slice(0, 250);
    const description = `Mail de: ${from}\n\nRésumé IA:\n${summary}\n\nContenu:\n${text}`.slice(0, 8000);
    const taskRes = await fetch(`${GRAPH_BASE}/planner/tasks`, {
        method: "POST",
        headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            planId,
            bucketId,
            title
        })
    });
    if (!taskRes.ok) {
        const errText = await taskRes.text();
        console.error("Erreur création tâche Planner", errText);
        throw new Error("Erreur création tâche Planner");
    }
    const task = await taskRes.json();
    const taskId = task.id;
    const etag = task["@odata.etag"];
    if (etag) {
        const detailsRes = await fetch(`${GRAPH_BASE}/planner/tasks/${taskId}/details`, {
            method: "PATCH",
            headers: {
                Authorization: `Bearer ${accessToken}`,
                "Content-Type": "application/json",
                "If-Match": etag
            },
            body: JSON.stringify({
                description
            })
        });
        if (!detailsRes.ok) {
            const errText = await detailsRes.text();
            console.error("Erreur mise à jour détails Planner", errText);
        }
    }
    return {
        taskId
    };
}
async function POST(req) {
    try {
        const body = await req.json();
        const graphAccessToken = body.graphAccessToken;
        if (!graphAccessToken) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                ok: false,
                error: "graphAccessToken manquant"
            }, {
                status: 400
            });
        }
        const tokens = await readTokens();
        const email = process.env.GOOGLE_ACCOUNT_EMAIL;
        const userTokens = tokens[email];
        if (!userTokens?.refreshToken) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                ok: false,
                error: "Aucun refreshToken trouvé pour cet email"
            }, {
                status: 400
            });
        }
        const oAuth2Client = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$googleapis$2f$build$2f$src$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["google"].auth.OAuth2(process.env.GOOGLE_CLIENT_ID, process.env.GOOGLE_CLIENT_SECRET, process.env.GOOGLE_REDIRECT_URI);
        oAuth2Client.setCredentials({
            refresh_token: userTokens.refreshToken
        });
        const gmail = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$googleapis$2f$build$2f$src$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["google"].gmail({
            version: "v1",
            auth: oAuth2Client
        });
        const listRes = await gmail.users.messages.list({
            userId: "me",
            q: "is:unread",
            maxResults: 10
        });
        const messages = listRes.data.messages || [];
        const results = [];
        for (const msg of messages){
            if (!msg.id) continue;
            const full = await gmail.users.messages.get({
                userId: "me",
                id: msg.id,
                format: "FULL"
            });
            const payload = full.data.payload;
            const headers = payload?.headers || [];
            const from = headers.find((h)=>h.name === "From")?.value || "";
            const subject = headers.find((h)=>h.name === "Subject")?.value || "";
            let text = "";
            if (payload?.parts) {
                const part = payload.parts.find((p)=>p.mimeType === "text/plain");
                if (part?.body?.data) {
                    text = Buffer.from(part.body.data, "base64").toString("utf8");
                }
            } else if (payload?.body?.data) {
                text = Buffer.from(payload.body.data, "base64").toString("utf8");
            }
            const { category, summary } = await callAIForRouting(from, subject, text);
            const mapping = PLANS_BY_CATEGORY[category] ?? PLANS_BY_CATEGORY.ADMIN;
            try {
                await createPlannerTaskFromEmail({
                    accessToken: graphAccessToken,
                    planId: mapping.planId,
                    bucketId: mapping.bucketId,
                    subject,
                    from,
                    summary,
                    text
                });
            } catch (e) {
                console.error(`Erreur Planner pour le mail ${msg.id} (${subject})`, e);
            }
            await gmail.users.messages.modify({
                userId: "me",
                id: msg.id,
                requestBody: {
                    removeLabelIds: [
                        "UNREAD"
                    ]
                }
            });
            results.push({
                id: msg.id,
                from,
                subject,
                category,
                summary
            });
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            ok: true,
            count: results.length,
            emails: results
        });
    } catch (error) {
        console.error(error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            ok: false,
            error: error.message || "Error while polling Gmail"
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__0c8f3578._.js.map