{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/api/move-file/route.ts"],"sourcesContent":["// app/api/move-file-onedrive/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport { getAuth } from \"@clerk/nextjs/server\";\r\n\r\nconst GRAPH_BASE = \"https://graph.microsoft.com/v1.0\";\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const { userId } = getAuth(req as any);\r\n    if (!userId) {\r\n      return NextResponse.json({ error: \"Non autorisé\" }, { status: 401 });\r\n    }\r\n    const body = await req.json();\r\n    const {\r\n      accessToken,\r\n      sourcePath,\r\n      targetFolderPath,\r\n      newFileName,\r\n    } = body as {\r\n      accessToken: string;\r\n      sourcePath: string;  \r\n      targetFolderPath: string; \r\n      newFileName?: string; \r\n    };\r\n    if (!accessToken) {\r\n      return NextResponse.json({ error: \"accessToken manquant\" },{ status: 400 });\r\n    }\r\n    if (!sourcePath || !targetFolderPath) {\r\n      return NextResponse.json({ error: \"sourcePath et targetFolderPath sont requis\" },{ status: 400 });\r\n    }\r\n    const sourceRes = await fetch(\r\n      `${GRAPH_BASE}/me/drive/root:/${sourcePath}:`,\r\n      {\r\n        headers: { Authorization: `Bearer ${accessToken}` },\r\n      }\r\n    );\r\n    if (!sourceRes.ok) {\r\n      const errText = await sourceRes.text();\r\n      return NextResponse.json({ error: \"Erreur récupération fichier source\", details: errText },{ status: sourceRes.status });\r\n    }\r\n    const sourceItem = await sourceRes.json();\r\n    const sourceItemId = sourceItem.id as string | undefined;\r\n    const driveId = sourceItem.parentReference?.driveId as | string | undefined;\r\n    if (!sourceItemId || !driveId) {\r\n      return NextResponse.json({ error: \"Impossible de récupérer l'ID du fichier source ou du drive\" },{ status: 500 });\r\n    }\r\n    const targetFolderRes = await fetch(\r\n      `${GRAPH_BASE}/me/drive/root:/${targetFolderPath}:`,\r\n      {\r\n        headers: { Authorization: `Bearer ${accessToken}` },\r\n      }\r\n    );\r\n    if (!targetFolderRes.ok) {\r\n      const errText = await targetFolderRes.text();\r\n      return NextResponse.json({ error: \"Erreur récupération dossier cible\", details: errText },{ status: targetFolderRes.status });\r\n    }\r\n    const targetFolder = await targetFolderRes.json();\r\n    const targetFolderId = targetFolder.id as string | undefined;\r\n    if (!targetFolderId) {\r\n      return NextResponse.json({ error: \"Impossible de récupérer l'ID du dossier cible\" },{ status: 500 });\r\n    }\r\n    const finalFileName =\r\n      newFileName && newFileName.trim().length > 0  ? newFileName.trim() : (sourceItem.name as string);\r\n    const childrenRes = await fetch(`${GRAPH_BASE}/drives/${driveId}/items/${targetFolderId}/children`,\r\n      {\r\n        headers: { Authorization: `Bearer ${accessToken}` },\r\n      }\r\n    );\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    let children: any[] = [];\r\n    if (childrenRes.ok) {\r\n      const childrenJson = await childrenRes.json();\r\n      children = childrenJson.value || [];\r\n    }\r\n    const dotIndex = finalFileName.lastIndexOf(\".\");\r\n    const base = dotIndex > 0 ? finalFileName.slice(0, dotIndex) : finalFileName;\r\n    const ext = dotIndex > 0 ? finalFileName.slice(dotIndex) : \"\";\r\n    let safeName = finalFileName;\r\n    let suffix = 2;\r\n    while (children.some((c) => c.name === safeName)) {\r\n      safeName = `${base} (${suffix})${ext}`;\r\n      suffix++;\r\n    }\r\n    const moveRes = await fetch(`${GRAPH_BASE}/drives/${driveId}/items/${sourceItemId}`,\r\n      {\r\n        method: \"PATCH\",\r\n        headers: {\r\n          Authorization: `Bearer ${accessToken}`,\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({\r\n          parentReference: { id: targetFolderId },\r\n          name: safeName,\r\n        }),\r\n      }\r\n    );\r\n    if (!moveRes.ok) {\r\n      const errText = await moveRes.text();\r\n      return NextResponse.json({ error: \"Erreur lors du déplacement du fichier\", details: errText },{ status: moveRes.status });\r\n    }\r\n    const movedItem = await moveRes.json();\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: \"Fichier déplacé vers le dossier cible\",\r\n      itemId: movedItem.id,\r\n      finalFileName: safeName,\r\n      targetFolderId,\r\n    });\r\n  } catch (error) {\r\n    return NextResponse.json({ error: String(error) }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}