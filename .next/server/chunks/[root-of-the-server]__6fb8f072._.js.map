{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/api/analyze-doc/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { getAuth } from '@clerk/nextjs/server';\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const { userId } = getAuth(req as any);\r\n    if (!userId)\r\n      return NextResponse.json({ error: 'Non autorisé' }, { status: 401 });\r\n    const { text } = await req.json();\r\n    if (!text)\r\n      return NextResponse.json({ error: 'text requis' }, { status: 400 });\r\n    const prompt = `\r\n      Voici le texte d’un document scolaire. Peux-tu me dire le type de document et à quel élève il appartient (nom/prénom/ID s’il est présent) ?\r\n      ---\r\n      ${text}\r\n      ---\r\n      Réponds sous la forme : { \"type\": \"...\", \"eleve\": \"...\" }\r\n    `;\r\n    const mistralResponse = await fetch('https://api.mistral.ai/v1/chat/completions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${process.env.MISTRAL_API_KEY}`,\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify({\r\n        model: \"mistral-medium\",\r\n        messages: [{ role: \"user\", content: prompt }],\r\n        temperature: 0\r\n      })\r\n    });\r\n    if (!mistralResponse.ok) {\r\n      const err = await mistralResponse.text();\r\n      return NextResponse.json({ error: `Erreur Mistral: ${err}` }, { status: mistralResponse.status });\r\n    }\r\n    const mistralData = await mistralResponse.json();\r\n    const result = mistralData.choices?.[0]?.message?.content || '';\r\n    let cleaned = result.trim();\r\n    cleaned = cleaned.replace(/```json/i, \"\")\r\n                     .replace(/```/g, \"\")\r\n                     .trim();\r\n    const match = cleaned.match(/\\{[\\s\\S]*\\}/);\r\n    if (!match) {\r\n      return NextResponse.json({\r\n        error: \"Impossible d'extraire du JSON\",\r\n        brut: result,\r\n        extrait: cleaned\r\n      }, { status: 500 });\r\n    }\r\n    let jsonString = match[0];\r\n    try {\r\n      return NextResponse.json(JSON.parse(jsonString));\r\n    } catch {\r\n      return NextResponse.json({ error: \"Mistral n'a pas retourné un JSON valide après extraction\", brut: result, extrait: jsonString }, { status: 500 });\r\n    }\r\n  } catch (error) {\r\n    console.error('Erreur analyse Mistral:', error);\r\n    return NextResponse.json({ error: String(error) }, { status: 500 });\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,8DAA8D;QAC9D,MAAM,EAAE,MAAM,EAAE,GAAG,IAAA,wLAAO,EAAC;QAC3B,IAAI,CAAC,QACH,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;QACpE,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,IAAI,IAAI;QAC/B,IAAI,CAAC,MACH,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAc,GAAG;YAAE,QAAQ;QAAI;QACnE,MAAM,SAAS,CAAC;;;MAGd,EAAE,KAAK;;;IAGT,CAAC;QACD,MAAM,kBAAkB,MAAM,MAAM,8CAA8C;YAChF,QAAQ;YACR,SAAS;gBACP,iBAAiB,CAAC,OAAO,EAAE,QAAQ,GAAG,CAAC,eAAe,EAAE;gBACxD,gBAAgB;YAClB;YACA,MAAM,KAAK,SAAS,CAAC;gBACnB,OAAO;gBACP,UAAU;oBAAC;wBAAE,MAAM;wBAAQ,SAAS;oBAAO;iBAAE;gBAC7C,aAAa;YACf;QACF;QACA,IAAI,CAAC,gBAAgB,EAAE,EAAE;YACvB,MAAM,MAAM,MAAM,gBAAgB,IAAI;YACtC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,CAAC,gBAAgB,EAAE,KAAK;YAAC,GAAG;gBAAE,QAAQ,gBAAgB,MAAM;YAAC;QACjG;QACA,MAAM,cAAc,MAAM,gBAAgB,IAAI;QAC9C,MAAM,SAAS,YAAY,OAAO,EAAE,CAAC,EAAE,EAAE,SAAS,WAAW;QAC7D,IAAI,UAAU,OAAO,IAAI;QACzB,UAAU,QAAQ,OAAO,CAAC,YAAY,IACpB,OAAO,CAAC,QAAQ,IAChB,IAAI;QACtB,MAAM,QAAQ,QAAQ,KAAK,CAAC;QAC5B,IAAI,CAAC,OAAO;YACV,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;gBACP,MAAM;gBACN,SAAS;YACX,GAAG;gBAAE,QAAQ;YAAI;QACnB;QACA,IAAI,aAAa,KAAK,CAAC,EAAE;QACzB,IAAI;YACF,OAAO,gJAAY,CAAC,IAAI,CAAC,KAAK,KAAK,CAAC;QACtC,EAAE,OAAM;YACN,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;gBAA4D,MAAM;gBAAQ,SAAS;YAAW,GAAG;gBAAE,QAAQ;YAAI;QACnJ;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,OAAO;QAAO,GAAG;YAAE,QAAQ;QAAI;IACnE;AACF","debugId":null}}]
}