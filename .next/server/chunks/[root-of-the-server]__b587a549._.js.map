{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 181, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/utils/voyageStore.ts"],"sourcesContent":["// app/utils/voyageStore.ts\r\nimport {\r\n  S3Client,\r\n  GetObjectCommand,\r\n  PutObjectCommand,\r\n  ListObjectsV2Command,\r\n} from \"@aws-sdk/client-s3\";\r\nimport { getSignedUrl } from \"@aws-sdk/s3-request-presigner\";\r\nimport { currentUser } from \"@clerk/nextjs/server\";\r\nimport { v4 as uuidv4 } from \"uuid\";\r\n\r\nexport const s3 = new S3Client({\r\n  region: \"eu-west-3\",\r\n  credentials: {\r\n    accessKeyId: process.env.ACCESS_KEY_ID!,\r\n    secretAccessKey: process.env.SECRET_ACCESS_KEY!,\r\n  },\r\n});\r\n\r\nexport const BUCKET = process.env.BUCKET_NAME!;\r\n\r\nexport type VoyagePieceJointe = {\r\n  filename: string;\r\n  url: string;\r\n  type: string;\r\n};\r\n\r\nexport type VoyageStatus =\r\n  | \"draft\"\r\n  | \"direction_validation\"\r\n  | \"requests_stage\"\r\n  | \"compta_validation\"\r\n  | \"final_validation\"\r\n  | \"validated\"\r\n  | \"rejected\";\r\n\r\nexport type VoyageEntry = {\r\n  id: string;\r\n  prenom: string;\r\n  nom: string;\r\n  email: string;\r\n  direction_cible: string;\r\n  date_depart: string;\r\n  date_retour: string;\r\n  lieu: string;\r\n  activite: string;\r\n  classes: string;\r\n  effectif_eleves: number;\r\n  effectif_accompagnateurs: number;\r\n  commentaire?: string;\r\n  pieces_jointes?: VoyagePieceJointe[] | null;\r\n  date_declaration: string;\r\n  status: VoyageStatus;\r\n};\r\n\r\nexport async function saveVoyage(userId: string, voyage: VoyageEntry) {\r\n  const key = `travels/${userId}/${voyage.id}/voyage.json`;\r\n  await s3.send(\r\n    new PutObjectCommand({\r\n      Bucket: BUCKET,\r\n      Key: key,\r\n      Body: JSON.stringify(voyage, null, 2),\r\n      ContentType: \"application/json\",\r\n    })\r\n  );\r\n  return key;\r\n}\r\n\r\nexport async function listVoyages(userId: string) {\r\n  const res = await s3.send(\r\n    new ListObjectsV2Command({\r\n      Bucket: BUCKET,\r\n      Prefix: `travels/${userId}/`,\r\n    })\r\n  );\r\n  return (res.Contents || []).filter((obj) => obj.Key?.endsWith(\"voyage.json\"));\r\n}\r\n\r\nexport async function getVoyage(userId: string, voyageId: string) {\r\n  const key = `travels/${userId}/${voyageId}/voyage.json`;\r\n  const obj = await s3.send(new GetObjectCommand({ Bucket: BUCKET, Key: key }));\r\n  const body = await obj.Body?.transformToString();\r\n  return JSON.parse(body!);\r\n}\r\n\r\nexport async function getPresignedUploadUrl(\r\n  voyageId: string,\r\n  filename: string,\r\n  type: string\r\n): Promise<{ uploadUrl: string; fileUrl: string; key: string }> {\r\n  const user = await currentUser();\r\n  if (!user) throw new Error(\"Utilisateur non authentifié\");\r\n\r\n  const key = `travels/${user.id}/${voyageId}/${filename}`;\r\n  const command = new PutObjectCommand({\r\n    Bucket: BUCKET,\r\n    Key: key,\r\n    ContentType: type,\r\n  });\r\n  const uploadUrl = await getSignedUrl(s3, command, { expiresIn: 3600 });\r\n  const fileUrl = `https://${BUCKET}.s3.eu-west-3.amazonaws.com/${key}`;\r\n  return { uploadUrl, fileUrl, key };\r\n}\r\n"],"names":[],"mappings":"AAAA,2BAA2B;;;;;;;;;;;;;;;AAC3B;AAMA;AAAA;AACA;;;;AAGO,MAAM,KAAK,IAAI,6JAAQ,CAAC;IAC7B,QAAQ;IACR,aAAa;QACX,aAAa,QAAQ,GAAG,CAAC,aAAa;QACtC,iBAAiB,QAAQ,GAAG,CAAC,iBAAiB;IAChD;AACF;AAEO,MAAM,SAAS,QAAQ,GAAG,CAAC,WAAW;AAoCtC,eAAe,WAAW,MAAc,EAAE,MAAmB;IAClE,MAAM,MAAM,CAAC,QAAQ,EAAE,OAAO,CAAC,EAAE,OAAO,EAAE,CAAC,YAAY,CAAC;IACxD,MAAM,GAAG,IAAI,CACX,IAAI,qKAAgB,CAAC;QACnB,QAAQ;QACR,KAAK;QACL,MAAM,KAAK,SAAS,CAAC,QAAQ,MAAM;QACnC,aAAa;IACf;IAEF,OAAO;AACT;AAEO,eAAe,YAAY,MAAc;IAC9C,MAAM,MAAM,MAAM,GAAG,IAAI,CACvB,IAAI,yKAAoB,CAAC;QACvB,QAAQ;QACR,QAAQ,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;IAC9B;IAEF,OAAO,CAAC,IAAI,QAAQ,IAAI,EAAE,EAAE,MAAM,CAAC,CAAC,MAAQ,IAAI,GAAG,EAAE,SAAS;AAChE;AAEO,eAAe,UAAU,MAAc,EAAE,QAAgB;IAC9D,MAAM,MAAM,CAAC,QAAQ,EAAE,OAAO,CAAC,EAAE,SAAS,YAAY,CAAC;IACvD,MAAM,MAAM,MAAM,GAAG,IAAI,CAAC,IAAI,qKAAgB,CAAC;QAAE,QAAQ;QAAQ,KAAK;IAAI;IAC1E,MAAM,OAAO,MAAM,IAAI,IAAI,EAAE;IAC7B,OAAO,KAAK,KAAK,CAAC;AACpB;AAEO,eAAe,sBACpB,QAAgB,EAChB,QAAgB,EAChB,IAAY;IAEZ,MAAM,OAAO,MAAM,IAAA,2MAAW;IAC9B,IAAI,CAAC,MAAM,MAAM,IAAI,MAAM;IAE3B,MAAM,MAAM,CAAC,QAAQ,EAAE,KAAK,EAAE,CAAC,CAAC,EAAE,SAAS,CAAC,EAAE,UAAU;IACxD,MAAM,UAAU,IAAI,qKAAgB,CAAC;QACnC,QAAQ;QACR,KAAK;QACL,aAAa;IACf;IACA,MAAM,YAAY,MAAM,IAAA,0MAAY,EAAC,IAAI,SAAS;QAAE,WAAW;IAAK;IACpE,MAAM,UAAU,CAAC,QAAQ,EAAE,OAAO,4BAA4B,EAAE,KAAK;IACrE,OAAO;QAAE;QAAW;QAAS;IAAI;AACnC","debugId":null}},
    {"offset": {"line": 260, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/api/travels/devis/request/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport crypto from \"crypto\";\r\nimport nodemailer from \"nodemailer\";\r\nimport { ListObjectsV2Command, GetObjectCommand, PutObjectCommand } from \"@aws-sdk/client-s3\";\r\nimport { s3, BUCKET } from \"@/app/utils/voyageStore\";\r\nimport { currentUser } from \"@clerk/nextjs/server\";\r\n\r\nconst TRANSPORTEURS = [\r\n  { id: \"t1\", nom: \"Voyages Martin\", email: \"flojfk+transport1@gmail.com\" },\r\n  { id: \"t2\", nom: \"Autocars Dupont\", email: \"flojfk+transport2@gmail.com\" },\r\n  { id: \"t3\", nom: \"Keolis Nantes\", email: \"flojfk+transport3@gmail.com\" },\r\n];\r\n\r\nconst transporter = nodemailer.createTransport({\r\n  service: \"gmail\",\r\n  auth: {\r\n    user: process.env.SMTP_USER,\r\n    pass: process.env.SMTP_PASS,\r\n  },\r\n});\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const user = await currentUser();\r\n    if (!user) return NextResponse.json({ error: \"Non authentifié\" }, { status: 401 });\r\n    const body = await req.json();\r\n    const { voyageId, infos, heureDepart, carSurPlace, commentaire } = body;\r\n    if (!voyageId) return NextResponse.json({ error: \"voyageId manquant\" }, { status: 400 });\r\n    const list = await s3.send(new ListObjectsV2Command({ Bucket: BUCKET, Prefix: \"travels/\" }));\r\n    let voyageKey: string | null = null;\r\n    for (const obj of list.Contents || []) {\r\n      if (!obj.Key?.endsWith(\"voyage.json\")) continue;\r\n      const data = await s3.send(new GetObjectCommand({ Bucket: BUCKET, Key: obj.Key }));\r\n      const bodyStr = await data.Body?.transformToString();\r\n      if (!bodyStr) continue;\r\n      const voyage = JSON.parse(bodyStr);\r\n      if (voyage.id === voyageId) {\r\n        voyageKey = obj.Key;\r\n        break;\r\n      }\r\n    }\r\n    if (!voyageKey) return NextResponse.json({ error: \"Voyage introuvable\" }, { status: 404 });\r\n\r\n    const obj = await s3.send(new GetObjectCommand({ Bucket: BUCKET, Key: voyageKey }));\r\n    const voyage = JSON.parse(await obj.Body?.transformToString() || \"{}\");\r\n\r\n    voyage.prof_form = {\r\n      heureDepart: heureDepart || \"\",\r\n      carSurPlace: carSurPlace || false,\r\n      commentaire: commentaire || \"\",\r\n      date: new Date().toISOString(),\r\n    };\r\n\r\n    // On prépare les requests pour chaque transporteur avec token\r\n    const requests = TRANSPORTEURS.map((t) => {\r\n      const token = crypto.randomBytes(12).toString(\"hex\");\r\n      const fileKey = `${voyageKey.replace(\"voyage.json\", \"\")}devis/${t.id}/devis.pdf`;\r\n      const baseUrl = process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\";\r\n      const frontUrl = `${baseUrl}/travels/depot-devis?voyageId=${voyageId}&transporteurId=${t.id}&token=${token}`;\r\n      return { transporteur: t, token, fileKey, frontUrl };\r\n    });\r\n\r\n    voyage.devis_requests = requests.map((r) => ({\r\n      id: r.transporteur.id,\r\n      nom: r.transporteur.nom,\r\n      email: r.transporteur.email,\r\n      token: r.token,\r\n      frontUrl: r.frontUrl,\r\n      fileKey: r.fileKey,\r\n      status: \"pending\",\r\n      infos,\r\n      date: new Date().toISOString(),\r\n    }));\r\n\r\n    // On sauvegarde le JSON du voyage mis à jour\r\n    await s3.send(\r\n      new PutObjectCommand({\r\n        Bucket: BUCKET,\r\n        Key: voyageKey,\r\n        Body: JSON.stringify(voyage, null, 2),\r\n        ContentType: \"application/json\",\r\n      })\r\n    );\r\n\r\n    // Envoi du mail avec lien vers le front (pas presigned URL)\r\n    for (const r of requests) {\r\n      await transporter.sendMail({\r\n        from: `\"École\" <${process.env.SMTP_USER}>`,\r\n        to: r.transporteur.email,\r\n        subject: `[Demande de devis bus] Voyage scolaire \"${voyage.lieu}\"`,\r\n        text: `Bonjour ${r.transporteur.nom},\r\n\r\nL’établissement vous invite à déposer un devis pour le voyage \"${voyage.lieu}\" (${voyage.date_depart} → ${voyage.date_retour}).\r\n\r\nDétails du voyage :\r\n- Heure de départ : ${voyage.prof_form.heureDepart || \"non précisée\"}\r\n- Car sur place : ${voyage.prof_form.carSurPlace ? \"Oui\" : \"Non\"}\r\n- Commentaire prof : ${voyage.prof_form.commentaire || \"(aucune précision)\"}\r\n\r\nDétails supplémentaires :\r\n${infos || \"(aucune précision fournie)\"}\r\n\r\n➡️ Cliquez sur le lien suivant pour déposer votre devis :\r\n${r.frontUrl}\r\n\r\nMerci de votre retour,\r\nCordialement,\r\nL’équipe`,\r\n      });\r\n    }\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: \"Mini-formulaire ajouté et demandes de devis envoyées aux transporteurs.\",\r\n      requests,\r\n    });\r\n  } catch (err: any) {\r\n    console.error(\"Erreur demande devis :\", err);\r\n    return NextResponse.json({ error: err.message || \"Erreur interne\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}