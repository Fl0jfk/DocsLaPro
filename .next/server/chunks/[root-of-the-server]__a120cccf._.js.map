{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 121, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/utils/voyageStore.ts"],"sourcesContent":["// app/utils/voyageStore.ts\r\nimport { S3Client, GetObjectCommand, PutObjectCommand } from \"@aws-sdk/client-s3\";\r\nimport { getSignedUrl } from \"@aws-sdk/s3-request-presigner\";\r\n\r\nexport const s3 = new S3Client({\r\n  region: \"eu-west-3\",\r\n  credentials: {\r\n    accessKeyId: process.env.ACCESS_KEY_ID!,\r\n    secretAccessKey: process.env.SECRET_ACCESS_KEY!,\r\n  },\r\n});\r\nexport const BUCKET = process.env.BUCKET_NAME!;\r\nconst KEY = \"voyages.json\";\r\n\r\nexport type PieceJointe = {\r\n  filename: string;\r\n  s3Key: string;\r\n  type: string;\r\n};\r\n\r\nexport type VoyageEntry = {\r\n  id: string;\r\n  prenom: string;\r\n  nom: string;\r\n  email: string;\r\n  direction_cible: \"direction_ecole\" | \"direction_college\" | \"direction_lycee\";\r\n  type_activite: \"voyage\" | \"sortie\" | \"autre\";\r\n  destination: string;\r\n  objectifs: string;\r\n  date_depart: string;\r\n  date_retour: string;\r\n  effectif_eleves: number;\r\n  effectif_accompagnateurs: number;\r\n  pieces_jointes?: PieceJointe[];\r\n  etat: \"etape_1\" | \"etape_2\" | \"etape_3\" | \"refuse\" | \"valide\";\r\n  date_creation: string;\r\n  historique: { action: string; date: string; par: string }[];\r\n};\r\n\r\n// 📦 Lecture S3\r\nexport async function readVoyages(): Promise<VoyageEntry[]> {\r\n  try {\r\n    const obj = await s3.send(new GetObjectCommand({ Bucket: BUCKET, Key: KEY }));\r\n    const body = await obj.Body?.transformToString();\r\n    return body ? JSON.parse(body) : [];\r\n  } catch (err: any) {\r\n    if (err.$metadata?.httpStatusCode === 404) return [];\r\n    throw err;\r\n  }\r\n}\r\n\r\n// 💾 Écriture S3\r\nexport async function writeVoyages(entries: VoyageEntry[]) {\r\n  await s3.send(new PutObjectCommand({\r\n    Bucket: BUCKET,\r\n    Key: KEY,\r\n    Body: JSON.stringify(entries, null, 2),\r\n    ContentType: \"application/json\",\r\n  }));\r\n}\r\n\r\n// ➕ Ajouter un voyage\r\nexport async function addVoyage(entry: VoyageEntry) {\r\n  const voyages = await readVoyages();\r\n  voyages.push(entry);\r\n  await writeVoyages(voyages);\r\n}\r\n\r\n// ❌ Supprimer un voyage\r\nexport async function removeVoyage(id: string) {\r\n  const voyages = await readVoyages();\r\n  const filtered = voyages.filter(v => v.id !== id);\r\n  await writeVoyages(filtered);\r\n}\r\n\r\n// 🔑 URL pré-signée upload\r\nexport async function getUploadURL(filename: string): Promise<{ url: string; key: string }> {\r\n  const key = `voyages_files/${Date.now()}_${filename}`;\r\n  const command = new PutObjectCommand({ Bucket: BUCKET, Key: key });\r\n  const url = await getSignedUrl(s3, command, { expiresIn: 3600 });\r\n  return { url, key };\r\n}\r\n\r\n// 🔑 URL pré-signée download\r\nexport async function getDownloadURL(key: string): Promise<string> {\r\n  const command = new GetObjectCommand({ Bucket: BUCKET, Key: key });\r\n  return await getSignedUrl(s3, command, { expiresIn: 3600 });\r\n}\r\n"],"names":[],"mappings":"AAAA,2BAA2B;;;;;;;;;;;;;;;;;;;AAC3B;AACA;AAAA;;;AAEO,MAAM,KAAK,IAAI,6JAAQ,CAAC;IAC7B,QAAQ;IACR,aAAa;QACX,aAAa,QAAQ,GAAG,CAAC,aAAa;QACtC,iBAAiB,QAAQ,GAAG,CAAC,iBAAiB;IAChD;AACF;AACO,MAAM,SAAS,QAAQ,GAAG,CAAC,WAAW;AAC7C,MAAM,MAAM;AA4BL,eAAe;IACpB,IAAI;QACF,MAAM,MAAM,MAAM,GAAG,IAAI,CAAC,IAAI,qKAAgB,CAAC;YAAE,QAAQ;YAAQ,KAAK;QAAI;QAC1E,MAAM,OAAO,MAAM,IAAI,IAAI,EAAE;QAC7B,OAAO,OAAO,KAAK,KAAK,CAAC,QAAQ,EAAE;IACrC,EAAE,OAAO,KAAU;QACjB,IAAI,IAAI,SAAS,EAAE,mBAAmB,KAAK,OAAO,EAAE;QACpD,MAAM;IACR;AACF;AAGO,eAAe,aAAa,OAAsB;IACvD,MAAM,GAAG,IAAI,CAAC,IAAI,qKAAgB,CAAC;QACjC,QAAQ;QACR,KAAK;QACL,MAAM,KAAK,SAAS,CAAC,SAAS,MAAM;QACpC,aAAa;IACf;AACF;AAGO,eAAe,UAAU,KAAkB;IAChD,MAAM,UAAU,MAAM;IACtB,QAAQ,IAAI,CAAC;IACb,MAAM,aAAa;AACrB;AAGO,eAAe,aAAa,EAAU;IAC3C,MAAM,UAAU,MAAM;IACtB,MAAM,WAAW,QAAQ,MAAM,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;IAC9C,MAAM,aAAa;AACrB;AAGO,eAAe,aAAa,QAAgB;IACjD,MAAM,MAAM,CAAC,cAAc,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,UAAU;IACrD,MAAM,UAAU,IAAI,qKAAgB,CAAC;QAAE,QAAQ;QAAQ,KAAK;IAAI;IAChE,MAAM,MAAM,MAAM,IAAA,0MAAY,EAAC,IAAI,SAAS;QAAE,WAAW;IAAK;IAC9D,OAAO;QAAE;QAAK;IAAI;AACpB;AAGO,eAAe,eAAe,GAAW;IAC9C,MAAM,UAAU,IAAI,qKAAgB,CAAC;QAAE,QAAQ;QAAQ,KAAK;IAAI;IAChE,OAAO,MAAM,IAAA,0MAAY,EAAC,IAAI,SAAS;QAAE,WAAW;IAAK;AAC3D","debugId":null}},
    {"offset": {"line": 260, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/api/travels/create/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { addVoyage, VoyageEntry } from \"@/app/utils/voyageStore\";\r\nimport { v4 as uuidv4 } from \"uuid\";\r\nimport nodemailer from \"nodemailer\";\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const data = await req.json();\r\n    const {\r\n      prenom,\r\n      nom,\r\n      email,\r\n      direction_cible,\r\n      type_activite,\r\n      destination,\r\n      objectifs,\r\n      date_depart,\r\n      date_retour,\r\n      effectif_eleves,\r\n      effectif_accompagnateurs,\r\n      pieces_jointes\r\n    } = data;\r\n\r\n    const voyage: VoyageEntry = {\r\n      id: uuidv4(),\r\n      prenom,\r\n      nom,\r\n      email,\r\n      direction_cible,\r\n      type_activite,\r\n      destination,\r\n      objectifs,\r\n      date_depart,\r\n      date_retour,\r\n      effectif_eleves,\r\n      effectif_accompagnateurs,\r\n      pieces_jointes,\r\n      etat: \"etape_1\",\r\n      date_creation: new Date().toISOString(),\r\n      historique: [{ action: \"création\", date: new Date().toISOString(), par: prenom }],\r\n    };\r\n\r\n    await addVoyage(voyage);\r\n    const transporter = nodemailer.createTransport({\r\n      host: \"smtp.gmail.com\",\r\n      port: 465,\r\n      secure: true,\r\n      auth: { \r\n        user: process.env.SMTP_USER,\r\n        pass: process.env.SMTP_PASS\r\n      },\r\n    });\r\n    const directionMailMap: Record<string, string> = {\r\n      direction_ecole: \"florian@h-me.fr\",\r\n      direction_college: \"direction_college@example.com\",\r\n      direction_lycee: \"direction_lycee@example.com\",\r\n    };\r\n\r\n    const to = directionMailMap[direction_cible] || \"direction_ecole@example.com\";\r\n\r\n    await transporter.sendMail({\r\n      from: process.env.SMTP_USER,\r\n      to,\r\n      subject: `[Voyage] Nouvelle demande par ${prenom} ${nom}`,\r\n      text: `\r\n            Bonjour,\r\n\r\n            Une nouvelle demande de ${type_activite} a été créée par ${prenom} ${nom}.\r\n\r\n            Destination : ${destination}\r\n            Objectifs pédagogiques : ${objectifs}\r\n            Dates : ${date_depart} → ${date_retour}\r\n            Nombre d'élèves : ${effectif_eleves}\r\n            Nombre d'accompagnateurs : ${effectif_accompagnateurs}\r\n\r\n            Merci de vous connecter pour valider la demande.\r\n          `\r\n    });\r\n\r\n    return NextResponse.json({ success: true, voyage });\r\n  } catch (err) {\r\n    return NextResponse.json({ error: err instanceof Error ? err.message : \"Erreur serveur\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EACJ,MAAM,EACN,GAAG,EACH,KAAK,EACL,eAAe,EACf,aAAa,EACb,WAAW,EACX,SAAS,EACT,WAAW,EACX,WAAW,EACX,eAAe,EACf,wBAAwB,EACxB,cAAc,EACf,GAAG;QAEJ,MAAM,SAAsB;YAC1B,IAAI,IAAA,0LAAM;YACV;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA,MAAM;YACN,eAAe,IAAI,OAAO,WAAW;YACrC,YAAY;gBAAC;oBAAE,QAAQ;oBAAY,MAAM,IAAI,OAAO,WAAW;oBAAI,KAAK;gBAAO;aAAE;QACnF;QAEA,MAAM,IAAA,0IAAS,EAAC;QAChB,MAAM,cAAc,4JAAU,CAAC,eAAe,CAAC;YAC7C,MAAM;YACN,MAAM;YACN,QAAQ;YACR,MAAM;gBACJ,MAAM,QAAQ,GAAG,CAAC,SAAS;gBAC3B,MAAM,QAAQ,GAAG,CAAC,SAAS;YAC7B;QACF;QACA,MAAM,mBAA2C;YAC/C,iBAAiB;YACjB,mBAAmB;YACnB,iBAAiB;QACnB;QAEA,MAAM,KAAK,gBAAgB,CAAC,gBAAgB,IAAI;QAEhD,MAAM,YAAY,QAAQ,CAAC;YACzB,MAAM,QAAQ,GAAG,CAAC,SAAS;YAC3B;YACA,SAAS,CAAC,8BAA8B,EAAE,OAAO,CAAC,EAAE,KAAK;YACzD,MAAM,CAAC;;;oCAGuB,EAAE,cAAc,iBAAiB,EAAE,OAAO,CAAC,EAAE,IAAI;;0BAE3D,EAAE,YAAY;qCACH,EAAE,UAAU;oBAC7B,EAAE,YAAY,GAAG,EAAE,YAAY;8BACrB,EAAE,gBAAgB;uCACT,EAAE,yBAAyB;;;UAGxD,CAAC;QACP;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM;QAAO;IACnD,EAAE,OAAO,KAAK;QACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,eAAe,QAAQ,IAAI,OAAO,GAAG;QAAiB,GAAG;YAAE,QAAQ;QAAI;IAC3G;AACF","debugId":null}}]
}