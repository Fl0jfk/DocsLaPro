{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/api/match-eleve/route.ts"],"sourcesContent":["// app/api/match-eleve/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport type { NextRequest } from \"next/server\";\r\nimport { S3Client, GetObjectCommand } from \"@aws-sdk/client-s3\";\r\n\r\nconst s3 = new S3Client({\r\n  region: process.env.REGION,\r\n  credentials: {\r\n    accessKeyId: process.env.ACCESS_KEY_ID || \"\",\r\n    secretAccessKey: process.env.SECRET_ACCESS_KEY || \"\",\r\n  },\r\n});\r\n\r\nconst BUCKET = process.env.BUCKET_NAME!;\r\nconst KEY = \"eleves.json\";\r\n\r\ntype EleveConfig = {\r\n  ine: string;\r\n  nom: string;\r\n  prenom: string;\r\n  folderName: string;\r\n};\r\n\r\nasync function getElevesFromS3(): Promise<EleveConfig[]> {\r\n  const res = await s3.send(\r\n    new GetObjectCommand({\r\n      Bucket: BUCKET,\r\n      Key: KEY,\r\n    })\r\n  );\r\n  const body = await res.Body?.transformToString(\"utf-8\");\r\n  if (!body) return [];\r\n  return JSON.parse(body) as EleveConfig[];\r\n}\r\nfunction normalize(str: string): string {\r\n  return str\r\n    .normalize(\"NFD\")\r\n    .replace(/[\\u0300-\\u036f]/g, \"\")\r\n    .toLowerCase()\r\n    .replace(/[-\\s]+/g, \" \")\r\n    .trim();\r\n}\r\nfunction nameSimilarity(\r\n  aNom: string,\r\n  aPrenom: string,\r\n  bNom: string,\r\n  bPrenom: string\r\n): number {\r\n  const an = normalize(aNom);\r\n  const ap = normalize(aPrenom);\r\n  const bn = normalize(bNom);\r\n  const bp = normalize(bPrenom);\r\n  let score = 0;\r\n  if (an && bn && (an === bn || bn.includes(an) || an.includes(bn))) score += 2;\r\n  if (ap && bp && (ap === bp || bp.includes(ap) || ap.includes(bp))) score += 2;\r\n  return score;\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const { clerkUserId, ine, nom, prénom, texteDocument } =\r\n      (await req.json()) as {\r\n        clerkUserId?: string;\r\n        ine?: string;\r\n        nom?: string;\r\n        prénom?: string;\r\n        texteDocument?: string;\r\n      };\r\n    if (!clerkUserId) { return NextResponse.json({ error: \"Non autorisé\" }, { status: 401 })}\r\n    const eleves = await getElevesFromS3();\r\n    if (ine && ine !== \"non_trouvé\") {\r\n      const ineTrim = ine.trim().toUpperCase();\r\n      const found = eleves.find(\r\n        (e) => e.ine && e.ine.trim().toUpperCase() === ineTrim\r\n      );\r\n      if (found) {\r\n        return NextResponse.json({ matchType: \"ine\", eleve: found });\r\n      }\r\n    }\r\n    if (!nom || !prénom || nom === \"non_trouvé\" || prénom === \"non_trouvé\") {\r\n      return NextResponse.json({ matchType: \"none\", eleve: null });\r\n    }\r\n    const scored = eleves.map((e) => ({\r\n      eleve: e,\r\n      score: nameSimilarity(nom, prénom, e.nom, e.prenom),\r\n    }));\r\n    const sorted = scored\r\n      .filter((s) => s.score > 0)\r\n      .sort((a, b) => b.score - a.score)\r\n      .slice(0, 5);\r\n    if (sorted.length === 0) { return NextResponse.json({ matchType: \"none\", eleve: null })}\r\n    const shortlist = sorted.map((s) => s.eleve);\r\n    if (!texteDocument) { return NextResponse.json({ matchType: \"best_score\", eleve: shortlist[0] })}\r\n    const shortlistDescription = shortlist\r\n      .map(\r\n        (e, idx) =>\r\n          `${idx + 1}. INE: ${e.ine}, Nom: ${e.nom}, Prénom: ${e.prenom}, Dossier: ${e.folderName}`\r\n      )\r\n      .join(\"\\n\");\r\n    const selectionPrompt = `\r\nTu es un système qui associe un document scolaire à l'élève correspondant.\r\nVoici le texte OCR brut du document :\r\n---\r\n${texteDocument}\r\n---\r\nVoici une liste de quelques élèves possibles (shortlist) :\r\n${shortlistDescription}\r\nRègles :\r\n- Analyse le texte du document.\r\n- Compare avec les informations de chaque élève (nom, prénom, INE si présent dans le texte).\r\n- Choisis l'index de l'élève qui correspond le mieux au document.\r\n- Si aucun élève ne correspond de manière raisonnable, répond \"0\".\r\nRéponds UNIQUEMENT avec un JSON valide de la forme :\r\n{\"index\": 0}\r\nou\r\n{\"index\": 1}\r\nou\r\n{\"index\": 2}\r\netc.\r\n`;\r\n    const selectionResponse = await fetch(\r\n      \"https://api.mistral.ai/v1/chat/completions\",\r\n      {\r\n        method: \"POST\",\r\n        headers: {\r\n          Authorization: `Bearer ${process.env.MISTRAL_API_KEY}`,\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({\r\n          model: \"mistral-medium\",\r\n          messages: [{ role: \"user\", content: selectionPrompt }],\r\n          temperature: 0,\r\n          response_format: { type: \"json_object\" },\r\n        }),\r\n      }\r\n    );\r\n    if (!selectionResponse.ok) {\r\n      const err = await selectionResponse.text();\r\n      return NextResponse.json(\r\n        { error: `Erreur Mistral selection élève: ${err}` },\r\n        { status: selectionResponse.status }\r\n      );\r\n    }\r\n    const selectionData = await selectionResponse.json();\r\n    let content = selectionData.choices?.[0]?.message?.content || \"\";\r\n    content = content.trim();\r\n    let selectedIndex = 0;\r\n    try {\r\n      const parsed = JSON.parse(content) as { index?: number };\r\n      selectedIndex = parsed.index ?? 0;\r\n    } catch {\r\n      selectedIndex = 0;\r\n    }\r\n    if (!selectedIndex || selectedIndex < 1 || selectedIndex > shortlist.length) {\r\n      return NextResponse.json({ matchType: \"shortlist_none\", eleve: null });\r\n    }\r\n    const selectedEleve = shortlist[selectedIndex - 1];\r\n    return NextResponse.json({\r\n      matchType: \"shortlist_mistral\",\r\n      eleve: selectedEleve,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Erreur POST /api/match-eleve:\", error);\r\n    return NextResponse.json({ error: String(error) }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}