{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 67, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/api/analyze-doc/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { getAuth, currentUser } from '@clerk/nextjs/server';\r\n\r\nconst USER_ONEDRIVE_BASES: Record<string, string> = {\"HACQUEVILLE-MATHI\": \"Dossier élèves/Lycée\",\"VILLIER\": \"Dossier élèves/Collège\",\"LEBLOND\": \"Dossier élèves/École\"};\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const { userId } = getAuth(req as any);\r\n    if (!userId) {\r\n      return NextResponse.json({ error: 'Non autorisé' }, { status: 401 });\r\n    }\r\n    const user = await currentUser();\r\n    const lastName = (user?.lastName || \"\").toUpperCase();\r\n    const { text } = await req.json();\r\n    if (!text) { return NextResponse.json({ error: 'text requis' }, { status: 400 })}\r\n    const extractionPrompt = `\r\nAnalyse ce document scolaire et extrais UNIQUEMENT les informations suivantes si elles sont clairement présentes dans le texte :\r\n- Type de document (bulletin, relevé de notes, certificat de scolarité, diplôme, bac, etc.)\r\n- Nom de famille de l'élève\r\n- Prénom de l'élève\r\n- INE de l'élève (identifiant national élève), si présent\r\n- Date de naissance de l'élève (si présente)\r\n- Classe ou niveau (si mentionné)\r\n- Période (trimestre 1/2/3, semestre 1/2, année scolaire, etc.)\r\nSi une information n'est PAS présente dans le document, écris exactement \"non_trouvé\" pour ce champ.\r\nNe devine JAMAIS, n'invente JAMAIS.\r\nIMPORTANT : Réponds UNIQUEMENT avec du JSON valide, sans aucun commentaire, remarque, note explicative, ou texte supplémentaire.\r\nPas de markdown, pas de \\`\\`\\`json, pas de notes entre parenthèses, pas de remarques après les valeurs.\r\nTexte du document :\r\n---\r\n${text}\r\n---\r\nFormat de réponse (JSON uniquement) :\r\n{\r\n  \"type\": \"...\",\r\n  \"nom\": \"...\",\r\n  \"prénom\": \"...\",\r\n  \"ine\": \"...\",\r\n  \"date_naissance\": \"...\",\r\n  \"classe\": \"...\",\r\n  \"période\": \"...\"\r\n}\r\n    `;\r\n    const extractionResponse = await fetch('https://api.mistral.ai/v1/chat/completions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${process.env.MISTRAL_API_KEY}`,\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify({\r\n        model: \"mistral-medium\",\r\n        messages: [{ role: \"user\", content: extractionPrompt }],\r\n        temperature: 0,\r\n        response_format: { type: \"json_object\" }\r\n      })\r\n    });\r\n    if (!extractionResponse.ok) {\r\n      const err = await extractionResponse.text();\r\n      return NextResponse.json({ error: `Erreur Mistral extraction: ${err}` }, { status: extractionResponse.status });\r\n    }\r\n    const extractionData = await extractionResponse.json();\r\n    let extractionResult = extractionData.choices?.[0]?.message?.content || '';\r\n    extractionResult = extractionResult.trim();\r\n    extractionResult = extractionResult.replace(/`{3}json/gi, '');\r\n    extractionResult = extractionResult.replace(/`{3}/g, '');\r\n    extractionResult = extractionResult.replace(/\\n/g, ' ');\r\n    extractionResult = extractionResult.trim();\r\n    extractionResult = extractionResult\r\n      .replace(/\\/\\*[\\s\\S]*?\\*\\//g, '')\r\n      .replace(/\\/\\/.*/g, '')\r\n      .replace(/,\\s*\\*\\(.*?\\)\\*/g, '');\r\n    const jsonStartIndex = extractionResult.indexOf('{');\r\n    const jsonEndIndex = extractionResult.lastIndexOf('}');\r\n    if (jsonStartIndex === -1 || jsonEndIndex === -1) {\r\n      return NextResponse.json(\r\n        {\r\n          error: \"Aucun JSON trouvé dans la réponse\",\r\n          brut: extractionResult\r\n        },\r\n        { status: 500 }\r\n      );\r\n    }\r\n    const cleanJson = extractionResult.substring(jsonStartIndex, jsonEndIndex + 1);\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    let extracted: any;\r\n    try {\r\n      extracted = JSON.parse(cleanJson);\r\n    } catch (parseError) {\r\n      const superCleanJson = cleanJson\r\n        .replace(/\\s+/g, ' ')\r\n        .replace(/,\\s*}/g, '}')\r\n        .replace(/,\\s*]/g, ']');\r\n      try {\r\n        extracted = JSON.parse(superCleanJson);\r\n      } catch {\r\n        return NextResponse.json(\r\n          {\r\n            error: \"JSON invalide après extraction\",\r\n            brut: extractionResult,\r\n            cleaned: cleanJson,\r\n            parseError: String(parseError)\r\n          },\r\n          { status: 500 }\r\n        );\r\n      }\r\n    }\r\n    let oneDriveFolderPath: string | null = null;\r\n    let matchedEleve: { ine: string; nom: string; prenom: string; folderName: string } | null = null;\r\n    try {\r\n      const matchRes = await fetch(`${process.env.NEXT_PUBLIC_APP_URL}api/match-eleve`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          clerkUserId: userId,\r\n          ine: extracted.ine,\r\n          nom: extracted.nom,\r\n          prénom: extracted.prénom,\r\n          texteDocument: text,\r\n        }),\r\n      });\r\n      if (matchRes.ok) {\r\n        const matchData = await matchRes.json();\r\n        matchedEleve = matchData.eleve || null;\r\n        if (matchedEleve?.folderName) {\r\n          const userBase =\r\n            (lastName && USER_ONEDRIVE_BASES[lastName]) || \"Dossier élèves/Lycée\";\r\n          oneDriveFolderPath = `${userBase}/${matchedEleve.folderName}`;\r\n        }\r\n      } else {\r\n        const errText = await matchRes.text();\r\n        console.error(\"Erreur /api/match-eleve:\", errText);\r\n      }\r\n    } catch (e) {\r\n      console.error(\"Erreur appel /api/match-eleve:\", e);\r\n    }\r\n    const namingPrompt = `\r\nTu es un système de nommage de fichiers pour une école.\r\n\r\nVoici les informations extraites d'un document :\r\n- Type : ${extracted.type || \"non_trouvé\"}\r\n- Nom : ${extracted.nom || \"non_trouvé\"}\r\n- Prénom : ${extracted.prénom || \"non_trouvé\"}\r\n- INE : ${extracted.ine || \"non_trouvé\"}\r\n- Date de naissance : ${extracted.date_naissance || \"non_trouvé\"}\r\n- Classe : ${extracted.classe || \"non_trouvé\"}\r\n- Période : ${extracted.période || \"non_trouvé\"}\r\nGénère un nom de fichier selon ces règles :\r\n1. Format général : Type Période Classe NOM Prénom\r\n2. Si une information vaut \"non_trouvé\", ne l'inclus PAS dans le nom\r\n3. Garde les accents et caractères spéciaux\r\n4. Exemples :\r\n   - Bulletin trimestre1 3eme DUPONT Jean\r\n   - Baccalauréat MARTIN Sophie\r\n   - Certificat de scolarité BERNARD Luc\r\n   - Relevé de notes du semestre2 2nde PETIT Marie\r\nRéponds UNIQUEMENT avec le nom de fichier (sans extension), rien d'autre. Pas de ponctuation finale.\r\n    `;\r\n    const namingResponse = await fetch('https://api.mistral.ai/v1/chat/completions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${process.env.MISTRAL_API_KEY}`,\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify({\r\n        model: \"mistral-medium\",\r\n        messages: [{ role: \"user\", content: namingPrompt }],\r\n        temperature: 0\r\n      })\r\n    });\r\n    if (!namingResponse.ok) {\r\n      const err = await namingResponse.text();\r\n      return NextResponse.json({ error: `Erreur Mistral naming: ${err}` }, { status: namingResponse.status });\r\n    }\r\n    const namingData = await namingResponse.json();\r\n    let fileName = namingData.choices?.[0]?.message?.content?.trim() || '';\r\n    fileName = fileName\r\n      .replace(/[<>:\"/\\\\|?*]/g, '_')\r\n      .replace(/_+/g, '_')\r\n      .replace(/^_|_$/g, '');\r\n    return NextResponse.json({\r\n      ...extracted,\r\n      eleve: {\r\n        nom: extracted.nom !== \"non_trouvé\" ? extracted.nom : null,\r\n        prénom: extracted.prénom !== \"non_trouvé\" ? extracted.prénom : null,\r\n        classe: extracted.classe !== \"non_trouvé\" ? extracted.classe : null,\r\n        ine: extracted.ine !== \"non_trouvé\" ? extracted.ine : null,\r\n        date_naissance: extracted.date_naissance !== \"non_trouvé\" ? extracted.date_naissance : null\r\n      },\r\n      fileName,\r\n      rawExtraction: extracted,\r\n      oneDriveFolderPath,\r\n      matchedEleve,\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur analyse Mistral:', error);\r\n    return NextResponse.json({ error: String(error) }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;AAAA;;;AAEA,MAAM,sBAA8C;IAAC,qBAAqB;IAAuB,WAAW;IAAyB,WAAW;AAAsB;AAE/J,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,8DAA8D;QAC9D,MAAM,EAAE,MAAM,EAAE,GAAG,IAAA,wLAAO,EAAC;QAC3B,IAAI,CAAC,QAAQ;YACX,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QACA,MAAM,OAAO,MAAM,IAAA,2MAAW;QAC9B,MAAM,WAAW,CAAC,MAAM,YAAY,EAAE,EAAE,WAAW;QACnD,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,IAAI,IAAI;QAC/B,IAAI,CAAC,MAAM;YAAE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAc,GAAG;gBAAE,QAAQ;YAAI;QAAE;QAChF,MAAM,mBAAmB,CAAC;;;;;;;;;;;;;;;AAe9B,EAAE,KAAK;;;;;;;;;;;;IAYH,CAAC;QACD,MAAM,qBAAqB,MAAM,MAAM,8CAA8C;YACnF,QAAQ;YACR,SAAS;gBACP,iBAAiB,CAAC,OAAO,EAAE,QAAQ,GAAG,CAAC,eAAe,EAAE;gBACxD,gBAAgB;YAClB;YACA,MAAM,KAAK,SAAS,CAAC;gBACnB,OAAO;gBACP,UAAU;oBAAC;wBAAE,MAAM;wBAAQ,SAAS;oBAAiB;iBAAE;gBACvD,aAAa;gBACb,iBAAiB;oBAAE,MAAM;gBAAc;YACzC;QACF;QACA,IAAI,CAAC,mBAAmB,EAAE,EAAE;YAC1B,MAAM,MAAM,MAAM,mBAAmB,IAAI;YACzC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,CAAC,2BAA2B,EAAE,KAAK;YAAC,GAAG;gBAAE,QAAQ,mBAAmB,MAAM;YAAC;QAC/G;QACA,MAAM,iBAAiB,MAAM,mBAAmB,IAAI;QACpD,IAAI,mBAAmB,eAAe,OAAO,EAAE,CAAC,EAAE,EAAE,SAAS,WAAW;QACxE,mBAAmB,iBAAiB,IAAI;QACxC,mBAAmB,iBAAiB,OAAO,CAAC,cAAc;QAC1D,mBAAmB,iBAAiB,OAAO,CAAC,SAAS;QACrD,mBAAmB,iBAAiB,OAAO,CAAC,OAAO;QACnD,mBAAmB,iBAAiB,IAAI;QACxC,mBAAmB,iBAChB,OAAO,CAAC,qBAAqB,IAC7B,OAAO,CAAC,WAAW,IACnB,OAAO,CAAC,oBAAoB;QAC/B,MAAM,iBAAiB,iBAAiB,OAAO,CAAC;QAChD,MAAM,eAAe,iBAAiB,WAAW,CAAC;QAClD,IAAI,mBAAmB,CAAC,KAAK,iBAAiB,CAAC,GAAG;YAChD,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,OAAO;gBACP,MAAM;YACR,GACA;gBAAE,QAAQ;YAAI;QAElB;QACA,MAAM,YAAY,iBAAiB,SAAS,CAAC,gBAAgB,eAAe;QAC5E,8DAA8D;QAC9D,IAAI;QACJ,IAAI;YACF,YAAY,KAAK,KAAK,CAAC;QACzB,EAAE,OAAO,YAAY;YACnB,MAAM,iBAAiB,UACpB,OAAO,CAAC,QAAQ,KAChB,OAAO,CAAC,UAAU,KAClB,OAAO,CAAC,UAAU;YACrB,IAAI;gBACF,YAAY,KAAK,KAAK,CAAC;YACzB,EAAE,OAAM;gBACN,OAAO,gJAAY,CAAC,IAAI,CACtB;oBACE,OAAO;oBACP,MAAM;oBACN,SAAS;oBACT,YAAY,OAAO;gBACrB,GACA;oBAAE,QAAQ;gBAAI;YAElB;QACF;QACA,IAAI,qBAAoC;QACxC,IAAI,eAAwF;QAC5F,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,8DAAmC,eAAe,CAAC,EAAE;gBAChF,QAAQ;gBACR,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;oBACnB,aAAa;oBACb,KAAK,UAAU,GAAG;oBAClB,KAAK,UAAU,GAAG;oBAClB,QAAQ,UAAU,MAAM;oBACxB,eAAe;gBACjB;YACF;YACA,IAAI,SAAS,EAAE,EAAE;gBACf,MAAM,YAAY,MAAM,SAAS,IAAI;gBACrC,eAAe,UAAU,KAAK,IAAI;gBAClC,IAAI,cAAc,YAAY;oBAC5B,MAAM,WACJ,AAAC,YAAY,mBAAmB,CAAC,SAAS,IAAK;oBACjD,qBAAqB,GAAG,SAAS,CAAC,EAAE,aAAa,UAAU,EAAE;gBAC/D;YACF,OAAO;gBACL,MAAM,UAAU,MAAM,SAAS,IAAI;gBACnC,QAAQ,KAAK,CAAC,4BAA4B;YAC5C;QACF,EAAE,OAAO,GAAG;YACV,QAAQ,KAAK,CAAC,kCAAkC;QAClD;QACA,MAAM,eAAe,CAAC;;;;SAIjB,EAAE,UAAU,IAAI,IAAI,aAAa;QAClC,EAAE,UAAU,GAAG,IAAI,aAAa;WAC7B,EAAE,UAAU,MAAM,IAAI,aAAa;QACtC,EAAE,UAAU,GAAG,IAAI,aAAa;sBAClB,EAAE,UAAU,cAAc,IAAI,aAAa;WACtD,EAAE,UAAU,MAAM,IAAI,aAAa;YAClC,EAAE,UAAU,OAAO,IAAI,aAAa;;;;;;;;;;;IAW5C,CAAC;QACD,MAAM,iBAAiB,MAAM,MAAM,8CAA8C;YAC/E,QAAQ;YACR,SAAS;gBACP,iBAAiB,CAAC,OAAO,EAAE,QAAQ,GAAG,CAAC,eAAe,EAAE;gBACxD,gBAAgB;YAClB;YACA,MAAM,KAAK,SAAS,CAAC;gBACnB,OAAO;gBACP,UAAU;oBAAC;wBAAE,MAAM;wBAAQ,SAAS;oBAAa;iBAAE;gBACnD,aAAa;YACf;QACF;QACA,IAAI,CAAC,eAAe,EAAE,EAAE;YACtB,MAAM,MAAM,MAAM,eAAe,IAAI;YACrC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,CAAC,uBAAuB,EAAE,KAAK;YAAC,GAAG;gBAAE,QAAQ,eAAe,MAAM;YAAC;QACvG;QACA,MAAM,aAAa,MAAM,eAAe,IAAI;QAC5C,IAAI,WAAW,WAAW,OAAO,EAAE,CAAC,EAAE,EAAE,SAAS,SAAS,UAAU;QACpE,WAAW,SACR,OAAO,CAAC,iBAAiB,KACzB,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,UAAU;QACrB,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,GAAG,SAAS;YACZ,OAAO;gBACL,KAAK,UAAU,GAAG,KAAK,eAAe,UAAU,GAAG,GAAG;gBACtD,QAAQ,UAAU,MAAM,KAAK,eAAe,UAAU,MAAM,GAAG;gBAC/D,QAAQ,UAAU,MAAM,KAAK,eAAe,UAAU,MAAM,GAAG;gBAC/D,KAAK,UAAU,GAAG,KAAK,eAAe,UAAU,GAAG,GAAG;gBACtD,gBAAgB,UAAU,cAAc,KAAK,eAAe,UAAU,cAAc,GAAG;YACzF;YACA;YACA,eAAe;YACf;YACA;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,OAAO;QAAO,GAAG;YAAE,QAAQ;QAAI;IACnE;AACF","debugId":null}}]
}