{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 67, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/utils/voyageStore.ts"],"sourcesContent":["import { S3Client, GetObjectCommand, PutObjectCommand } from \"@aws-sdk/client-s3\";\r\n\r\nexport const s3 = new S3Client({\r\n  region: \"eu-west-3\",\r\n  credentials: {\r\n    accessKeyId: process.env.AWS_ACCESS_KEY_ID!,\r\n    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!,\r\n  },\r\n});\r\nexport const BUCKET = process.env.AWS_S3_BUCKET_NAME!;\r\n\r\nconst KEY = \"voyages_en_attente.json\";\r\n\r\nexport type VoyagePieceJointe = {\r\n  filename: string;\r\n  buffer: string;  \r\n  type: string;\r\n};\r\n\r\nexport type DevisTransporteur = {\r\n  filename: string;\r\n  buffer: string;\r\n  type: string;\r\n  date: string;\r\n  transporteur?: string;\r\n  message?: string;\r\n};\r\n\r\n  export type VoyageEntry = {\r\n  id: string;\r\n  prenom: string;\r\n  nom: string;\r\n  email: string;\r\n  direction_cible: string;\r\n  date_depart: string;\r\n  date_retour: string;\r\n  lieu: string;\r\n  activite: string;\r\n  classes: string;\r\n  effectif_eleves: number;\r\n  effectif_accompagnateurs: number;\r\n  commentaire?: string;\r\n  devis?: DevisTransporteur[];\r\n  pieces_jointes?: VoyagePieceJointe[];\r\n  etat: \"en_attente\" | \"etape_2_en_attente\" | \"etape_3_en_attente\" | \"validation_finale_en_attente\" | \"validee_definitive\" | \"validee\" | \"refusee\";\r\n  date_declaration: string;\r\n  programme?: {\r\n    filename: string;\r\n    buffer: string;\r\n    type: string;\r\n    } | null;\r\n  etape_2?: {\r\n    panier_repas: boolean;\r\n    details_panier_repas?: string;\r\n    nb_repas?: number;\r\n    nb_vegetariens?: number;\r\n    lieu_repas?: string;\r\n    devis_transporteur: boolean;\r\n    details_devis_transporteur?: string;\r\n    commentaire?: string;\r\n    date?: string;\r\n  };\r\n  etape_3?: {\r\n    circulaire_depart?: VoyagePieceJointe[];        \r\n    date_reunion_info?: string;          \r\n    date_envoi_circulaire_parents?: string;\r\n    participation_famille?: number;\r\n    cout_total_voyage?: number;\r\n    liste_eleves?: VoyagePieceJointe[];\r\n    liste_accompagnateurs?: VoyagePieceJointe[];\r\n    autres_pieces?: VoyagePieceJointe[];\r\n    commentaire?: string;\r\n    date?: string;\r\n  };\r\n};\r\n\r\nexport async function readVoyages(): Promise<VoyageEntry[]> {\r\n  try {\r\n    const obj = await s3.send(new GetObjectCommand({ Bucket: BUCKET, Key: KEY }));\r\n    const body = await obj.Body?.transformToString();\r\n    return body ? JSON.parse(body) : [];\r\n     // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  } catch (e: any) {\r\n    if (e.$metadata?.httpStatusCode === 404) return [];\r\n    throw e;\r\n  }\r\n}\r\n\r\nexport async function writeVoyages(entries: VoyageEntry[]) {\r\n  await s3.send(\r\n    new PutObjectCommand({ Bucket: BUCKET, Key: KEY, Body: JSON.stringify(entries, null, 2), ContentType: \"application/json\"})\r\n  );\r\n}\r\n\r\nexport async function addVoyage(entry: VoyageEntry) {\r\n  const entries = await readVoyages();\r\n  entries.push(entry);\r\n  await writeVoyages(entries);\r\n}\r\n\r\nexport async function removeVoyage(id: string) {\r\n  const entries = await readVoyages();\r\n  const out = entries.filter(e => e.id !== id);\r\n  await writeVoyages(out);\r\n}"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;AAEO,MAAM,KAAK,IAAI,6JAAQ,CAAC;IAC7B,QAAQ;IACR,aAAa;QACX,aAAa,QAAQ,GAAG,CAAC,iBAAiB;QAC1C,iBAAiB,QAAQ,GAAG,CAAC,qBAAqB;IACpD;AACF;AACO,MAAM,SAAS,QAAQ,GAAG,CAAC,kBAAkB;AAEpD,MAAM,MAAM;AAiEL,eAAe;IACpB,IAAI;QACF,MAAM,MAAM,MAAM,GAAG,IAAI,CAAC,IAAI,qKAAgB,CAAC;YAAE,QAAQ;YAAQ,KAAK;QAAI;QAC1E,MAAM,OAAO,MAAM,IAAI,IAAI,EAAE;QAC7B,OAAO,OAAO,KAAK,KAAK,CAAC,QAAQ,EAAE;IAClC,8DAA8D;IACjE,EAAE,OAAO,GAAQ;QACf,IAAI,EAAE,SAAS,EAAE,mBAAmB,KAAK,OAAO,EAAE;QAClD,MAAM;IACR;AACF;AAEO,eAAe,aAAa,OAAsB;IACvD,MAAM,GAAG,IAAI,CACX,IAAI,qKAAgB,CAAC;QAAE,QAAQ;QAAQ,KAAK;QAAK,MAAM,KAAK,SAAS,CAAC,SAAS,MAAM;QAAI,aAAa;IAAkB;AAE5H;AAEO,eAAe,UAAU,KAAkB;IAChD,MAAM,UAAU,MAAM;IACtB,QAAQ,IAAI,CAAC;IACb,MAAM,aAAa;AACrB;AAEO,eAAe,aAAa,EAAU;IAC3C,MAAM,UAAU,MAAM;IACtB,MAAM,MAAM,QAAQ,MAAM,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;IACzC,MAAM,aAAa;AACrB","debugId":null}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/api/travels/create/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { v4 as uuidv4 } from \"uuid\";\r\nimport { addVoyage, VoyageEntry } from \"@/app/utils/voyageStore\";\r\n\r\nconst RECIPIENTS: Record<string, string[]> = {\r\n  direction_ecole: [\"flojfk+direction.ecole@gmail.com\"],\r\n  direction_college: [\"flojfk+direction.college@gmail.com\"],\r\n  direction_lycee: [\"flojfk+direction.lycee@gmail.com\"],\r\n  default: [\"secretariat@domaine.fr\"],\r\n};\r\n\r\nexport async function POST(req: NextRequest) {\r\n  const form = await req.formData();\r\n  const direction_cible = form.get(\"direction_cible\") as keyof typeof RECIPIENTS;\r\n  const files = form.getAll(\"pj\").filter(f => f instanceof File) as File[];\r\n  if (files.length > 5) return NextResponse.json({ error: \"Pas plus de 5 fichiers\" }, { status: 400 });\r\n  const pieces_jointes = [];\r\n  for (const file of files) {\r\n    const buf = await file.arrayBuffer();\r\n    pieces_jointes.push({\r\n      filename: file.name,\r\n      buffer: Buffer.from(buf).toString(\"base64\"),\r\n      type: file.type,\r\n    });\r\n  }\r\n  const programmeFile = (form.get(\"programme\") instanceof File) ? form.get(\"programme\") as File : null;\r\n  let programme = null;\r\n  if (programmeFile) {\r\n    const progBuf = await programmeFile.arrayBuffer();\r\n    programme = {\r\n      filename: programmeFile.name,\r\n      buffer: Buffer.from(progBuf).toString(\"base64\"),\r\n      type: programmeFile.type,\r\n    };\r\n  }\r\n  const voyage: VoyageEntry = {\r\n    id: uuidv4(),\r\n    prenom: form.get(\"prenom\") as string,\r\n    nom: form.get(\"nom\") as string,\r\n    email: form.get(\"email\") as string,\r\n    direction_cible: direction_cible,\r\n    date_depart: form.get(\"date_depart\") as string,\r\n    date_retour: form.get(\"date_retour\") as string,\r\n    lieu: form.get(\"lieu\") as string,\r\n    activite: form.get(\"activite\") as string,\r\n    classes: form.get(\"classes\") as string,\r\n    effectif_eleves: Number(form.get(\"effectif_eleves\") || 0),\r\n    effectif_accompagnateurs: Number(form.get(\"effectif_accompagnateurs\") || 0),\r\n    commentaire: form.get(\"commentaire\") as string,\r\n    pieces_jointes,\r\n    programme,\r\n    etat: \"en_attente\",\r\n    date_declaration: new Date().toISOString(),\r\n  };\r\n  await addVoyage(voyage);\r\n  const attachments = [\r\n    ...(programme ? [{ filename: programme.filename, content: Buffer.from(programme.buffer, \"base64\"), contentType: programme.type }] : []),\r\n    ...pieces_jointes.map(f => ({\r\n      filename: f.filename,\r\n      content: Buffer.from(f.buffer, \"base64\"),\r\n      contentType: f.type,\r\n    }))\r\n  ];\r\n  const to = RECIPIENTS[direction_cible] || RECIPIENTS.default;\r\n  const subject = `[Voyage scolaire] Nouvelle demande à valider - ${voyage.lieu}`;\r\n  const text =\r\n    `Nouvelle demande de voyage scolaire:\\n\\n` +\r\n    `Établissement : ${direction_cible}\\n` +\r\n    `Demandeur : ${voyage.prenom} ${voyage.nom} (${voyage.email})\\n` +\r\n    `Dates : du ${voyage.date_depart} au ${voyage.date_retour}\\n` +\r\n    `Lieu/activité : ${voyage.lieu} | ${voyage.activite}\\n` +\r\n    `Classes concernées : ${voyage.classes}\\n` +\r\n    `Élèves : ${voyage.effectif_eleves} | Accompagnateurs : ${voyage.effectif_accompagnateurs}\\n` +\r\n    (voyage.commentaire ? `Programme : ${voyage.commentaire}\\n` : \"\") +\r\n    `\\nLien de validation : ${process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\"}/travels/validate?id=${voyage.id}`;\r\n  await fetch(`${process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\"}/api/email`, {\r\n    method: \"POST\",\r\n    body: JSON.stringify({ to, subject, text, attachments }),\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n  });\r\n  return NextResponse.json({ success: true, message: \"Demande enregistrée et transmise à la direction.\" });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,aAAuC;IAC3C,iBAAiB;QAAC;KAAmC;IACrD,mBAAmB;QAAC;KAAqC;IACzD,iBAAiB;QAAC;KAAmC;IACrD,SAAS;QAAC;KAAyB;AACrC;AAEO,eAAe,KAAK,GAAgB;IACzC,MAAM,OAAO,MAAM,IAAI,QAAQ;IAC/B,MAAM,kBAAkB,KAAK,GAAG,CAAC;IACjC,MAAM,QAAQ,KAAK,MAAM,CAAC,MAAM,MAAM,CAAC,CAAA,IAAK,aAAa;IACzD,IAAI,MAAM,MAAM,GAAG,GAAG,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAyB,GAAG;QAAE,QAAQ;IAAI;IAClG,MAAM,iBAAiB,EAAE;IACzB,KAAK,MAAM,QAAQ,MAAO;QACxB,MAAM,MAAM,MAAM,KAAK,WAAW;QAClC,eAAe,IAAI,CAAC;YAClB,UAAU,KAAK,IAAI;YACnB,QAAQ,OAAO,IAAI,CAAC,KAAK,QAAQ,CAAC;YAClC,MAAM,KAAK,IAAI;QACjB;IACF;IACA,MAAM,gBAAgB,AAAC,KAAK,GAAG,CAAC,wBAAwB,OAAQ,KAAK,GAAG,CAAC,eAAuB;IAChG,IAAI,YAAY;IAChB,IAAI,eAAe;QACjB,MAAM,UAAU,MAAM,cAAc,WAAW;QAC/C,YAAY;YACV,UAAU,cAAc,IAAI;YAC5B,QAAQ,OAAO,IAAI,CAAC,SAAS,QAAQ,CAAC;YACtC,MAAM,cAAc,IAAI;QAC1B;IACF;IACA,MAAM,SAAsB;QAC1B,IAAI,IAAA,0LAAM;QACV,QAAQ,KAAK,GAAG,CAAC;QACjB,KAAK,KAAK,GAAG,CAAC;QACd,OAAO,KAAK,GAAG,CAAC;QAChB,iBAAiB;QACjB,aAAa,KAAK,GAAG,CAAC;QACtB,aAAa,KAAK,GAAG,CAAC;QACtB,MAAM,KAAK,GAAG,CAAC;QACf,UAAU,KAAK,GAAG,CAAC;QACnB,SAAS,KAAK,GAAG,CAAC;QAClB,iBAAiB,OAAO,KAAK,GAAG,CAAC,sBAAsB;QACvD,0BAA0B,OAAO,KAAK,GAAG,CAAC,+BAA+B;QACzE,aAAa,KAAK,GAAG,CAAC;QACtB;QACA;QACA,MAAM;QACN,kBAAkB,IAAI,OAAO,WAAW;IAC1C;IACA,MAAM,IAAA,0IAAS,EAAC;IAChB,MAAM,cAAc;WACd,YAAY;YAAC;gBAAE,UAAU,UAAU,QAAQ;gBAAE,SAAS,OAAO,IAAI,CAAC,UAAU,MAAM,EAAE;gBAAW,aAAa,UAAU,IAAI;YAAC;SAAE,GAAG,EAAE;WACnI,eAAe,GAAG,CAAC,CAAA,IAAK,CAAC;gBAC1B,UAAU,EAAE,QAAQ;gBACpB,SAAS,OAAO,IAAI,CAAC,EAAE,MAAM,EAAE;gBAC/B,aAAa,EAAE,IAAI;YACrB,CAAC;KACF;IACD,MAAM,KAAK,UAAU,CAAC,gBAAgB,IAAI,WAAW,OAAO;IAC5D,MAAM,UAAU,CAAC,+CAA+C,EAAE,OAAO,IAAI,EAAE;IAC/E,MAAM,OACJ,CAAC,wCAAwC,CAAC,GAC1C,CAAC,gBAAgB,EAAE,gBAAgB,EAAE,CAAC,GACtC,CAAC,YAAY,EAAE,OAAO,MAAM,CAAC,CAAC,EAAE,OAAO,GAAG,CAAC,EAAE,EAAE,OAAO,KAAK,CAAC,GAAG,CAAC,GAChE,CAAC,WAAW,EAAE,OAAO,WAAW,CAAC,IAAI,EAAE,OAAO,WAAW,CAAC,EAAE,CAAC,GAC7D,CAAC,gBAAgB,EAAE,OAAO,IAAI,CAAC,GAAG,EAAE,OAAO,QAAQ,CAAC,EAAE,CAAC,GACvD,CAAC,qBAAqB,EAAE,OAAO,OAAO,CAAC,EAAE,CAAC,GAC1C,CAAC,SAAS,EAAE,OAAO,eAAe,CAAC,qBAAqB,EAAE,OAAO,wBAAwB,CAAC,EAAE,CAAC,GAC7F,CAAC,OAAO,WAAW,GAAG,CAAC,YAAY,EAAE,OAAO,WAAW,CAAC,EAAE,CAAC,GAAG,EAAE,IAChE,CAAC,uBAAuB,EAAE,6DAAmC,wBAAwB,qBAAqB,EAAE,OAAO,EAAE,EAAE;IACzH,MAAM,MAAM,GAAG,6DAAmC,wBAAwB,UAAU,CAAC,EAAE;QACrF,QAAQ;QACR,MAAM,KAAK,SAAS,CAAC;YAAE;YAAI;YAAS;YAAM;QAAY;QACtD,SAAS;YAAE,gBAAgB;QAAmB;IAChD;IACA,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,SAAS;QAAM,SAAS;IAAmD;AACxG","debugId":null}}]
}