{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 109, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/utils/voyageStore.ts"],"sourcesContent":["// app/utils/voyageStore.ts\r\nimport { S3Client, GetObjectCommand, PutObjectCommand } from \"@aws-sdk/client-s3\";\r\nimport { getSignedUrl } from \"@aws-sdk/s3-request-presigner\";\r\n\r\nexport const s3 = new S3Client({\r\n  region: \"eu-west-3\",\r\n  credentials: {\r\n    accessKeyId: process.env.ACCESS_KEY_ID!,\r\n    secretAccessKey: process.env.SECRET_ACCESS_KEY!,\r\n  },\r\n});\r\nexport const BUCKET = process.env.BUCKET_NAME!;\r\nconst KEY = \"voyages.json\";\r\n\r\nexport type PieceJointe = {\r\n  filename: string;\r\n  s3Key: string;\r\n  type: string;\r\n};\r\n\r\nexport type VoyageEntry = {\r\n  id: string;\r\n  prenom: string;\r\n  nom: string;\r\n  email: string;\r\n  direction_cible: \"direction_ecole\" | \"direction_college\" | \"direction_lycee\";\r\n  type_activite: \"voyage\" | \"sortie\" | \"autre\";\r\n  destination: string;\r\n  objectifs: string;\r\n  date_depart: string;\r\n  date_retour: string;\r\n  effectif_eleves: number;\r\n  effectif_accompagnateurs: number;\r\n  pieces_jointes?: PieceJointe[];\r\n  etat: \"etape_1\" | \"etape_2\" | \"etape_3\" | \"refuse\" | \"valide\";\r\n  date_creation: string;\r\n  historique: { action: string; date: string; par: string }[];\r\n};\r\n\r\n// ðŸ“¦ Lecture S3\r\nexport async function readVoyages(): Promise<VoyageEntry[]> {\r\n  try {\r\n    const obj = await s3.send(new GetObjectCommand({ Bucket: BUCKET, Key: KEY }));\r\n    const body = await obj.Body?.transformToString();\r\n    return body ? JSON.parse(body) : [];\r\n  } catch (err: any) {\r\n    if (err.$metadata?.httpStatusCode === 404) return [];\r\n    throw err;\r\n  }\r\n}\r\n\r\n// ðŸ’¾ Ã‰criture S3\r\nexport async function writeVoyages(entries: VoyageEntry[]) {\r\n  await s3.send(new PutObjectCommand({\r\n    Bucket: BUCKET,\r\n    Key: KEY,\r\n    Body: JSON.stringify(entries, null, 2),\r\n    ContentType: \"application/json\",\r\n  }));\r\n}\r\n\r\n// âž• Ajouter un voyage\r\nexport async function addVoyage(entry: VoyageEntry) {\r\n  const voyages = await readVoyages();\r\n  voyages.push(entry);\r\n  await writeVoyages(voyages);\r\n}\r\n\r\n// âŒ Supprimer un voyage\r\nexport async function removeVoyage(id: string) {\r\n  const voyages = await readVoyages();\r\n  const filtered = voyages.filter(v => v.id !== id);\r\n  await writeVoyages(filtered);\r\n}\r\n\r\n// ðŸ”‘ URL prÃ©-signÃ©e upload\r\nexport async function getUploadURL(filename: string): Promise<{ url: string; key: string }> {\r\n  const key = `voyages_files/${Date.now()}_${filename}`;\r\n  const command = new PutObjectCommand({ Bucket: BUCKET, Key: key });\r\n  const url = await getSignedUrl(s3, command, { expiresIn: 3600 });\r\n  return { url, key };\r\n}\r\n\r\n// ðŸ”‘ URL prÃ©-signÃ©e download\r\nexport async function getDownloadURL(key: string): Promise<string> {\r\n  const command = new GetObjectCommand({ Bucket: BUCKET, Key: key });\r\n  return await getSignedUrl(s3, command, { expiresIn: 3600 });\r\n}\r\n"],"names":[],"mappings":"AAAA,2BAA2B;;;;;;;;;;;;;;;;;;;AAC3B;AACA;AAAA;;;AAEO,MAAM,KAAK,IAAI,6JAAQ,CAAC;IAC7B,QAAQ;IACR,aAAa;QACX,aAAa,QAAQ,GAAG,CAAC,aAAa;QACtC,iBAAiB,QAAQ,GAAG,CAAC,iBAAiB;IAChD;AACF;AACO,MAAM,SAAS,QAAQ,GAAG,CAAC,WAAW;AAC7C,MAAM,MAAM;AA4BL,eAAe;IACpB,IAAI;QACF,MAAM,MAAM,MAAM,GAAG,IAAI,CAAC,IAAI,qKAAgB,CAAC;YAAE,QAAQ;YAAQ,KAAK;QAAI;QAC1E,MAAM,OAAO,MAAM,IAAI,IAAI,EAAE;QAC7B,OAAO,OAAO,KAAK,KAAK,CAAC,QAAQ,EAAE;IACrC,EAAE,OAAO,KAAU;QACjB,IAAI,IAAI,SAAS,EAAE,mBAAmB,KAAK,OAAO,EAAE;QACpD,MAAM;IACR;AACF;AAGO,eAAe,aAAa,OAAsB;IACvD,MAAM,GAAG,IAAI,CAAC,IAAI,qKAAgB,CAAC;QACjC,QAAQ;QACR,KAAK;QACL,MAAM,KAAK,SAAS,CAAC,SAAS,MAAM;QACpC,aAAa;IACf;AACF;AAGO,eAAe,UAAU,KAAkB;IAChD,MAAM,UAAU,MAAM;IACtB,QAAQ,IAAI,CAAC;IACb,MAAM,aAAa;AACrB;AAGO,eAAe,aAAa,EAAU;IAC3C,MAAM,UAAU,MAAM;IACtB,MAAM,WAAW,QAAQ,MAAM,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;IAC9C,MAAM,aAAa;AACrB;AAGO,eAAe,aAAa,QAAgB;IACjD,MAAM,MAAM,CAAC,cAAc,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,UAAU;IACrD,MAAM,UAAU,IAAI,qKAAgB,CAAC;QAAE,QAAQ;QAAQ,KAAK;IAAI;IAChE,MAAM,MAAM,MAAM,IAAA,0MAAY,EAAC,IAAI,SAAS;QAAE,WAAW;IAAK;IAC9D,OAAO;QAAE;QAAK;IAAI;AACpB;AAGO,eAAe,eAAe,GAAW;IAC9C,MAAM,UAAU,IAAI,qKAAgB,CAAC;QAAE,QAAQ;QAAQ,KAAK;IAAI;IAChE,OAAO,MAAM,IAAA,0MAAY,EAAC,IAAI,SAAS;QAAE,WAAW;IAAK;AAC3D","debugId":null}},
    {"offset": {"line": 200, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/f.hacqueville/OneDrive%20-%20LYCEE%20LA%20PROVIDENCE%20NICOLAS%20BARRE/Code/docsLaPro/app/api/travels/download/route.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\r\nimport { readVoyages } from \"@/app/utils/voyageStore\";\r\n\r\nexport async function GET(req: NextRequest) {\r\n  const { searchParams } = req.nextUrl;\r\n  const id = searchParams.get(\"id\");\r\n  const idx = searchParams.get(\"idx\");\r\n  const prog = searchParams.get(\"prog\");\r\n  const devisIdx = searchParams.get(\"devis\");\r\n  const voyages = await readVoyages();\r\n  const voyage = voyages.find(v => v.id === id);\r\n  if (!voyage) return new Response(\"Non trouvÃ©\", { status: 404 });\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  let pj: any;\r\n  if (prog && voyage.programme) pj = voyage.programme;\r\n  else if (typeof idx === \"string\" && voyage.pieces_jointes && voyage.pieces_jointes[Number(idx)]) pj = voyage.pieces_jointes[Number(idx)];\r\n  else if (typeof devisIdx === \"string\" && voyage.devis && voyage.devis[Number(devisIdx)]) pj = voyage.devis[Number(devisIdx)];\r\n  if (!pj) return new Response(\"Non trouvÃ©\", { status: 404 });\r\n  return new Response(Buffer.from(pj.buffer, \"base64\"), {\r\n    headers: {\r\n      \"Content-Type\": pj.type,\r\n      \"Content-Disposition\": `inline; filename=\"${encodeURIComponent(pj.filename)}\"`,\r\n    },\r\n  });\r\n}"],"names":[],"mappings":";;;;AACA;;AAEO,eAAe,IAAI,GAAgB;IACxC,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,OAAO;IACpC,MAAM,KAAK,aAAa,GAAG,CAAC;IAC5B,MAAM,MAAM,aAAa,GAAG,CAAC;IAC7B,MAAM,OAAO,aAAa,GAAG,CAAC;IAC9B,MAAM,WAAW,aAAa,GAAG,CAAC;IAClC,MAAM,UAAU,MAAM,IAAA,4IAAW;IACjC,MAAM,SAAS,QAAQ,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;IAC1C,IAAI,CAAC,QAAQ,OAAO,IAAI,SAAS,cAAc;QAAE,QAAQ;IAAI;IAC7D,8DAA8D;IAC9D,IAAI;IACJ,IAAI,QAAQ,OAAO,SAAS,EAAE,KAAK,OAAO,SAAS;SAC9C,IAAI,OAAO,QAAQ,YAAY,OAAO,cAAc,IAAI,OAAO,cAAc,CAAC,OAAO,KAAK,EAAE,KAAK,OAAO,cAAc,CAAC,OAAO,KAAK;SACnI,IAAI,OAAO,aAAa,YAAY,OAAO,KAAK,IAAI,OAAO,KAAK,CAAC,OAAO,UAAU,EAAE,KAAK,OAAO,KAAK,CAAC,OAAO,UAAU;IAC5H,IAAI,CAAC,IAAI,OAAO,IAAI,SAAS,cAAc;QAAE,QAAQ;IAAI;IACzD,OAAO,IAAI,SAAS,OAAO,IAAI,CAAC,GAAG,MAAM,EAAE,WAAW;QACpD,SAAS;YACP,gBAAgB,GAAG,IAAI;YACvB,uBAAuB,CAAC,kBAAkB,EAAE,mBAAmB,GAAG,QAAQ,EAAE,CAAC,CAAC;QAChF;IACF;AACF","debugId":null}}]
}