module.exports = [
"[project]/.next-internal/server/app/api/travels/devis/request/route/actions.js [app-rsc] (server actions loader, ecmascript)", ((__turbopack_context__, module, exports) => {

}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/action-async-storage.external.js [external] (next/dist/server/app-render/action-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/action-async-storage.external.js", () => require("next/dist/server/app-render/action-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/crypto [external] (crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}),
"[externals]/events [external] (events, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/util [external] (util, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}),
"[externals]/fs [external] (fs, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/net [external] (net, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}),
"[externals]/dns [external] (dns, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("dns", () => require("dns"));

module.exports = mod;
}),
"[externals]/os [external] (os, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}),
"[externals]/path [external] (path, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}),
"[externals]/tls [external] (tls, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}),
"[externals]/child_process [external] (child_process, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("child_process", () => require("child_process"));

module.exports = mod;
}),
"[externals]/@aws-sdk/client-s3 [external] (@aws-sdk/client-s3, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("@aws-sdk/client-s3", () => require("@aws-sdk/client-s3"));

module.exports = mod;
}),
"[externals]/buffer [external] (buffer, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}),
"[externals]/node:stream [external] (node:stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:stream", () => require("node:stream"));

module.exports = mod;
}),
"[externals]/http2 [external] (http2, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http2", () => require("http2"));

module.exports = mod;
}),
"[externals]/node:crypto [external] (node:crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:crypto", () => require("node:crypto"));

module.exports = mod;
}),
"[externals]/node:async_hooks [external] (node:async_hooks, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:async_hooks", () => require("node:async_hooks"));

module.exports = mod;
}),
"[project]/app/utils/voyageStore.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

// app/utils/voyageStore.ts
__turbopack_context__.s([
    "BUCKET",
    ()=>BUCKET,
    "getPresignedUploadUrl",
    ()=>getPresignedUploadUrl,
    "getVoyage",
    ()=>getVoyage,
    "listVoyages",
    ()=>listVoyages,
    "s3",
    ()=>s3,
    "saveVoyage",
    ()=>saveVoyage
]);
var __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/@aws-sdk/client-s3 [external] (@aws-sdk/client-s3, cjs)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$aws$2d$sdk$2f$s3$2d$request$2d$presigner$2f$dist$2d$es$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@aws-sdk/s3-request-presigner/dist-es/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$aws$2d$sdk$2f$s3$2d$request$2d$presigner$2f$dist$2d$es$2f$getSignedUrl$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@aws-sdk/s3-request-presigner/dist-es/getSignedUrl.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$clerk$2f$nextjs$2f$dist$2f$esm$2f$app$2d$router$2f$server$2f$currentUser$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@clerk/nextjs/dist/esm/app-router/server/currentUser.js [app-route] (ecmascript)");
;
;
;
const s3 = new __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__["S3Client"]({
    region: "eu-west-3",
    credentials: {
        accessKeyId: process.env.ACCESS_KEY_ID,
        secretAccessKey: process.env.SECRET_ACCESS_KEY
    }
});
const BUCKET = process.env.BUCKET_NAME;
async function saveVoyage(userId, voyage) {
    const key = `travels/${userId}/${voyage.id}/voyage.json`;
    await s3.send(new __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__["PutObjectCommand"]({
        Bucket: BUCKET,
        Key: key,
        Body: JSON.stringify(voyage, null, 2),
        ContentType: "application/json"
    }));
    return key;
}
async function listVoyages(userId) {
    const res = await s3.send(new __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__["ListObjectsV2Command"]({
        Bucket: BUCKET,
        Prefix: `travels/${userId}/`
    }));
    return (res.Contents || []).filter((obj)=>obj.Key?.endsWith("voyage.json"));
}
async function getVoyage(userId, voyageId) {
    const key = `travels/${userId}/${voyageId}/voyage.json`;
    const obj = await s3.send(new __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__["GetObjectCommand"]({
        Bucket: BUCKET,
        Key: key
    }));
    const body = await obj.Body?.transformToString();
    return JSON.parse(body);
}
async function getPresignedUploadUrl(voyageId, filename, type) {
    const user = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$clerk$2f$nextjs$2f$dist$2f$esm$2f$app$2d$router$2f$server$2f$currentUser$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["currentUser"])();
    if (!user) throw new Error("Utilisateur non authentifié");
    const key = `travels/${user.id}/${voyageId}/${filename}`;
    const command = new __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__["PutObjectCommand"]({
        Bucket: BUCKET,
        Key: key,
        ContentType: type
    });
    const uploadUrl = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$aws$2d$sdk$2f$s3$2d$request$2d$presigner$2f$dist$2d$es$2f$getSignedUrl$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getSignedUrl"])(s3, command, {
        expiresIn: 3600
    });
    const fileUrl = `https://${BUCKET}.s3.eu-west-3.amazonaws.com/${key}`;
    return {
        uploadUrl,
        fileUrl,
        key
    };
}
}),
"[project]/app/api/travels/devis/request/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/crypto [external] (crypto, cjs)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$nodemailer$2f$lib$2f$nodemailer$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/nodemailer/lib/nodemailer.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/@aws-sdk/client-s3 [external] (@aws-sdk/client-s3, cjs)");
var __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$utils$2f$voyageStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/app/utils/voyageStore.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$clerk$2f$nextjs$2f$dist$2f$esm$2f$app$2d$router$2f$server$2f$currentUser$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@clerk/nextjs/dist/esm/app-router/server/currentUser.js [app-route] (ecmascript)");
;
;
;
;
;
;
const TRANSPORTEURS = [
    {
        id: "t1",
        nom: "Voyages Martin",
        email: "flojfk+transport1@gmail.com"
    },
    {
        id: "t2",
        nom: "Autocars Dupont",
        email: "flojfk+transport2@gmail.com"
    },
    {
        id: "t3",
        nom: "Keolis Nantes",
        email: "flojfk+transport3@gmail.com"
    }
];
const transporter = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$nodemailer$2f$lib$2f$nodemailer$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].createTransport({
    service: "gmail",
    auth: {
        user: process.env.SMTP_USER,
        pass: process.env.SMTP_PASS
    }
});
async function POST(req) {
    try {
        const user = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$clerk$2f$nextjs$2f$dist$2f$esm$2f$app$2d$router$2f$server$2f$currentUser$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["currentUser"])();
        if (!user) return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Non authentifié"
        }, {
            status: 401
        });
        const body = await req.json();
        const { voyageId, infos, heureDepart, carSurPlace, commentaire } = body;
        if (!voyageId) return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "voyageId manquant"
        }, {
            status: 400
        });
        const list = await __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$utils$2f$voyageStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["s3"].send(new __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__["ListObjectsV2Command"]({
            Bucket: __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$utils$2f$voyageStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["BUCKET"],
            Prefix: "travels/"
        }));
        let voyageKey = null;
        for (const obj of list.Contents || []){
            if (!obj.Key?.endsWith("voyage.json")) continue;
            const data = await __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$utils$2f$voyageStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["s3"].send(new __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__["GetObjectCommand"]({
                Bucket: __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$utils$2f$voyageStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["BUCKET"],
                Key: obj.Key
            }));
            const bodyStr = await data.Body?.transformToString();
            if (!bodyStr) continue;
            const voyage = JSON.parse(bodyStr);
            if (voyage.id === voyageId) {
                voyageKey = obj.Key;
                break;
            }
        }
        if (!voyageKey) return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Voyage introuvable"
        }, {
            status: 404
        });
        const obj = await __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$utils$2f$voyageStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["s3"].send(new __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__["GetObjectCommand"]({
            Bucket: __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$utils$2f$voyageStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["BUCKET"],
            Key: voyageKey
        }));
        const voyage = JSON.parse(await obj.Body?.transformToString() || "{}");
        voyage.prof_form = {
            heureDepart: heureDepart || "",
            carSurPlace: carSurPlace || false,
            commentaire: commentaire || "",
            date: new Date().toISOString()
        };
        // On prépare les requests pour chaque transporteur avec token
        const requests = TRANSPORTEURS.map((t)=>{
            const token = __TURBOPACK__imported__module__$5b$externals$5d2f$crypto__$5b$external$5d$__$28$crypto$2c$__cjs$29$__["default"].randomBytes(12).toString("hex");
            const fileKey = `${voyageKey.replace("voyage.json", "")}devis/${t.id}/devis.pdf`;
            const baseUrl = ("TURBOPACK compile-time value", "https://docslapro.com") || "http://localhost:3000";
            const frontUrl = `${baseUrl}/travels/depot-devis?voyageId=${voyageId}&transporteurId=${t.id}&token=${token}`;
            return {
                transporteur: t,
                token,
                fileKey,
                frontUrl
            };
        });
        voyage.devis_requests = requests.map((r)=>({
                id: r.transporteur.id,
                nom: r.transporteur.nom,
                email: r.transporteur.email,
                token: r.token,
                frontUrl: r.frontUrl,
                fileKey: r.fileKey,
                status: "pending",
                infos,
                date: new Date().toISOString()
            }));
        // On sauvegarde le JSON du voyage mis à jour
        await __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$utils$2f$voyageStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["s3"].send(new __TURBOPACK__imported__module__$5b$externals$5d2f40$aws$2d$sdk$2f$client$2d$s3__$5b$external$5d$__$2840$aws$2d$sdk$2f$client$2d$s3$2c$__cjs$29$__["PutObjectCommand"]({
            Bucket: __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$utils$2f$voyageStore$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["BUCKET"],
            Key: voyageKey,
            Body: JSON.stringify(voyage, null, 2),
            ContentType: "application/json"
        }));
        // Envoi du mail avec lien vers le front (pas presigned URL)
        for (const r of requests){
            await transporter.sendMail({
                from: `"École" <${process.env.SMTP_USER}>`,
                to: r.transporteur.email,
                subject: `[Demande de devis bus] Voyage scolaire "${voyage.lieu}"`,
                text: `Bonjour ${r.transporteur.nom},

L’établissement vous invite à déposer un devis pour le voyage "${voyage.lieu}" (${voyage.date_depart} → ${voyage.date_retour}).

Détails du voyage :
- Heure de départ : ${voyage.prof_form.heureDepart || "non précisée"}
- Car sur place : ${voyage.prof_form.carSurPlace ? "Oui" : "Non"}
- Commentaire prof : ${voyage.prof_form.commentaire || "(aucune précision)"}

Détails supplémentaires :
${infos || "(aucune précision fournie)"}

➡️ Cliquez sur le lien suivant pour déposer votre devis :
${r.frontUrl}

Merci de votre retour,
Cordialement,
L’équipe`
            });
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: true,
            message: "Mini-formulaire ajouté et demandes de devis envoyées aux transporteurs.",
            requests
        });
    } catch (err) {
        console.error("Erreur demande devis :", err);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: err.message || "Erreur interne"
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__b587a549._.js.map